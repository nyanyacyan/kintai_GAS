<script>

  // ------------------------------------------
  // é€ä¿¡å±¥æ­´ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆåˆå›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ï¼‰
  // æ—¥ä»˜ï¼‹é€ä¿¡å±¥æ­´ã‚’å–å¾—
  // ------------------------------------------
  function openHistoryModal() {
    document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
    document.getElementById('modalHistoryContent').innerHTML = '';
    document.getElementById('historyModal').style.display = 'flex';
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  // ------------------------------------------
  function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
  }


  // ------------------------------------------
  // ç”»é¢ã®ã€Œå±¥æ­´ã€æ¬„ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ï¼‰ã«è¡¨ã‚’æç”»
  // ------------------------------------------
  function displayHistory(records) {
    const container = document.getElementById('historyRecords');
    const editButton = document.getElementById('editButton');
    lastFetchedRecords = records;

    if (!records || records.length === 0) {
      container.innerHTML = '<em>å±¥æ­´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
      editButton.style.display = 'none';
      return;
    }

    let html = '<table style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    records.forEach(r => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td>${r.man}</td>
      <td>${r.overtime}</td>
    </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;

    editButton.style.display = 'inline-block'; // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  }



  // ------------------------------------------
  // ç”»é¢å†…ã®ã€Œå±¥æ­´ã€æ¬„ã«ã€æŒ‡å®šæ¡ä»¶ã§éå»ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  // ------------------------------------------
  function loadPreviousRecords() {
    const date = document.getElementById('historyDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;

    const container = document.getElementById('historyRecords');

    if (date && companyId && staffId && siteId) {
      // âœ… å³ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰
      container.innerHTML = '<em style="color: gray;">ğŸ“‚ é€ä¿¡å±¥æ­´ã‚’å–å¾—ä¸­ã§ã™...</em>';

      // éåŒæœŸå‘¼ã³å‡ºã—
      google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
    } else {
      container.innerHTML = '<em style="color: gray;">â€»é€ä¿¡å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯å±¥æ­´å¯¾è±¡æ—¥ä»˜ãƒ»å…ƒè«‹ãƒ»æ‹…å½“è€…ãƒ»ç¾å ´ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</em>';
    }
  }


  // ------------------------------------------
  // éå»ã®å±¥æ­´ã‚’æ¤œç´¢ã—ãŸçµæœã‚’è¡¨ç¤º
  // ã“ã“ã§ç·¨é›†ãƒœã‚¿ãƒ³ãŒå‡ºç¾â†’ç·¨é›†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸ç§»è¡Œ
  // ------------------------------------------
  function loadModalHistory() {
    const date = document.getElementById('modalHistoryDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;
    const container = document.getElementById('modalHistoryContent');

    if (!date || !companyId || !staffId || !siteId) {
      container.innerHTML = '<em style="color:red;">ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ãƒ»æ‹…å½“ãƒ»ç¾å ´ãƒ»æ—¥ä»˜ï¼‰</em>';
      return;
    }

    document.getElementById('loadingOverlay').style.display = 'flex'; // âœ… è¡¨ç¤ºON
    container.innerHTML = ''; // å†…å®¹åˆæœŸåŒ–

    google.script.run.withSuccessHandler(records => {
      console.log("ğŸ“¥ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸå€¤:", records);
      document.getElementById('loadingOverlay').style.display = 'none'; // âœ… è¡¨ç¤ºOFF
      lastFetchedRecords = records;
      if (records.length === 0) {
        container.innerHTML = '<em>å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse;">';
      html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
      records.forEach(r => {
        html += `<tr>
        <td>${r.type}</td>
        <td>${r.name}</td>
        <td>${r.man}</td>
        <td>${r.overtime}</td>
      </tr>`;
      });
      html += '</table>';
      html += `<button onclick="showEditFormInModal()">ç·¨é›†ã™ã‚‹</button>`;
      container.innerHTML = html;
    }).getPreviousRecords(date, companyId, staffId, siteId);
  }

  let lastFetchedRecords = [];


  // ------------------------------------------
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç§»è¡Œå…ˆã®ãƒ¢ãƒ¼ãƒ€ãƒ«
  // ã“ã“ã§å·¥æ•°ã®å¤‰æ›´ã‚’ä¿®æ­£ã§ãã‚‹
  // ã“ã“ã«ç”»åƒã‚’æ·»ä»˜ã§ãã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 
  /** ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼šç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆæ—¢å­˜ï¼‹è¿½åŠ ã®å…¥åŠ›UIï¼‰ */
  // ã“ã“ã§ç·¨é›†ãƒœã‚¿ãƒ³ãŒå‡ºç¾â†’ç·¨é›†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸ç§»è¡Œ
  // ------------------------------------------

  function showEditFormInModal() {
    const container = document.getElementById('modalHistoryContent');

    let html = '<h3>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h3>';

    html += '<table id="edit-table" style="width:100%; border-collapse: collapse;">';
    html += '<thead><tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>å½¹å‰²</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr></thead>';
    html += '<tbody id="edit-tbody">';

    lastFetchedRecords.forEach((r, i) => {
      const safe = sanitize(r.name);
      const roleName = `edit-partner-${safe}-role`;  // â˜…ç·¨é›†ç”¨ã®ãƒ©ã‚¸ã‚ªname
      const role = r.role || 'only';                 // â˜…æ—¢å­˜ãŒç„¡ã‘ã‚Œã° only

      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
  <td class="role-cell">${r.type === 'å”åŠ›ä¼šç¤¾' ? `
      <div class="partner-role-grid">
        <label class="role-card">
          <input type="radio" name="${roleName}" value="only"   ${role === 'only' ? 'checked' : ''}>
          <span>å”åŠ›ä¼šç¤¾ã®ã¿</span>
        </label>
        <label class="role-card">
          <input type="radio" name="${roleName}" value="leader" ${role === 'leader' ? 'checked' : ''}>
          <span>å”åŠ›ä¼šç¤¾ï¼‹è·é•·</span>
        </label>
        <label class="role-card">
          <input type="radio" name="${roleName}" value="other"  ${role === 'other' ? 'checked' : ''}>
          <span>å”åŠ›ä¼šç¤¾ï¼‹ãã®ä»–è³‡æ ¼</span>
        </label>
      </div>
    ` : 'â€”'
        }</td>

      <td><input type="number" step="0.25" class="work-input" placeholder="äººå·¥"   value="${r.man}"      id="edit-man-${i}" /></td>
      <td><input type="number" step="0.25" class="work-input" placeholder="æ®‹æ¥­" value="${r.overtime}" id="edit-overtime-${i}" /></td>
    </tr>`;
    });
    html += '</table>';
    html += `
    <div id="editUploader" class="upload-section" style="margin:12px 0;"></div>
    <button onclick="showEditConfirmationModal()">å†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰</button>
  `;
    container.innerHTML = html;
    renderAdditionalInputs();
    renderEditUploader();
  }


  // ------------------------------------------
  // ç·¨é›†ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚ã¨ã«ã€ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UIã‚’æç”»
  // ------------------------------------------
  function renderEditUploader() {
    const container = document.getElementById('editUploader');
    if (!container) return;

    container.innerHTML = `
      <label style="display:block;margin:8px 0;">ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
      <div id="uploaderEdit" class="uploader">
        <input type="file" accept="image/*" multiple hidden>
        <label class="file-button">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ <span class="file-count">0 æš</span></label>
        <div class="preview-grid"></div>
      </div>
    `;

    // æ—¢å­˜ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼åˆæœŸåŒ–ã‚’ä½¿ã†
    setupUploader('uploaderEdit', { max: 5, mode: 'carousel', queueKey: 'edit' });
  }

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼šå”åŠ›ä¼šç¤¾ã®ã€Œå½¹å‰²ã€ã‚’ç¸¦ä¸¦ã³ãƒ©ã‚¸ã‚ªã§ä½œã‚‹
function createEditPartnerRoleBlock(nameKey) {
  // ä¾‹: nameKey = "modal-partner-ABC"
  const wrap = document.createElement('div');
  wrap.className = 'partner-role-wrap';
  wrap.id = `role-${nameKey}`;
  wrap.style.display = 'none'; // ãƒã‚§ãƒƒã‚¯ONã§ã ã‘è¡¨ç¤º

  const radioName = `${nameKey}-role`; // â† submitå´ã®å‚ç…§ã¨ä¸€è‡´ã•ã›ã‚‹

  wrap.innerHTML = `
    <div class="partner-role-grid partner-role-grid--col">
      <label class="role-card">
        <input type="radio" name="${radioName}" value="only">
        <span>å”åŠ›ä¼šç¤¾ã®ã¿</span>
      </label>
      <label class="role-card">
        <input type="radio" name="${radioName}" value="leader">
        <span>å”åŠ›ä¼šç¤¾ï¼‹è·é•·</span>
      </label>
      <label class="role-card">
        <input type="radio" name="${radioName}" value="other">
        <span>å”åŠ›ä¼šç¤¾ï¼‹ãã®ä»–è³‡æ ¼</span>
      </label>
    </div>
  `;
  return wrap;
}


  // ------------------------------------------
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨ã®ã€Œæ–°è¦è¿½åŠ ã€ç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼†å…¥åŠ›æ¬„ã‚’æç”»
  // æ—¢ã«è¡¨ã«è¼‰ã£ã¦ã„ã‚‹äººã¯å€™è£œã‹ã‚‰é™¤å¤–
  // ------------------------------------------
  function renderAdditionalInputs() {
    const workerContainer = document.getElementById('additionalWorkerInputs');
    const partnerContainer = document.getElementById('additionalPartnerInputs');
    workerContainer.innerHTML = '';
    partnerContainer.innerHTML = '';

    const staffId = document.getElementById('staff').value;
    if (!staffId) return;

    const registered = new Set(lastFetchedRecords.map(r => `${r.type}:${r.name}`));

    // ğŸ”½ ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è€…ï¼å”åŠ›ä¼šç¤¾ã®åå‰ã‚‚é™¤å¤–å¯¾è±¡ã«è¿½åŠ 
    document.querySelectorAll('#edit-table tbody tr').forEach(row => {
      const type = row.querySelector('td:nth-child(1)').textContent.trim();
      const name = row.querySelector('td:nth-child(2)').textContent.trim();
      registered.add(`${type}:${name}`);
    });

    const createCheckboxBlock = (type, name, container) => {
      const safeName = sanitize(name);
      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = `additional-${type}`;
      checkbox.value = name;
      checkbox.onchange = () => toggleTimeInputs(checkbox, `modal-${type}-${safeName}`);

      const span = document.createElement('span');
      span.textContent = name;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      container.appendChild(wrapper);

      if (type === 'partner') {
        // â˜…å½¹å‰²ï¼ˆæœ€åˆã¯éè¡¨ç¤ºã€ãƒã‚§ãƒƒã‚¯ONã§å‡ºã‚‹ï¼‰
        partnerContainer.appendChild(createEditPartnerRoleBlock(`modal-partner-${safeName}`));
      }

      const inputs = createTimeInputs(`modal-${type}-${safeName}`);
      container.appendChild(inputs);
    };

    // âœ… ä½œæ¥­è€…ã®è¦‹å‡ºã—
    // const workerHeader = document.createElement('h4');
    // workerHeader.textContent = 'ä½œæ¥­è€…';
    // workerContainer.appendChild(workerHeader);

    masterData.worker
      .filter(w => w.staffIds.includes(staffId))
      .filter(w => !registered.has(`ä½œæ¥­è€…:${w.name}`)) // âœ… é‡è¤‡å›é¿
      .forEach(w => createCheckboxBlock('worker', w.name, workerContainer));

    // âœ… å”åŠ›ä¼šç¤¾ã®è¦‹å‡ºã—
    // const partnerHeader = document.createElement('h4');
    // partnerHeader.textContent = 'å”åŠ›ä¼šç¤¾';
    // partnerContainer.appendChild(partnerHeader);

    masterData.partner
      .filter(p => p.staffIds.includes(staffId))
      .filter(p => !registered.has(`å”åŠ›ä¼šç¤¾:${p.name}`)) // âœ… é‡è¤‡å›é¿
      .forEach(p => createCheckboxBlock('partner', p.name, partnerContainer));
  }


  // ------------------------------------------
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œå†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ï¼š
  // å…¥åŠ›æ¤œè¨¼â†’formDataçµ„ã¿ç«‹ã¦â†’ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
  // ------------------------------------------
function showEditConfirmationModal() {
  isEditMode = true;
  // æ—¢å­˜ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã¯ãã®ã¾ã¾â€¦

  const roleLabelMap = {
    only: 'å”åŠ›ä¼šç¤¾ã®ã¿',
    leader: 'å”åŠ›ä¼šç¤¾ï¼‹è·é•·',
    other: 'å”åŠ›ä¼šç¤¾ï¼‹ãã®ä»–è³‡æ ¼'
  };

  const editedRecords = [];

  lastFetchedRecords.forEach((r, i) => {
    const manInput = document.getElementById(`edit-man-${i}`);
    const overtimeInput = document.getElementById(`edit-overtime-${i}`);
    if (!manInput || !overtimeInput) return;

    const man = parseFloat(manInput.value || 0);
    const overtime = parseFloat(overtimeInput.value || 0);

    // â˜… å½¹å‰²ã®å–å¾—ï¼ˆå”åŠ›ä¼šç¤¾ã®ã¿ï¼‰
    let role = r.role || 'only';
    if (r.type === 'å”åŠ›ä¼šç¤¾') {
      const safe = sanitize(r.name);
      const sel = document.querySelector(`input[name="edit-partner-${safe}-role"]:checked`);
      role = sel ? sel.value : role; // only | leader | other
    }

    // è¡¨ç¤ºåã‚’ç½®ãæ›ãˆã‚‹å ´åˆã¯ã“ã“ã§
    const displayName = (r.type === 'å”åŠ›ä¼šç¤¾' && role) ? roleLabelMap[role] : r.name;

    editedRecords.push({
      ...r,
      name: displayName,
      role,
      man,
      overtime
    });
  });

  // è¿½åŠ ã®å”åŠ›ä¼šç¤¾ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨ã®æ–°è¦è¿½åŠ ï¼‰ã«ã‚‚å½¹å‰²ãŒã‚ã‚‹å ´åˆã¯åŒæ§˜ã«æ‹¾ã†
  document.querySelectorAll('.additional-partner:checked').forEach(cb => {
    const name = cb.value;
    const safe = sanitize(name);
    const manInput = document.querySelector(`input[data-name="modal-partner-${safe}"][data-type="man"]`);
    const overtimeInput = document.querySelector(`input[data-name="modal-partner-${safe}"][data-type="overtime"]`);
    const roleEl = document.querySelector(`input[name="role-modal-partner-${safe}"]:checked`); // createPartnerRoleBlock ã® name ã¨ä¸€è‡´ã•ã›ã‚‹
    const role = roleEl ? roleEl.value : 'only';

    const man = parseFloat(manInput?.value || 0);
    const overtime = parseFloat(overtimeInput?.value || 0);
    const displayName = roleLabelMap[role];

    editedRecords.push({
      type: 'å”åŠ›ä¼šç¤¾',
      name: displayName,
      role,
      man,
      overtime
    });
  });

  // workers ã‚‚å¾“æ¥é€šã‚Š push æ¸ˆã¿ãªã‚‰ OKã€‚æœ€å¾Œã« formData ã‚’ä½œæˆ
  formData = {
    date: document.getElementById('modalHistoryDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    site: document.getElementById('site').value,
    workers: editedRecords.filter(r => r.type === 'ä½œæ¥­è€…').map(({ name, man, overtime }) => ({ name, man, overtime })),
    partners: editedRecords.filter(r => r.type === 'å”åŠ›ä¼šç¤¾').map(({ name, man, overtime }) => ({ name, man, overtime }))
  };

  showConfirmation(true);
}




</script>
