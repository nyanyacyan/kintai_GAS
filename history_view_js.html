<script>
  const ROLE = window.ROLE || { GENERAL: 'general', LEADER: 'leader', QUALIFIED: 'qualified' };
  window.ROLE = ROLE;
  window.lastFetchedRecords = window.lastFetchedRecords || [];

  // ------------------------------------------
  // 送信履歴のモーダルを開く（初回モーダル表示時）
  // 日付＋送信履歴を取得
  // ------------------------------------------

  function openHistoryModal() {
    console.log('[openHistoryModal] 開始'); // 処理開始ログ
    document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
    document.getElementById('modalHistoryContent').innerHTML = '';
    document.getElementById('historyModal').style.display = 'flex';
    console.log('[openHistoryModal] 終了', { modalDate: document.getElementById('modalHistoryDate')?.value }); // 処理終了ログ
  }



  // ------------------------------------------
  // closeHistoryModal: 履歴モーダルを閉じる
  // ------------------------------------------
  function closeHistoryModal() {
    console.log('[closeHistoryModal] 開始'); // 処理開始ログ
    document.getElementById('historyModal').style.display = 'none';
    console.log('[closeHistoryModal] 終了'); // 処理終了ログ
  }



  // ------------------------------------------
  // displayHistory: 取得した履歴を画面の一覧に描画する
  // ------------------------------------------
  function displayHistory(records) {
    console.log('[displayHistory] 開始', { recordCount: records?.length || 0 }); // 処理開始ログ
    const container = document.getElementById('historyRecords');
    const editButton = document.getElementById('editButton');
    window.lastFetchedRecords = records;

    if (!records || records.length === 0) {
      container.innerHTML = '<em>履歴は見つかりませんでした。</em>';
      editButton.style.display = 'none';
      console.log('[displayHistory] 終了 (該当データなし)'); // 処理終了ログ
      return;
    }

    let html = '<table style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>種別</th><th>名前</th><th>人工</th><th>残業</th></tr>';
    records.forEach(r => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td>${r.man}</td>
      <td>${r.overtime}</td>
    </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;

    editButton.style.display = 'inline-block'; // 編集ボタンを表示
    console.log('[displayHistory] 終了', { 表示件数: records.length }); // 処理終了ログ
  }




  // ------------------------------------------
  // loadPreviousRecords: 条件に合う履歴を一覧領域へ再描画する
  // ------------------------------------------
  function loadPreviousRecords() {
    console.log('[loadPreviousRecords] 開始', {
      date: document.getElementById('historyDate')?.value,
      companyId: document.getElementById('company')?.value,
      staffId: document.getElementById('staff')?.value,
      siteId: document.getElementById('site')?.value
    }); // 処理開始ログ
    const date = document.getElementById('historyDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;

    const container = document.getElementById('historyRecords');

    if (date && companyId && staffId && siteId) {
      // ✅ 即フィードバック表示（読み込み中）
      container.innerHTML = '<em style="color: gray;">📂 送信履歴を取得中です...</em>';

      // 非同期呼び出し
      google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
    } else {
      container.innerHTML = '<em style="color: gray;">※送信履歴を表示するには履歴対象日付・元請・担当者・現場をすべて選択してください。</em>';
    }
    console.log('[loadPreviousRecords] 終了'); // 処理終了ログ
  }



  // ------------------------------------------
  // loadModalHistory: モーダル内に条件一致の履歴と編集ボタンを描画する
  // ------------------------------------------
  function loadModalHistory() {
    console.log('[loadModalHistory] 開始', {
      date: document.getElementById('modalHistoryDate')?.value,
      companyId: document.getElementById('company')?.value,
      staffId: document.getElementById('staff')?.value,
      siteId: document.getElementById('site')?.value
    }); // 処理開始ログ
    const date = document.getElementById('modalHistoryDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;
    const container = document.getElementById('modalHistoryContent');

    if (!date || !companyId || !staffId || !siteId) {
      container.innerHTML = '<em style="color:red;">すべての項目を選択してください（元請・担当・現場・日付）</em>';
      return;
    }

    document.getElementById('loadingOverlay').style.display = 'flex'; // ✅ 表示ON
    container.innerHTML = ''; // 内容初期化

    google.script.run.withSuccessHandler(records => {
      console.log("📥 サーバーから返ってきた値:", records);
      document.getElementById('loadingOverlay').style.display = 'none'; // ✅ 表示OFF
      window.lastFetchedRecords = records;
      if (records.length === 0) {
        container.innerHTML = '<em>履歴が見つかりませんでした。</em>';
        console.log('[loadModalHistory] 終了 (該当データなし)'); // 処理終了ログ
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse;">';
      html += '<tr><th>種別</th><th>名前</th><th>人工</th><th>残業</th></tr>';
      records.forEach(r => {
        html += `<tr>
        <td>${r.type}</td>
        <td>${r.name}</td>
        <td>${r.man}</td>
        <td>${r.overtime}</td>
      </tr>`;
      });
      html += '</table>';
      html += `<button onclick="showEditFormInModal()">編集する</button>`;
      container.innerHTML = html;
      console.log('[loadModalHistory] 終了', { 表示件数: records.length }); // 処理終了ログ
    }).getPreviousRecords(date, companyId, staffId, siteId);
  }



  // ------------------------------------------
  // showEditFormInModal: モーダルを編集フォーム構成へ切り替える
  // ------------------------------------------

  function showEditFormInModal() {
    console.log('[showEditFormInModal] 開始', { 既存件数: (window.lastFetchedRecords || []).length }); // 処理開始ログ
    const container = document.getElementById('modalHistoryContent');

    let html = '<h3>編集フォーム</h3>';

    // 役割列を削除 → <th> からも外す
    html += '<table id="edit-table" style="width:100%; border-collapse: collapse;">';
    html += '<thead><tr><th>種別</th><th>名前</th><th>人工</th><th>残業</th></tr></thead>';
    html += '<tbody id="edit-tbody">';

    (window.lastFetchedRecords || []).forEach((r, i) => {
      const safe = sanitize(r.name);

      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>

      <!-- 役割は削除して、人工と残業だけ -->
      <td><input type="number" step="0.25" class="work-input" placeholder="人工" value="${r.man}" id="edit-man-${i}" /></td>
      <td><input type="number" step="0.25" class="work-input" placeholder="残業" value="${r.overtime}" id="edit-overtime-${i}" /></td>
    </tr>`;
    });

    html += '</tbody></table>';
    html += `
    <div id="editUploader" class="upload-section" style="margin:12px 0;"></div>

    <h4 style="margin-top:16px;">追加入力（作業者）</h4>
    <div id="additionalWorkerInputs"></div>

    <h4 style="margin-top:16px;">追加入力（協力会社）</h4>
    <div id="additionalPartnerInputs"></div>

    <div style="margin-top:16px;">
      <button onclick="showEditConfirmationModal()">再送信（更新）</button>
    </div>
  `;

    container.innerHTML = html;
    renderEditUploader();
    renderAdditionalInputs();
    console.log('[showEditFormInModal] 終了'); // 処理終了ログ
  }


  // ------------------------------------------
  // 編集ボタンが押されたあとに、画像アップロードUIを描画
  // ------------------------------------------



  // ------------------------------------------
  // renderEditUploader: 編集用のアップロードUIを描画する
  // ------------------------------------------
  function renderEditUploader() {
    console.log('[renderEditUploader] 開始'); // 処理開始ログ
    const container = document.getElementById('editUploader');
    if (!container) return;

    container.innerHTML = `
      <div id="uploaderEdit" class="uploader">
        <input type="file" accept="image/*" multiple hidden>
        <label class="file-button">ファイル選択 <span class="file-count">0 枚</span></label>
        <div class="preview-grid"></div>
      </div>
    `;

    // 既存のアップローダー初期化を使う
    setupUploader('uploaderEdit', { max: 5, mode: 'carousel', queueKey: 'edit' });
    console.log('[renderEditUploader] 終了'); // 処理終了ログ
  }

  // 編集モーダル用：協力会社の「役割」を縦並びラジオで作る



  // ------------------------------------------
  // createEditPartnerRoleBlock: 編集モーダル用の役割選択UIを作成する
  // ------------------------------------------
  function createEditPartnerRoleBlock(nameKey) {
    // 例: nameKey = "modal-partner-ABC"
    const wrap = document.createElement('div');
    wrap.className = 'partner-role-wrap';
    wrap.id = `role-${nameKey}`;
    wrap.style.display = 'none'; // チェックONでだけ表示

    const radioName = `${nameKey}-role`; // ← submit側の参照と一致させる

    wrap.innerHTML = `
    <div class="partner-role-grid partner-role-grid--col">
      <label class="role-card">
        <input type="radio" name="${radioName}" value="only">
        <span>一般作業員</span>
      </label>
      <label class="role-card">
        <input type="radio" name="${radioName}" value="leader">
        <span>職長</span>
      </label>
      <label class="role-card">
        <input type="radio" name="${radioName}" value="other">
        <span>有資格者</span>
      </label>
    </div>
  `;
    return wrap;
  }



  // ------------------------------------------
  // renderAdditionalInputs: 追加入力用の作業者・協力会社リストを描画する
  // ------------------------------------------
  function renderAdditionalInputs() {
    console.group('🧩 追加入力の描画');

    const workerContainer = document.getElementById('additionalWorkerInputs');
    const partnerContainer = document.getElementById('additionalPartnerInputs');
    workerContainer.innerHTML = '';
    partnerContainer.innerHTML = '';

    const staffId = document.getElementById('staff').value;
    console.log('選択中のスタッフID:', staffId); // 📝 LOG
    if (!staffId) {
      console.warn('⚠ スタッフIDが未選択のため、追加候補は表示しません。'); // 📝 LOG
      console.groupEnd();
      return;
    }

    const registered = new Set((window.lastFetchedRecords || []).map(r => `${r.type}:${r.name}`));
    console.log('当日入力済み（初期）の除外キー数:', registered.size); // 📝 LOG

    // 🔽 編集テーブルに表示されている作業者／協力会社の名前も除外対象に追加
    document.querySelectorAll('#edit-table tbody tr').forEach(row => {
      const type = row.querySelector('td:nth-child(1)').textContent.trim();
      const name = row.querySelector('td:nth-child(2)').textContent.trim();
      registered.add(`${type}:${name}`);
    });
    console.log('編集テーブル反映後の除外キー総数:', registered.size); // 📝 LOG

    // 追加UI：協力会社のときだけ役割ラジオも入れる
    const createCheckboxBlock = (type, name, container) => {
      const safeName = sanitize(name);
      const key = `modal-${type}-${safeName}`;

      // 📝 LOG: 実際に描画する候補
      console.log(`候補を描画: 種別=${type === 'partner' ? '協力会社' : '作業者'} / 名称=${name} / key=${key}`);

      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = `additional-${type}`;
      checkbox.value = name;
      checkbox.dataset.key = key;

      // 作業者は従来の時間UI、協力会社はマトリクスUIをON/OFF
      checkbox.onchange = () => {
        if (type === 'partner') {
          togglePartnerMatrix(checkbox, key);  // ← 新ハンドラ
        } else {
          toggleTimeInputs(checkbox, key);     // ← 既存（作業者）
        }
      };

      const span = document.createElement('span');
      span.textContent = name;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      container.appendChild(wrapper);

      if (type === 'partner') {
        // ★ 新：3役割×(人工/残業) のマトリクス（最初は非表示）
        const matrix = createPartnerRoleMatrix(key);
        matrix.style.display = 'none';
        container.appendChild(matrix);
      } else {
        // 作業者は従来どおり人工/残業を1セット
        const inputs = createTimeInputs(key);
        container.appendChild(inputs);
      }
    };

    // ✅ 作業者
    const workersForStaff = masterData.worker
      .filter(w => w.staffIds.includes(staffId));
    console.log('作業者マスタ（スタッフIDで絞り込み後）件数:', workersForStaff.length); // 📝 LOG

    const workerRemain = workersForStaff
      .filter(w => !registered.has(`作業者:${w.name}`)); // ✅ 重複回避
    console.log('作業者：重複除外後に表示する件数:', workerRemain.length); // 📝 LOG
    workerRemain.forEach(w => createCheckboxBlock('worker', w.name, workerContainer));

    // ✅ 協力会社
    const partnersForStaff = masterData.partner
      .filter(p => p.staffIds.includes(staffId));
    console.log('協力会社マスタ（スタッフIDで絞り込み後）件数:', partnersForStaff.length);

    // 会社ごとの使用済み役割マップを構築
    const usedRoleMap = buildUsedPartnerRoleMap();

    // 会社ごとの“まだ使える役割”が1つもなければ出さない
    const partnerRemain = partnersForStaff.filter(p => {
      const used = usedRoleMap.get(p.name) || new Set();
      return !(used.has(ROLE.GENERAL) && used.has(ROLE.LEADER) && used.has(ROLE.QUALIFIED));
    });
    console.log('協力会社：重複（役割込み）除外後に表示する件数:', partnerRemain.length);

    // 描画
    partnerRemain.forEach(p => {
      const safeName = sanitize(p.name);
      const key = `modal-partner-${safeName}`;
      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'additional-partner';
      checkbox.value = p.name;
      checkbox.dataset.key = key;
      checkbox.onchange = () => togglePartnerMatrix(checkbox, key);

      const span = document.createElement('span');
      span.textContent = p.name;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      partnerContainer.appendChild(wrapper);

      // 会社ごとの使用済み役割セットをマトリクスに渡す
      const usedRoles = usedRoleMap.get(p.name) || new Set();
      const matrix = createPartnerRoleMatrix(key, usedRoles);
      matrix.style.display = 'none';
      partnerContainer.appendChild(matrix);
    });
    console.groupEnd();
  }  // ←←← ここで renderAdditionalInputs を閉じる

  // ------------------------------------------
  // モーダル内編集フォームの「再送信（更新）」ボタン押下時：
  // 入力検証→formData組み立て→確認モーダルへ
  // ------------------------------------------
  let pendingEditPayload = null;
  let formData = window.formData || {};  // 念のためグローバルに



  // ------------------------------------------
  // showEditConfirmationModal: 編集内容を確認モーダルに組み立てる
  // ------------------------------------------
  function showEditConfirmationModal() {
    isEditMode = true;
    console.log('[showEditConfirmationModal] 開始'); // 処理開始ログ

    // 既存のバリデーション・エラークリア処理はこの前にある前提


    // --- 1) 既存レコード（テーブル行）の収集 ---
    const records = [];

    // 既存行
    (window.lastFetchedRecords || []).forEach((r, i) => {
      const man = parseFloat(document.getElementById(`edit-man-${i}`)?.value || 0);
      const ot = parseFloat(document.getElementById(`edit-overtime-${i}`)?.value || 0);

      let role = undefined; // 作業者は role 不要
      if (r.type === '協力会社') {
        const safe = sanitize(r.name);
        const sel = document.querySelector(`input[name="edit-partner-${safe}-role"]:checked`);
        role = sel ? sel.value : 'only'; // only | leader | other
      }

      records.push({ type: r.type, name: r.name, role, man, overtime: ot });
    });

    // 追加の協力会社（マトリクス構造対応）
    document.querySelectorAll('.additional-partner:checked').forEach(cb => {
      const name = cb.value;
      const safe = sanitize(name);
      const key = `modal-partner-${safe}`;

      // 役割ごとに check されている行だけ records に追加
      const roles = [
        { key: 'general', value: 'only' }, // 一般作業員
        { key: 'leader', value: 'leader' }, // 職長
        { key: 'qualified', value: 'other' }  // 有資格者
      ];

      roles.forEach(({ key: rkey, value: rvalue }) => {
        const chk = document.querySelector(`input[name="${key}-${rkey}-checked"]`);
        if (!chk || !chk.checked) return;

        const man = parseFloat(document.querySelector(`input[name="${key}-${rkey}-man"]`)?.value || 0);
        const ot = parseFloat(document.querySelector(`input[name="${key}-${rkey}-overtime"]`)?.value || 0);

        records.push({
          type: '協力会社',
          name,
          role: rvalue,         // 'only' | 'leader' | 'other'
          man,
          overtime: ot
        });
      });
    });

    const meta = {
      date: document.getElementById('modalHistoryDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      siteId: document.getElementById('site').value,
    };

    // ★ここで退避（submitEditFromModal はこれをそのまま送る）
    pendingEditPayload = { meta, records };   // ← 保存用はコレを使う

    // ---- ここから「表示用」formData を作る ----
    const roleSuffixMap = {
      only: '',            // 協力会社のみ → 会社名だけ
      leader: ' 職長',      // フル幅の＋（半角+でもOK）
      other: ' 有資格者'
    };

    const workersDisp = records
      .filter(r => r.type === '作業者')
      .map(({ name, man, overtime }) => ({ name, man, overtime }));

    const partnersDisp = records
      .filter(r => r.type === '協力会社')
      .map(({ name, role, man, overtime }) => {
        const suffix = roleSuffixMap[role] ?? '';
        return { name: name + suffix, man, overtime };   // ← 会社名の後ろにだけ役割を付ける
      });

    // showConfirmation が参照する形に揃える
    formData = {
      companyId: meta.companyId,
      staffId: meta.staffId,
      site: meta.siteId,
      date: meta.date,
      workers: workersDisp,
      partners: partnersDisp
    };
    console.log('[showEditConfirmationModal] formData for modal =',
      JSON.parse(JSON.stringify(formData)));

    console.log('[showEditConfirmationModal] 最終組み立て', { meta, records件数: records.length });
    showConfirmation(true);
    console.log('[showEditConfirmationModal] 終了'); // 処理終了ログ
  }


  // ------------------------------------------
  // getPartnerCompanyMasterData: 協力会社マスターデータを取得する
  // ------------------------------------------
  function getPartnerCompanyMasterData() {
    // マスターデータがあるか確認
    if (!window.masterData || !Array.isArray(masterData.partner)) {
      console.warn('masterData.partner が未初期化です');
      return [];
    }
    const sample = masterData.partner.slice(0, 3); // 先頭3件だけ
    console.info('masterData.partner 件数:', masterData.partner.length);
    console.log('masterData.partner 先頭3件サンプル:', sample);
    console.table(sample); // 表形式でも確認
    return masterData.partner;
  }

  // -------------------------------------------------------------------------------

  // 役割の定数
  // 例: "BULLPOWERS 職長" → { base:"BULLPOWERS", role:"leader" }
  //     "BULLPOWERS"     → { base:"BULLPOWERS", role:"general" }



  // ------------------------------------------
  // parsePartnerDisplay: 協力会社の表示名から基底名と役割を抽出する
  // ------------------------------------------
  function parsePartnerDisplay(displayName) {
    const s = (displayName || '').trim();
    // 末尾の [任意個の空白(半角/全角)] + (職長|有資格者) を吸収
    // \u3000 は全角スペース
    const m = s.match(/[\s\u3000]*(職長|有資格者)\s*$/);
    if (m) {
      const base = s.slice(0, s.length - m[0].length).trim();
      const role = m[1] === '職長' ? ROLE.LEADER : ROLE.QUALIFIED;
      return { base, role };
    }
    return { base: s, role: ROLE.GENERAL };
  }

  // Map<会社名, Set<role>>



  // ------------------------------------------
  // buildUsedPartnerRoleMap: 使用済み役割を会社単位で集計する
  // ------------------------------------------
  function buildUsedPartnerRoleMap() {
    const used = new Map();

    // ① サーバから取ってある当日レコード
    (window.lastFetchedRecords || []).forEach(r => {
      if (r.type !== '協力会社') return;
      // r.name は「BULLPOWERS」「BULLPOWERS 職長」…のどれか
      const { base, role } = parsePartnerDisplay(r.name);
      if (!used.has(base)) used.set(base, new Set());
      used.get(base).add(role || ROLE.GENERAL);
    });

    // ② 画面の編集テーブル行（まだ送信していないが編集中のものも除外）
    document.querySelectorAll('#edit-table tbody tr').forEach(row => {
      const type = row.querySelector('td:nth-child(1)')?.textContent.trim();
      if (type !== '協力会社') return;
      const dispName = row.querySelector('td:nth-child(2)')?.textContent.trim() || '';
      const { base, role } = parsePartnerDisplay(dispName);
      if (!used.has(base)) used.set(base, new Set());
      used.get(base).add(role || ROLE.GENERAL);
    });
    console.log('[usedRoleMap]', Array.from(used.entries()).map(
      ([name, set]) => [name, Array.from(set)]
    ));
    return used;
  }




  // ------------------------------------------
  // createPartnerRoleMatrix: 協力会社向け役割入力マトリクスを生成する
  // ------------------------------------------
  function createPartnerRoleMatrix(nameKey, usedRoles = new Set()) {
    const wrap = document.createElement('div');
    wrap.className = 'partner-role-matrix';
    wrap.id = `matrix-${nameKey}`;
    wrap.style.display = 'none';

    wrap.innerHTML = `
    <div class="role-row" data-role="general">
      <label><input type="checkbox" name="${nameKey}-general-checked"> 一般作業員</label>
      <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-general-man">
      <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-general-overtime">
    </div>
    <div class="role-row" data-role="leader">
      <label><input type="checkbox" name="${nameKey}-leader-checked"> 職長</label>
      <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-leader-man">
      <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-leader-overtime">
    </div>
    <div class="role-row" data-role="qualified">
      <label><input type="checkbox" name="${nameKey}-qualified-checked"> 有資格者</label>
      <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-qualified-man">
      <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-qualified-overtime">
    </div>
  `;

    // 使用済みの役割は行ごと除去（= 入力UIを生成しない）
    ['general', 'leader', 'qualified'].forEach(role => {
      if (usedRoles.has(role)) {
        const row = wrap.querySelector(`.role-row[data-role="${role}"]`);
        if (row) row.remove();
      }
    });

    return wrap;
  }

  window.openHistoryModal = openHistoryModal;
  window.closeHistoryModal = closeHistoryModal;
  window.loadPreviousRecords = loadPreviousRecords;
  window.loadModalHistory = loadModalHistory;
  window.showEditFormInModal = showEditFormInModal;
  window.renderAdditionalInputs = renderAdditionalInputs;
  window.showEditConfirmationModal = showEditConfirmationModal;
  window.submitEditFromModal = submitEditFromModal;

</script>
