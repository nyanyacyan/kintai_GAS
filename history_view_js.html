<script>

  /* ------------------------------------------
   * å±¥æ­´è¡¨ç¤ºï¼†ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã¾ã‚ã‚Š
   *
   * ä¾å­˜ï¼š
   *  - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° : masterData, lastFetchedRecords, formData, isEditMode
   *    ï¼ˆinit_js ã§ let å®£è¨€ã—ã¦ãŠãï¼‰
   *  - ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ : sanitize(), isValidQuarterHour()
   *    ï¼ˆcheck_js / utils ã«å®šç¾©ï¼‰
   *  - ãƒ•ã‚©ãƒ¼ãƒ ç³»é–¢æ•° : createTimeInputs(), toggleTimeInputs(), updateWorkerAndPartner()
   *    ï¼ˆform_js ã«å®šç¾©ï¼‰
   *  - é€ä¿¡ç³»é–¢æ•° : showConfirmation(), closeConfirmation()
   *    ï¼ˆsend_js ã«å®šç¾©ï¼‰
   * å‚ç…§ã™ã‚‹HTMLè¦ç´ IDï¼š
   *  - #historyModal, #modalHistoryDate, #modalHistoryContent, #loadingOverlay
   *  - #historyRecords, #editButton
   * ------------------------------------------*/

  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’ä»Šæ—¥ã«ã€å†…å®¹ã¯ç©ºã«ï¼‰
  // ------------------------------------------
  function openHistoryModal() {
    document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
    document.getElementById('modalHistoryContent').innerHTML = '';
    document.getElementById('historyModal').style.display = 'flex';
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  // ------------------------------------------
  function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
  }


  // ------------------------------------------
  // ç”»é¢ã®ã€Œå±¥æ­´ã€æ¬„ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ï¼‰ã«è¡¨ã‚’æç”»
  // ------------------------------------------
  function displayHistory(records) {
    const container = document.getElementById('historyRecords');
    const editButton = document.getElementById('editButton');
    lastFetchedRecords = records;

    if (!records || records.length === 0) {
      container.innerHTML = '<em>å±¥æ­´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
      editButton.style.display = 'none';
      return;
    }

    let html = '<table style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    records.forEach(r => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td>${r.man}</td>
      <td>${r.overtime}</td>
    </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;

    editButton.style.display = 'inline-block'; // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  }



  // ------------------------------------------
  // ç”»é¢å†…ã®ã€Œå±¥æ­´ã€æ¬„ã«ã€æŒ‡å®šæ¡ä»¶ã§éå»ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  // ------------------------------------------
  function loadPreviousRecords() {
    const date = document.getElementById('historyDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;

    const container = document.getElementById('historyRecords');

    if (date && companyId && staffId && siteId) {
      // âœ… å³ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰
      container.innerHTML = '<em style="color: gray;">ğŸ“‚ é€ä¿¡å±¥æ­´ã‚’å–å¾—ä¸­ã§ã™...</em>';

      // éåŒæœŸå‘¼ã³å‡ºã—
      google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
    } else {
      container.innerHTML = '<em style="color: gray;">â€»é€ä¿¡å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯å±¥æ­´å¯¾è±¡æ—¥ä»˜ãƒ»å…ƒè«‹ãƒ»æ‹…å½“è€…ãƒ»ç¾å ´ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</em>';
    }
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«å´ã§éå»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨è¡¨ç¤º
  // ------------------------------------------
  function loadModalHistory() {
    const date = document.getElementById('modalHistoryDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;
    const container = document.getElementById('modalHistoryContent');

    if (!date || !companyId || !staffId || !siteId) {
      container.innerHTML = '<em style="color:red;">ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ãƒ»æ‹…å½“ãƒ»ç¾å ´ãƒ»æ—¥ä»˜ï¼‰</em>';
      return;
    }

    document.getElementById('loadingOverlay').style.display = 'flex'; // âœ… è¡¨ç¤ºON
    container.innerHTML = ''; // å†…å®¹åˆæœŸåŒ–

    google.script.run.withSuccessHandler(records => {
      document.getElementById('loadingOverlay').style.display = 'none'; // âœ… è¡¨ç¤ºOFF
      lastFetchedRecords = records;
      if (records.length === 0) {
        container.innerHTML = '<em>å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse;">';
      html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
      records.forEach(r => {
        html += `<tr>
        <td>${r.type}</td>
        <td>${r.name}</td>
        <td>${r.man}</td>
        <td>${r.overtime}</td>
      </tr>`;
      });
      html += '</table>';
      html += `<button onclick="showEditFormInModal()">ç·¨é›†ã™ã‚‹</button>`;
      container.innerHTML = html;
    }).getPreviousRecords(date, companyId, staffId, siteId);
  }

  let lastFetchedRecords = [];



  /** ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ï¼šç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆæ—¢å­˜ï¼‹è¿½åŠ ã®å…¥åŠ›UIï¼‰ */
  function showEditFormInModal() {
    const container = document.getElementById('modalHistoryContent');

    let html = '<h3>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h3>';
    html += '<table style="width:100%; border-collapse: collapse;">';
    // html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>æ—¥å‹¤</th><th>å¤•å‹¤</th><th>å¤œå‹¤</th><th>æ®‹æ¥­</th></tr>';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    lastFetchedRecords.forEach((r, i) => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td><input type="number" step="0.25" class="work-input" placeholder="äººå·¥" value="${r.man}" id="edit-man-${i}" /></td>
      <td><input type="number" step="0.25" class="work-input" placeholder="æ®‹æ¥­" value="${r.overtime}" id="edit-overtime-${i}" /></td>

    </tr>`;
    });
    html += '</table>';
    html += `<button onclick="showEditConfirmationModal()">å†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰</button>`;
    container.innerHTML = html;
    renderAdditionalInputs(); // âœ… å±¥æ­´å¤–ã®è¿½åŠ å€™è£œã‚’è¡¨ç¤º
  }


  // ------------------------------------------
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨ã®ã€Œæ–°è¦è¿½åŠ ã€ç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼†å…¥åŠ›æ¬„ã‚’æç”»
  // æ—¢ã«è¡¨ã«è¼‰ã£ã¦ã„ã‚‹äººã¯å€™è£œã‹ã‚‰é™¤å¤–
  // ------------------------------------------
  function renderAdditionalInputs() {
    const workerContainer = document.getElementById('additionalWorkerInputs');
    const partnerContainer = document.getElementById('additionalPartnerInputs');
    workerContainer.innerHTML = '';
    partnerContainer.innerHTML = '';

    const staffId = document.getElementById('staff').value;
    if (!staffId) return;

    const registered = new Set(lastFetchedRecords.map(r => `${r.type}:${r.name}`));

    // ğŸ”½ ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è€…ï¼å”åŠ›ä¼šç¤¾ã®åå‰ã‚‚é™¤å¤–å¯¾è±¡ã«è¿½åŠ 
    document.querySelectorAll('#edit-table tbody tr').forEach(row => {
      const type = row.querySelector('td:nth-child(1)').textContent.trim();
      const name = row.querySelector('td:nth-child(2)').textContent.trim();
      registered.add(`${type}:${name}`);
    });

    const createCheckboxBlock = (type, name, container) => {
      const safeName = sanitize(name);
      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = `additional-${type}`;
      checkbox.value = name;
      checkbox.onchange = () => toggleTimeInputs(checkbox, `modal-${type}-${safeName}`);

      const span = document.createElement('span');
      span.textContent = name;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      container.appendChild(wrapper);

      const inputs = createTimeInputs(`modal-${type}-${safeName}`);
      container.appendChild(inputs);
    };

    // âœ… ä½œæ¥­è€…ã®è¦‹å‡ºã—
    // const workerHeader = document.createElement('h4');
    // workerHeader.textContent = 'ä½œæ¥­è€…';
    // workerContainer.appendChild(workerHeader);

    masterData.worker
      .filter(w => w.staffIds.includes(staffId))
      .filter(w => !registered.has(`ä½œæ¥­è€…:${w.name}`)) // âœ… é‡è¤‡å›é¿
      .forEach(w => createCheckboxBlock('worker', w.name, workerContainer));

    // âœ… å”åŠ›ä¼šç¤¾ã®è¦‹å‡ºã—
    // const partnerHeader = document.createElement('h4');
    // partnerHeader.textContent = 'å”åŠ›ä¼šç¤¾';
    // partnerContainer.appendChild(partnerHeader);

    masterData.partner
      .filter(p => p.staffIds.includes(staffId))
      .filter(p => !registered.has(`å”åŠ›ä¼šç¤¾:${p.name}`)) // âœ… é‡è¤‡å›é¿
      .forEach(p => createCheckboxBlock('partner', p.name, partnerContainer));
  }


  // ------------------------------------------
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œå†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ï¼š
  // å…¥åŠ›æ¤œè¨¼â†’formDataçµ„ã¿ç«‹ã¦â†’ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
  // ------------------------------------------
  function showEditConfirmationModal() {
    isEditMode = true;
    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    document.querySelectorAll('.edit-error-message').forEach(el => el.remove());

    let hasError = false;
    const editedRecords = []; // æ›´æ–°å¾Œã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—

    // --- 1. æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† ---
    lastFetchedRecords.forEach((r, i) => {
      const manInput = document.getElementById(`edit-man-${i}`);
      const overtimeInput = document.getElementById(`edit-overtime-${i}`);

      if (!manInput || !overtimeInput) return; // å¿µã®ãŸã‚è¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯

      const man = parseFloat(manInput.value || 0);
      const overtime = parseFloat(overtimeInput.value || 0);
      let isRowInvalid = false;

      // 0.25å˜ä½ãƒã‚§ãƒƒã‚¯
      [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
          input.classList.add('input-error');
          const errMsg = document.createElement('div');
          errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          errMsg.className = 'edit-error-message';
          errMsg.style.color = 'red';
          input.parentElement.appendChild(errMsg);
          hasError = true;
          isRowInvalid = true;
        }
      });

      if (!isRowInvalid) {
        editedRecords.push({ ...r, man, overtime });
      }
    });

    // --- 2. è¿½åŠ ä½œæ¥­è€…ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† ---
    document.querySelectorAll('.additional-worker:checked').forEach(cb => {
      const name = cb.value;
      const safeName = sanitize(name);
      // dataset ã‚’ä½¿ã£ã¦æ­£ã—ãè¦ç´ ã‚’å–å¾—
      const manInput = document.querySelector(`input[data-name="modal-worker-${safeName}"][data-type="man"]`);
      const overtimeInput = document.querySelector(`input[data-name="modal-worker-${safeName}"][data-type="overtime"]`);

      if (!manInput || !overtimeInput) return;

      const man = parseFloat(manInput.value || 0);
      const overtime = parseFloat(overtimeInput.value || 0);
      let isRowInvalid = false;

      // åˆè¨ˆ0ãƒã‚§ãƒƒã‚¯
      if ((man + overtime) <= 0) {
        [manInput, overtimeInput].forEach(input => input.classList.add('input-error'));
        const errMsg = document.createElement('div');
        errMsg.className = 'edit-error-message';
        errMsg.textContent = 'â€»å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        errMsg.style.color = 'red';
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
        manInput.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
        hasError = true;
        isRowInvalid = true;
      }

      // 0.25å˜ä½ãƒã‚§ãƒƒã‚¯
      [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
          input.classList.add('input-error');
          // æ—¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã‘ã‚Œã°è¿½åŠ 
          if (!manInput.closest('.checkbox-wrapper').querySelector('.edit-error-message')) {
            const errMsg = document.createElement('div');
            errMsg.className = 'edit-error-message';
            errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            errMsg.style.color = 'red';
            input.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
          }
          hasError = true;
          isRowInvalid = true;
        }
      });

      if (!isRowInvalid) {
        editedRecords.push({ type: 'ä½œæ¥­è€…', name, man, overtime });
      }
    });

    // --- 3. è¿½åŠ å”åŠ›ä¼šç¤¾ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† (ä½œæ¥­è€…ã¨ã»ã¼åŒã˜) ---
    document.querySelectorAll('.additional-partner:checked').forEach(cb => {
      const name = cb.value;
      const safeName = sanitize(name);
      const manInput = document.querySelector(`input[data-name="modal-partner-${safeName}"][data-type="man"]`);
      const overtimeInput = document.querySelector(`input[data-name="modal-partner-${safeName}"][data-type="overtime"]`);

      if (!manInput || !overtimeInput) return;

      const man = parseFloat(manInput.value || 0);
      const overtime = parseFloat(overtimeInput.value || 0);
      let isRowInvalid = false;

      if ((man + overtime) <= 0) {
        [manInput, overtimeInput].forEach(input => input.classList.add('input-error'));
        const errMsg = document.createElement('div');
        errMsg.className = 'edit-error-message';
        errMsg.textContent = 'â€»å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        errMsg.style.color = 'red';
        manInput.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
        hasError = true;
        isRowInvalid = true;
      }

      [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
          input.classList.add('input-error');
          if (!manInput.closest('.checkbox-wrapper').querySelector('.edit-error-message')) {
            const errMsg = document.createElement('div');
            errMsg.className = 'edit-error-message';
            errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            errMsg.style.color = 'red';
            input.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
          }
          hasError = true;
          isRowInvalid = true;
        }
      });

      if (!isRowInvalid) {
        editedRecords.push({ type: 'å”åŠ›ä¼šç¤¾', name, man, overtime });
      }
    });

    // --- 4. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã«å¿œã˜ã¦å‡¦ç† ---
    if (hasError) {
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¾ã¾å‡¦ç†ã‚’ä¸­æ–­
      return;
    }

    // --- 5. ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã®ã¿ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ç¢ºèªç”»é¢ã¸ ---
    document.getElementById('historyModal').style.display = 'none';

    // é€ä¿¡ç”¨ã®formDataã‚’æ§‹ç¯‰
    formData = {
      date: document.getElementById('modalHistoryDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      site: document.getElementById('site').value,
      workers: editedRecords.filter(r => r.type === 'ä½œæ¥­è€…').map(({ name, man, overtime }) => ({ name, man, overtime })),
      partners: editedRecords.filter(r => r.type === 'å”åŠ›ä¼šç¤¾').map(({ name, man, overtime }) => ({ name, man, overtime }))
    };

    // ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
    showConfirmation(true);
  }




</script>
