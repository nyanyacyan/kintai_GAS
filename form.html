<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

    <!-- CSS èª­ã¿è¾¼ã¿ -->
  <?!= include('style'); ?>
  <?!= include('main_js'); ?>

  <!-- <script>
    let masterData = {};
    let formData = {};
    let isSubmitted = false;


    function isValidQuarterHour(value) {
      return Number.isFinite(value) && Math.round(value * 100) % 25 === 0;
    }


    function toggleDateInput(el) {
      const button = document.getElementById('dateToggleButton');
      const checked = el.checked;
      document.getElementById('dateContainer').style.display = checked ? 'block' : 'none';
      button.classList.toggle('checked', checked);
    }


function closeConfirmation() {
  const confirmationText = document.getElementById('confirmationText').textContent;
  const isSent = confirmationText.includes('âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
  document.getElementById('confirmationModal').style.display = 'none';

  if (isSent) {
    // é€ä¿¡å®Œäº†å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å ´åˆ
    if (!isEditMode) {
      // æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã ã£ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetForm();
    }
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€å®Œäº†å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹ã ã‘ãªã®ã§ä½•ã‚‚ã—ãªã„
  } else {
    // ã€Œä¿®æ­£ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æˆ»ã‚‹å ´åˆ
    if (isEditMode) {
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆå…¥åŠ›å€¤ãŒä¿æŒã•ã‚Œã¾ã™ï¼‰
      document.getElementById('historyModal').style.display = 'flex';
    }
    // æ–°è¦å…¥åŠ›ã®å ´åˆã¯å…ƒã€…å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ãˆã¦ã„ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„
  }
}

function handleModalClickOutside(event) {
  const confirmationBox = document.getElementById('confirmationBox');

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†
  if (!confirmationBox.contains(event.target)) {
    const confirmationText = document.getElementById('confirmationText').textContent;
    const isSent = confirmationText.includes('âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    document.getElementById('confirmationModal').style.display = 'none';

    if (isSent) {
      if (!isEditMode) {
        resetForm();
      }
    } else if (isEditMode) {
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã€Œä¿®æ­£ã™ã‚‹ã€ãŸã‚ã«æˆ»ã‚‹å ´åˆ
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã™ã‚‹ã ã‘ã«ã™ã‚‹
      document.getElementById('historyModal').style.display = 'flex';
    }
  }
}
    function resetForm() {
      document.getElementById('company').selectedIndex = 0;
      document.getElementById('staff').innerHTML = '';
      document.getElementById('site').innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
      document.getElementById('worker').innerHTML = '';
      document.getElementById('partner').innerHTML = '';
      document.getElementById('customDateToggle').checked = false;
      document.getElementById('customDate').value = '';
      toggleDateInput(document.getElementById('customDateToggle'));
      formData = {};
      isSubmitted = false;
      const companySelect = document.getElementById('company');
      companySelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
      masterData.company.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        companySelect.appendChild(opt);
      });
      // âœ… å±¥æ­´ãƒœã‚¿ãƒ³ã®å†æ¥ç¶šï¼ˆHTMLå†æç”»ã§ onclick ãŒæ¶ˆãˆã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦ï¼‰
      const historyBtn = document.getElementById('showHistoryButton');
      if (historyBtn) {
        historyBtn.onclick = () => showHistoryModal();
      }
    }

function openHistoryModal() {
  document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
  document.getElementById('modalHistoryContent').innerHTML = '';
  document.getElementById('historyModal').style.display = 'flex';
}

function closeHistoryModal() {
  document.getElementById('historyModal').style.display = 'none';
}


function updateStaffOptions() {
  const staffSelect = document.getElementById('staff');
  const companyId = document.getElementById('company').value;
  staffSelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';


  if (!companyId) return;


  masterData.staff
    .filter(staff => staff.companies.includes(companyId))
    .forEach(staff => {
      const opt = document.createElement('option');
      opt.value = staff.id;
      opt.textContent = staff.name;
      staffSelect.appendChild(opt);
    });


  updateSiteOptions(); // ã‚¹ã‚¿ãƒƒãƒ•ãŒå¤‰ã‚ã£ãŸã‚‰ç¾å ´ã‚‚å†çµã‚Šè¾¼ã¿
}


// âœ… ã“ã“ã«è¿½åŠ ï¼
function updateSiteOptions() {
  const staffId = document.getElementById('staff').value;
  const companyId = document.getElementById('company').value;
  const siteSelect = document.getElementById('site');
  siteSelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';


  if (!staffId || !companyId) return;


  masterData.site
    .filter(site => site.staffId === staffId && site.companyIds.includes(companyId))
    .forEach(site => {
      const opt = document.createElement('option');
      opt.value = site.id;
      opt.textContent = site.name;
      siteSelect.appendChild(opt);
    });
}


    function confirmSend() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      google.script.run.withSuccessHandler(() => {
        isSubmitted = true;
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('confirmationText').textContent = 'âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nåˆ¥ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã£ã¦ãã ã•ã„ã€‚';
        document.querySelector('#confirmationBox .button-row button:nth-child(1)').style.display = 'none';
      }).saveFormResponse(formData);
    }


    function sanitize(str) {
      return str.replace(/[^a-zA-Z0-9\u3040-\u30ff\u4e00-\u9faf]/g, '_');
    }


function createTimeInputs(name) {
  const container = document.createElement('div');
  container.className = 'time-inputs';
  container.id = `inputs-${name}`;

  const labelMap = { man: 'äººå·¥', overtime: 'æ®‹æ¥­' };

  ['man', 'overtime'].forEach(type => {
    const input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    input.step = '0.25';
    input.inputMode = 'decimal';
    input.placeholder = labelMap[type];  // å…¥åŠ›æ¬„å†…ã«ã€Œäººå·¥ã€ã€Œæ®‹æ¥­ã€
    input.name = `${name}-${type}`;
    input.dataset.type = type;
    input.dataset.name = name;

    // âœ… ã‚¯ãƒ©ã‚¹åã‚’ worker-input / partner-input ã«å‹•çš„ä»˜ä¸
    const prefix = name.startsWith('modal-worker') ? 'worker' :
                   name.startsWith('modal-partner') ? 'partner' : '';
    input.className = `work-input ${prefix}-input`;
    container.appendChild(input);
  });

  return container;
}


    function toggleTimeInputs(checkbox, name) {
      const inputs = document.getElementById(`inputs-${name}`);
      if (inputs) inputs.style.display = checkbox.checked ? 'flex' : 'none';
    }


    function submitForm() {
      document.querySelectorAll('.error-message').forEach(div => div.textContent = '');
      document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));


      let hasError = false;
      let firstErrorElement = null;


      const companySelect = document.getElementById('company');
      const staffSelect = document.getElementById('staff');
      const siteSelect = document.getElementById('site');
      const customDateToggle = document.getElementById('customDateToggle');
      const customDate = document.getElementById('customDate');


      if (!companySelect.value) {
        document.getElementById('error-company').textContent = 'â€»å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        companySelect.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = companySelect;
      }
      if (!staffSelect.value) {
        document.getElementById('error-staff').textContent = 'â€»TTCæ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        staffSelect.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = staffSelect;
      }
      if (!siteSelect.value) {
        document.getElementById('error-site').textContent = 'â€»ç¾å ´åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
        siteSelect.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = siteSelect;
      }
      if (customDateToggle.checked && !customDate.value) {
        document.getElementById('error-date').textContent = 'â€»å‡ºé¢æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        customDate.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = customDate;
      }


      const workerGroup = document.getElementById('worker');
      const partnerGroup = document.getElementById('partner');
      let workerChecked = false;
      let partnerChecked = false;


      formData = {
        companyId: companySelect.value,
        staffId: staffSelect.value,
        site: siteSelect.value,
        date: customDateToggle.checked ? customDate.value : '',
        workers: [],
        partners: []
      };


      document.querySelectorAll("input[name='worker']:checked").forEach(cb => {
        workerChecked = true;
        const name = cb.value;
        const safeName = sanitize(name);
        const prefix = `worker-${safeName}`;
        // const inputs = ['day', 'evening', 'night', 'overtime'].map(type => {
        const inputs = ['man', 'overtime'].map(type => {
          const el = document.querySelector(`input[name='${prefix}-${type}']`);
          return { el, value: parseFloat(el?.value || 0) };
        });
        let total = 0;
        let invalid = false;
        inputs.forEach(({ el, value }) => {
          total += value;
          if (value && !isValidQuarterHour(value)) {
            el.classList.add('input-error');
            invalid = true;
          }
        });
        if (total === 0 || invalid) {
          document.getElementById('error-worker').textContent = invalid
            ? 'â€»å‹¤å‹™æ™‚é–“ã¯0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
            : 'â€»ä½œæ¥­è€…ã®å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          workerGroup.classList.add('input-error');
          hasError = true;
          if (!firstErrorElement) firstErrorElement = workerGroup;
        }
        // formData.workers.push({ name, day: inputs[0].value, evening: inputs[1].value, night: inputs[2].value, overtime: inputs[3].value });
        formData.workers.push({ name, man: inputs[0].value, overtime: inputs[1].value });
      });


      document.querySelectorAll("input[name='partner']:checked").forEach(cb => {
        partnerChecked = true;
        const name = cb.value;
        const safeName = sanitize(name);
        const prefix = `partner-${safeName}`;
        // const inputs = ['day', 'evening', 'night', 'overtime'].map(type => {
        const inputs = ['man', 'overtime'].map(type => {
          const el = document.querySelector(`input[name='${prefix}-${type}']`);
          return { el, value: parseFloat(el?.value || 0) };
        });
        let total = 0;
        let invalid = false;
        inputs.forEach(({ el, value }) => {
          total += value;
          if (value && !isValidQuarterHour(value)) {
            el.classList.add('input-error');
            invalid = true;
          }
        });
        if (total === 0 || invalid) {
          document.getElementById('error-partner').textContent = invalid
            ? 'â€»å‹¤å‹™æ™‚é–“ã¯0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
            : 'â€»å”åŠ›ä¼šç¤¾åã®å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          partnerGroup.classList.add('input-error');
          hasError = true;
          if (!firstErrorElement) firstErrorElement = partnerGroup;
        }
        // formData.partners.push({ name, day: inputs[0].value, evening: inputs[1].value, night: inputs[2].value, overtime: inputs[3].value });
        formData.partners.push({ name, man: inputs[0].value, overtime: inputs[1].value });
      });


      if (!workerChecked && !partnerChecked) {
        document.getElementById('error-worker').textContent = 'â€»ä½œæ¥­è€…ã¾ãŸã¯å”åŠ›ä¼šç¤¾ã‚’1ä»¶ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚';
        document.getElementById('error-partner').textContent = 'â€»ä½œæ¥­è€…ã¾ãŸã¯å”åŠ›ä¼šç¤¾ã‚’1ä»¶ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚';
        workerGroup.classList.add('input-error');
        partnerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = workerGroup;
      }


      if (hasError) {
        if (firstErrorElement) {
          firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }


      showConfirmation(false);
    }

let isEditMode = false;

function showConfirmation(isEdit = false) {
  isEditMode = isEdit;
  const company = masterData.company.find(c => c.id === formData.companyId)?.name || 'ï¼ˆæœªé¸æŠï¼‰';
  const staff = masterData.staff.find(s => s.id === formData.staffId)?.name || 'ï¼ˆæœªé¸æŠï¼‰';
  const site = masterData.site.find(s => s.id === formData.site)?.name || 'ï¼ˆæœªé¸æŠï¼‰';


  let message = `å‡ºé¢æ—¥ä»˜ï¼š${formData.date || new Date().toLocaleDateString('ja-JP')}<br>
å…ƒè«‹ä¼šç¤¾ï¼š${company}<br>
TTCæ‹…å½“è€…ï¼š${staff}<br>
ç¾å ´åï¼š${site}`;


  // é …ç›®åã¨å˜ä½ã‚’è¡¨ç¤ºç”¨ã«æ•´å½¢
  const styleValueWithLabel = (label, value, isOvertime = false) => {
    const unit = isOvertime ? 'h' : 'äººå·¥';
    const display = value && value > 0
      ? `<span style="color: red; font-weight: bold;">${value}${unit}</span>`
      : `<span style="color: #999;">0${unit}</span>`;
    return `${label}ï¼š${display}`;
  };

  if (formData.workers.length > 0) {
    message += `<br><br><strong>ä½œæ¥­è€…ï¼š</strong>`;
    formData.workers.forEach(w => {
      // message += `<br>ã€€${w.name}ï¼ˆ${styleValueWithLabel('æ—¥å‹¤', w.day)} ${styleValueWithLabel('å¤•å‹¤', w.evening)} ${styleValueWithLabel('å¤œå‹¤', w.night)} ${styleValueWithLabel('æ®‹æ¥­', w.overtime, true)}ï¼‰`;
      message += `<br>ã€€${w.name}ï¼ˆ${styleValueWithLabel('äººå·¥', w.man)} ${styleValueWithLabel('æ®‹æ¥­', w.overtime, true)}ï¼‰`;
    });
  }


  if (formData.partners.length > 0) {
    message += `<br><br><strong>å”åŠ›ä¼šç¤¾ï¼š</strong>`;
    formData.partners.forEach(p => {
      // message += `<br>ã€€${p.name}ï¼ˆ${styleValueWithLabel('æ—¥å‹¤', p.day)} ${styleValueWithLabel('å¤•å‹¤', p.evening)} ${styleValueWithLabel('å¤œå‹¤', p.night)} ${styleValueWithLabel('æ®‹æ¥­', p.overtime, true)}ï¼‰`;
      message += `<br>ã€€${p.name}ï¼ˆ${styleValueWithLabel('äººå·¥', p.man)} ${styleValueWithLabel('æ®‹æ¥­', p.overtime, true)}ï¼‰`;
    });
  }


  document.getElementById('confirmationText').innerHTML = message;
  document.getElementById('confirmationModal').style.display = 'flex';


const buttonRow = document.querySelector('#confirmationBox .button-row');
buttonRow.innerHTML = isEdit
  ? `
    <button type="button" onclick="submitEditFromModal()">âœ… ç¢ºå®šã—ã¦ç·¨é›†å†…å®¹ã‚’é€ä¿¡</button>
    <button onclick="closeConfirmation()">â† ä¿®æ­£ã™ã‚‹</button>
  `
  : `
    <button onclick="confirmSend()">âœ… ç¢ºå®šã—ã¦é€ä¿¡</button>
    <button onclick="closeConfirmation()">æˆ»ã‚‹</button>
  `;

}

// function loadPreviousRecords() {
//   const date = document.getElementById('customDate').value;
//   const companyId = document.getElementById('company').value;
//   const staffId = document.getElementById('staff').value;
//   const siteId = document.getElementById('site').value;
//
//   if (!date || !companyId || !staffId || !siteId) {
//     document.getElementById('historyRecords').innerHTML = '<em>å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</em>';
//     return;
//   }
//
//   google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
// }

function loadPreviousRecords() {
  const date = document.getElementById('historyDate').value;
  const companyId = document.getElementById('company').value;
  const staffId = document.getElementById('staff').value;
  const siteId = document.getElementById('site').value;

  const container = document.getElementById('historyRecords');

  if (date && companyId && staffId && siteId) {
    // âœ… å³ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰
    container.innerHTML = '<em style="color: gray;">ğŸ“‚ é€ä¿¡å±¥æ­´ã‚’å–å¾—ä¸­ã§ã™...</em>';

    // éåŒæœŸå‘¼ã³å‡ºã—
    google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
  } else {
    container.innerHTML = '<em style="color: gray;">â€»é€ä¿¡å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯å±¥æ­´å¯¾è±¡æ—¥ä»˜ãƒ»å…ƒè«‹ãƒ»æ‹…å½“è€…ãƒ»ç¾å ´ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</em>';
  }
}

function loadModalHistory() {
  const date = document.getElementById('modalHistoryDate').value;
  const companyId = document.getElementById('company').value;
  const staffId = document.getElementById('staff').value;
  const siteId = document.getElementById('site').value;
  const container = document.getElementById('modalHistoryContent');

  if (!date || !companyId || !staffId || !siteId) {
    container.innerHTML = '<em style="color:red;">ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ãƒ»æ‹…å½“ãƒ»ç¾å ´ãƒ»æ—¥ä»˜ï¼‰</em>';
    return;
  }

  document.getElementById('loadingOverlay').style.display = 'flex'; // âœ… è¡¨ç¤ºON
  container.innerHTML = ''; // å†…å®¹åˆæœŸåŒ–

  google.script.run.withSuccessHandler(records => {
    document.getElementById('loadingOverlay').style.display = 'none'; // âœ… è¡¨ç¤ºOFF
    lastFetchedRecords = records;
    if (records.length === 0) {
      container.innerHTML = '<em>å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
      return;
    }

    let html = '<table style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    records.forEach(r => {
      html += `<tr>
        <td>${r.type}</td>
        <td>${r.name}</td>
        <td>${r.man}</td>
        <td>${r.overtime}</td>
      </tr>`;
    });
    html += '</table>';
    html += `<button onclick="showEditFormInModal()">ç·¨é›†ã™ã‚‹</button>`;
    container.innerHTML = html;
  }).getPreviousRecords(date, companyId, staffId, siteId);
}

let lastFetchedRecords = [];

function displayHistory(records) {
  const container = document.getElementById('historyRecords');
  const editButton = document.getElementById('editButton');
  lastFetchedRecords = records;

  if (!records || records.length === 0) {
    container.innerHTML = '<em>å±¥æ­´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
    editButton.style.display = 'none';
    return;
  }

  let html = '<table style="width:100%; border-collapse: collapse;">';
  html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
  records.forEach(r => {
    html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td>${r.man}</td>
      <td>${r.overtime}</td>
    </tr>`;
  });
  html += '</table>';
  container.innerHTML = html;

  editButton.style.display = 'inline-block'; // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
}

function showEditForm() {
  const container = document.getElementById('editFormContainer');
  if (!lastFetchedRecords || lastFetchedRecords.length === 0) return;

  let html = '<h3>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h3>';
  html += '<table style="width:100%; border-collapse: collapse;">';
  html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
  lastFetchedRecords.forEach((r, i) => {
    html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td><input type="number" step="0.25" value="${r.day}" id="edit-day-${i}" /></td>
      <td><input type="number" step="0.25" value="${r.evening}" id="edit-evening-${i}" /></td>
      <td><input type="number" step="0.25" value="${r.night}" id="edit-night-${i}" /></td>
      <td><input type="number" step="0.25" value="${r.overtime}" id="edit-overtime-${i}" /></td>
    </tr>`;
  });
  html += '</table>';
  html += `<button onclick="submitEdit()">å†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰</button>`;

  container.innerHTML = html;
}

function showEditFormInModal() {
  const container = document.getElementById('modalHistoryContent');

  let html = '<h3>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h3>';
  html += '<table style="width:100%; border-collapse: collapse;">';
  // html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>æ—¥å‹¤</th><th>å¤•å‹¤</th><th>å¤œå‹¤</th><th>æ®‹æ¥­</th></tr>';
  html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
  lastFetchedRecords.forEach((r, i) => {
    html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td><input type="number" step="0.25" class="work-input" placeholder="äººå·¥" value="${r.man}" id="edit-man-${i}" /></td>
      <td><input type="number" step="0.25" class="work-input" placeholder="æ®‹æ¥­" value="${r.overtime}" id="edit-overtime-${i}" /></td>

    </tr>`;
  });
  html += '</table>';
  html += `<button onclick="showEditConfirmationModal()">å†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰</button>`;
  container.innerHTML = html;
  renderAdditionalInputs(); // âœ… å±¥æ­´å¤–ã®è¿½åŠ å€™è£œã‚’è¡¨ç¤º
}

function submitEdit() {
  const edited = lastFetchedRecords.map((r, i) => ({
    ...r,
    man: parseFloat(document.getElementById(`edit-man-${i}`).value || 0),
    overtime: parseFloat(document.getElementById(`edit-overtime-${i}`).value || 0),
  }));

  const meta = {
    date: document.getElementById('customDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    siteId: document.getElementById('site').value,
  };

  google.script.run.withSuccessHandler(() => {
    document.getElementById('loadingOverlay').style.display = 'none'; // ğŸ”„ è¿½åŠ 
    alert("å†é€ä¿¡ã—ã¾ã—ãŸï¼");
    loadPreviousRecords();
    document.getElementById('editFormContainer').innerHTML = '';
  }).updateEditedRecords(meta, edited);
}

function showEditConfirmationModal() {
  isEditMode = true;
  // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
  document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
  document.querySelectorAll('.edit-error-message').forEach(el => el.remove());

  let hasError = false;
  const editedRecords = []; // æ›´æ–°å¾Œã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—

  // --- 1. æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† ---
  lastFetchedRecords.forEach((r, i) => {
    const manInput = document.getElementById(`edit-man-${i}`);
    const overtimeInput = document.getElementById(`edit-overtime-${i}`);

    if (!manInput || !overtimeInput) return; // å¿µã®ãŸã‚è¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯

    const man = parseFloat(manInput.value || 0);
    const overtime = parseFloat(overtimeInput.value || 0);
    let isRowInvalid = false;

    // 0.25å˜ä½ãƒã‚§ãƒƒã‚¯
    [manInput, overtimeInput].forEach(input => {
      const val = parseFloat(input.value || 0);
      if (input.value && !isValidQuarterHour(val)) {
        input.classList.add('input-error');
        const errMsg = document.createElement('div');
        errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        errMsg.className = 'edit-error-message';
        errMsg.style.color = 'red';
        input.parentElement.appendChild(errMsg);
        hasError = true;
        isRowInvalid = true;
      }
    });

    if (!isRowInvalid) {
      editedRecords.push({ ...r, man, overtime });
    }
  });

  // --- 2. è¿½åŠ ä½œæ¥­è€…ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† ---
  document.querySelectorAll('.additional-worker:checked').forEach(cb => {
    const name = cb.value;
    const safeName = sanitize(name);
    // dataset ã‚’ä½¿ã£ã¦æ­£ã—ãè¦ç´ ã‚’å–å¾—
    const manInput = document.querySelector(`input[data-name="modal-worker-${safeName}"][data-type="man"]`);
    const overtimeInput = document.querySelector(`input[data-name="modal-worker-${safeName}"][data-type="overtime"]`);

    if (!manInput || !overtimeInput) return;

    const man = parseFloat(manInput.value || 0);
    const overtime = parseFloat(overtimeInput.value || 0);
    let isRowInvalid = false;

    // åˆè¨ˆ0ãƒã‚§ãƒƒã‚¯
    if ((man + overtime) <= 0) {
      [manInput, overtimeInput].forEach(input => input.classList.add('input-error'));
      const errMsg = document.createElement('div');
      errMsg.className = 'edit-error-message';
      errMsg.textContent = 'â€»å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      errMsg.style.color = 'red';
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
      manInput.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
      hasError = true;
      isRowInvalid = true;
    }

    // 0.25å˜ä½ãƒã‚§ãƒƒã‚¯
    [manInput, overtimeInput].forEach(input => {
      const val = parseFloat(input.value || 0);
      if (input.value && !isValidQuarterHour(val)) {
        input.classList.add('input-error');
        // æ—¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã‘ã‚Œã°è¿½åŠ 
        if (!manInput.closest('.checkbox-wrapper').querySelector('.edit-error-message')) {
          const errMsg = document.createElement('div');
          errMsg.className = 'edit-error-message';
          errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          errMsg.style.color = 'red';
          input.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
        }
        hasError = true;
        isRowInvalid = true;
      }
    });

    if (!isRowInvalid) {
      editedRecords.push({ type: 'ä½œæ¥­è€…', name, man, overtime });
    }
  });

  // --- 3. è¿½åŠ å”åŠ›ä¼šç¤¾ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† (ä½œæ¥­è€…ã¨ã»ã¼åŒã˜) ---
  document.querySelectorAll('.additional-partner:checked').forEach(cb => {
    const name = cb.value;
    const safeName = sanitize(name);
    const manInput = document.querySelector(`input[data-name="modal-partner-${safeName}"][data-type="man"]`);
    const overtimeInput = document.querySelector(`input[data-name="modal-partner-${safeName}"][data-type="overtime"]`);

    if (!manInput || !overtimeInput) return;

    const man = parseFloat(manInput.value || 0);
    const overtime = parseFloat(overtimeInput.value || 0);
    let isRowInvalid = false;

    if ((man + overtime) <= 0) {
      [manInput, overtimeInput].forEach(input => input.classList.add('input-error'));
      const errMsg = document.createElement('div');
      errMsg.className = 'edit-error-message';
      errMsg.textContent = 'â€»å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      errMsg.style.color = 'red';
      manInput.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
      hasError = true;
      isRowInvalid = true;
    }

    [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
            input.classList.add('input-error');
            if (!manInput.closest('.checkbox-wrapper').querySelector('.edit-error-message')) {
                 const errMsg = document.createElement('div');
                 errMsg.className = 'edit-error-message';
                 errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                 errMsg.style.color = 'red';
                 input.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
            }
            hasError = true;
            isRowInvalid = true;
        }
    });

    if (!isRowInvalid) {
      editedRecords.push({ type: 'å”åŠ›ä¼šç¤¾', name, man, overtime });
    }
  });

  // --- 4. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã«å¿œã˜ã¦å‡¦ç† ---
  if (hasError) {
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¾ã¾å‡¦ç†ã‚’ä¸­æ–­
    return;
  }

  // --- 5. ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã®ã¿ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ç¢ºèªç”»é¢ã¸ ---
  document.getElementById('historyModal').style.display = 'none';

  // é€ä¿¡ç”¨ã®formDataã‚’æ§‹ç¯‰
  formData = {
    date: document.getElementById('modalHistoryDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    site: document.getElementById('site').value,
    workers: editedRecords.filter(r => r.type === 'ä½œæ¥­è€…').map(({ name, man, overtime }) => ({ name, man, overtime })),
    partners: editedRecords.filter(r => r.type === 'å”åŠ›ä¼šç¤¾').map(({ name, man, overtime }) => ({ name, man, overtime }))
  };

  // ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
  showConfirmation(true);
}

// ä»¥ä¸‹ã®é–¢æ•°ã‚’ã¾ã‚‹ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„
function submitEditFromModal() {
  document.getElementById('loadingOverlay').style.display = 'flex';

  const edited = [];
  lastFetchedRecords.forEach((r, i) => {
    const manInput = document.getElementById(`edit-man-${i}`);
    const overtimeInput = document.getElementById(`edit-overtime-${i}`);
    if (manInput && overtimeInput) {
        edited.push({
            ...r,
            man: parseFloat(manInput.value || 0),
            overtime: parseFloat(overtimeInput.value || 0),
        });
    }
  });

  document.querySelectorAll('.additional-worker:checked').forEach(cb => {
    const name = cb.value;
    const safeName = sanitize(name);
    const inputs = document.querySelectorAll(`.worker-input[data-name="modal-worker-${safeName}"]`);
    const entry = { type: 'ä½œæ¥­è€…', name };
    inputs.forEach(input => {
      const raw = input.value;
      entry[input.dataset.type] = raw === '' ? 0 : parseFloat(raw);
    });
    edited.push(entry);
  });

  document.querySelectorAll('.additional-partner:checked').forEach(cb => {
    const name = cb.value;
    const safeName = sanitize(name);
    const inputs = document.querySelectorAll(`.partner-input[data-name="modal-partner-${safeName}"]`);
    const entry = { type: 'å”åŠ›ä¼šç¤¾', name };
    inputs.forEach(input => {
      const raw = input.value;
      entry[input.dataset.type] = raw === '' ? 0 : parseFloat(raw);
    });
    edited.push(entry);
  });

  const meta = {
    date: document.getElementById('modalHistoryDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    siteId: document.getElementById('site').value,
  };

  google.script.run.withSuccessHandler(() => {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('confirmationText').textContent = 'âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nåˆ¥ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã£ã¦ãã ã•ã„ã€‚';

    // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã§ä¸Šæ›¸ã
    const buttonRow = document.querySelector('#confirmationBox .button-row');
    buttonRow.innerHTML = '<button onclick="closeConfirmation()">é–‰ã˜ã‚‹</button>';

    setTimeout(() => {
      if (isEditMode) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã®é€ä¿¡ãŒå®Œäº†ã—ãŸã‚‰ã€å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        document.getElementById('historyModal').style.display = 'none';
      }
    }, 300);

  }).updateEditedRecords(meta, edited);
}

/*
function deleteRecord(index) {
  const confirmDelete = confirm(`ã€Œ${lastFetchedRecords[index].name}ã€ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
  if (!confirmDelete) return;

  const meta = {
    date: document.getElementById('modalHistoryDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    siteId: document.getElementById('site').value,
  };

  const record = lastFetchedRecords[index];

  google.script.run.withSuccessHandler(() => {
    alert("å‰Šé™¤ã—ã¾ã—ãŸ");
    closeHistoryModal(); // ä¸€åº¦é–‰ã˜ã¦
    openHistoryModal();  // å†èª­ã¿è¾¼ã¿
  }).deleteRecordFromSheet(meta, record);
}
*/

function confirmEditSend() {
  const edited = lastFetchedRecords.map((r, i) => ({
    ...r,
    day: parseFloat(document.getElementById(`edit-day-${i}`).value || 0),
    evening: parseFloat(document.getElementById(`edit-evening-${i}`).value || 0),
    night: parseFloat(document.getElementById(`edit-night-${i}`).value || 0),
    overtime: parseFloat(document.getElementById(`edit-overtime-${i}`).value || 0),
  }));

  // è¿½åŠ ãƒã‚§ãƒƒã‚¯åˆ†ã‚‚å«ã‚€å ´åˆã“ã“ã«è¿½åŠ OK

  const meta = {
    date: document.getElementById('modalHistoryDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    siteId: document.getElementById('site').value,
  };

  document.getElementById('loadingOverlay').style.display = 'flex';

  google.script.run.withSuccessHandler(() => {
    document.getElementById('loadingOverlay').style.display = 'none';
    alert("é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
    closeConfirmation();
    closeHistoryModal();
  }).updateEditedRecords(meta, edited);
}


function updateWorkerAndPartner() {
  const staffId = document.getElementById('staff').value;


  const workerContainer = document.getElementById('worker');
  const partnerContainer = document.getElementById('partner');
  workerContainer.innerHTML = '';
  partnerContainer.innerHTML = '';
  const registeredNames = new Set(lastFetchedRecords.map(r => `${r.type}:${r.name}`));  // ä½œæ¥­è€…:å±±ç”° ãªã©


  // ä½œæ¥­è€…ã®è¡¨ç¤º
  masterData.worker
    .filter(w => w.staffIds.includes(staffId))
    .filter(w => !registeredNames.has(`ä½œæ¥­è€…:${w.name}`))  // âœ… ç™»éŒ²æ¸ˆã¯é™¤å¤–
    .forEach(w => {
      const safeName = sanitize(w.name);
      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';


      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'worker';
      checkbox.value = w.name;
      checkbox.onchange = () => toggleTimeInputs(checkbox, `worker-${safeName}`);


      const span = document.createElement('span');
      span.textContent = w.name;


      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      workerContainer.appendChild(wrapper);
      workerContainer.appendChild(createTimeInputs(`worker-${safeName}`));
    });


  // âœ… å”åŠ›ä¼šç¤¾ã®è¡¨ç¤ºï¼ˆé–¢æ•°å†…ã«å«ã‚ã‚‹ã“ã¨ï¼ï¼‰
  masterData.partner
    .filter(p => p.staffIds.includes(staffId))
    .filter(p => !registeredNames.has(`å”åŠ›ä¼šç¤¾:${p.name}`))  // âœ… ç™»éŒ²æ¸ˆã¯é™¤å¤–
    .forEach(p => {
      const safeName = sanitize(p.name);
      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';


      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'partner';
      checkbox.value = p.name;
      checkbox.onchange = () => toggleTimeInputs(checkbox, `partner-${safeName}`);


      const span = document.createElement('span');
      span.textContent = p.name;


      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      partnerContainer.appendChild(wrapper);
      partnerContainer.appendChild(createTimeInputs(`partner-${safeName}`));
    });
}



window.onload = function () {
  google.script.run.withSuccessHandler(data => {
    masterData = data;

    // å…ƒè«‹ä¼šç¤¾ã®ã‚»ãƒ¬ã‚¯ãƒˆä½œæˆ
    const companySelect = document.getElementById('company');
    companySelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
    masterData.company.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      companySelect.appendChild(opt);
    });

    // æ‹…å½“è€…ãƒ»ç¾å ´åãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    document.getElementById("company").addEventListener("change", updateStaffOptions);
    document.getElementById("company").addEventListener("change", updateSiteOptions);
    document.getElementById("staff").addEventListener("change", updateSiteOptions);
    document.getElementById("staff").addEventListener("change", updateWorkerAndPartner);

    // âœ… ç·¨é›†æ©Ÿèƒ½ãªã©è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
    const historyDateInput = document.getElementById("historyDate");
    if (historyDateInput) {
      historyDateInput.addEventListener("change", loadPreviousRecords);
    }
  }).getMasterData();
};

function openHistoryModal() {
  document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
  document.getElementById('modalHistoryContent').innerHTML = '';
  document.getElementById('historyModal').style.display = 'flex';
}

function closeHistoryModal() {
  document.getElementById('historyModal').style.display = 'none';
  updateWorkerAndPartner();  // âœ… é–‰ã˜ãŸã‚‰å€™è£œæ›´æ–°
}

function renderAdditionalInputs() {
  const workerContainer = document.getElementById('additionalWorkerInputs');
  const partnerContainer = document.getElementById('additionalPartnerInputs');
  workerContainer.innerHTML = '';
  partnerContainer.innerHTML = '';

  const staffId = document.getElementById('staff').value;
  if (!staffId) return;

  const registered = new Set(lastFetchedRecords.map(r => `${r.type}:${r.name}`));

  // ğŸ”½ ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è€…ï¼å”åŠ›ä¼šç¤¾ã®åå‰ã‚‚é™¤å¤–å¯¾è±¡ã«è¿½åŠ 
  document.querySelectorAll('#edit-table tbody tr').forEach(row => {
    const type = row.querySelector('td:nth-child(1)').textContent.trim();
    const name = row.querySelector('td:nth-child(2)').textContent.trim();
    registered.add(`${type}:${name}`);
  });

  const createCheckboxBlock = (type, name, container) => {
    const safeName = sanitize(name);
    const wrapper = document.createElement('label');
    wrapper.className = 'checkbox-wrapper';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = `additional-${type}`;
    checkbox.value = name;
    checkbox.onchange = () => toggleTimeInputs(checkbox, `modal-${type}-${safeName}`);

    const span = document.createElement('span');
    span.textContent = name;

    wrapper.appendChild(checkbox);
    wrapper.appendChild(span);
    container.appendChild(wrapper);

    const inputs = createTimeInputs(`modal-${type}-${safeName}`);
    container.appendChild(inputs);
  };

  // âœ… ä½œæ¥­è€…ã®è¦‹å‡ºã—
  // const workerHeader = document.createElement('h4');
  // workerHeader.textContent = 'ä½œæ¥­è€…';
  // workerContainer.appendChild(workerHeader);

  masterData.worker
    .filter(w => w.staffIds.includes(staffId))
    .filter(w => !registered.has(`ä½œæ¥­è€…:${w.name}`)) // âœ… é‡è¤‡å›é¿
    .forEach(w => createCheckboxBlock('worker', w.name, workerContainer));

  // âœ… å”åŠ›ä¼šç¤¾ã®è¦‹å‡ºã—
  // const partnerHeader = document.createElement('h4');
  // partnerHeader.textContent = 'å”åŠ›ä¼šç¤¾';
  // partnerContainer.appendChild(partnerHeader);

  masterData.partner
    .filter(p => p.staffIds.includes(staffId))
    .filter(p => !registered.has(`å”åŠ›ä¼šç¤¾:${p.name}`)) // âœ… é‡è¤‡å›é¿
    .forEach(p => createCheckboxBlock('partner', p.name, partnerContainer));
}


function toggleSection(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const isShown = el.style.display === 'block';
  el.style.display = isShown ? 'none' : 'block';
}

  </script> -->
</head>
<body>
<div id="dateToggleWrapper">
  <label class="date-toggle-button" id="dateToggleButton">
    <input type="checkbox" id="customDateToggle" onchange="toggleDateInput(this)">
    â€»å½“æ—¥ã‚ˆã‚Šå‰ã®å‡ºé¢å…¥åŠ›ã®å ´åˆã¯ã“ã¡ã‚‰ã‚’ã‚¿ãƒƒãƒ—
  </label>
  <div id="dateContainer">
    <label for="customDate" class="section-label">å‡ºé¢æ—¥ä»˜</label>
    <input type="date" id="customDate">
    <div id="error-date" class="error-message"></div>
  </div>
</div>


  <div>
    <label for="company"  class="section-label">å…ƒè«‹ä¼šç¤¾</label>
    <select id="company">
      <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
    <div id="error-company" class="error-message"></div>
  </div>


  <div>
    <label for="staff"  class="section-label">TTCæ‹…å½“è€…</label>
    <select id="staff">
      <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
    <div id="error-staff" class="error-message"></div>
  </div>


  <div>
    <label for="site"  class="section-label">ç¾å ´å</label>
    <select id="site">
      <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
    <div id="error-site" class="error-message"></div>
  </div>

<!-- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒˆãƒªã‚¬ãƒ¼ -->
<div style="margin-top: 2rem;">
  <label class="date-toggle-button" onclick="openHistoryModal()">
    â€»é€ä¿¡å±¥æ­´ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã“ã¡ã‚‰ã‚’ã‚¿ãƒƒãƒ—
  </label>
</div>

<!-- âœ… å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ -->
<div id="historyModal" style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
  <div style="background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
    <h3>ä½•æ—¥ã®é€ä¿¡å±¥æ­´ã‚’ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ</h3>
    <input type="date" id="modalHistoryDate" class="custom-date-input" />
    <button onclick="loadModalHistory()">é€ä¿¡å±¥æ­´ã‚’å–å¾—</button>
    <div id="modalHistoryContent" style="margin-top: 1rem;"></div>
    <!-- âœ… æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨ã«è¿½åŠ ï¼‰ -->
    <div class="toggle-header" onclick="toggleSection('toggleAddArea')">ï¼‹ æ–°ã—ã„ä½œæ¥­è€…ï¼å”åŠ›ä¼šç¤¾ã‚’è¿½åŠ </div>
    <div id="toggleAddArea" class="toggle-section">
      <div class="toggle-header inner" onclick="toggleSection('workerSection')">â–¶ ä½œæ¥­è€…</div>
      <div id="workerSection" class="toggle-section inner">
       <div id="additionalWorkerInputs"></div>
      </div>

      <div class="toggle-header inner" onclick="toggleSection('partnerSection')">â–¶ å”åŠ›ä¼šç¤¾</div>
      <div id="partnerSection" class="toggle-section inner">
        <div id="additionalPartnerInputs"></div>
      </div>
    </div>
    <button onclick="closeHistoryModal()" style="margin-top: 1rem;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!--
  <div>
  <label class="section-label">é€ä¿¡å±¥æ­´</label>
  <div id="historyRecords" style="margin-top: 1rem; border: 1px solid #ccc; padding: 1rem;  border-radius: 6px; background-color: #fff;"></div>
  </div>

<div style="margin-bottom: 1rem;">
  <label for="historyDate">å±¥æ­´å¯¾è±¡æ—¥ä»˜</label>
  <input type="date" id="historyDate" style="font-size: 2rem; padding: 0.5rem; width: 100%;">
</div>

<div id="editSection" style="margin-top: 2rem;">
  <button id="editButton" onclick="showEditForm()" style="display: none;">ç·¨é›†ã™ã‚‹</button>
  <div id="editFormContainer"></div>
</div>
-->

  <div>
  <label  class="section-label">ä½œæ¥­è€…</label>
  <div id="worker" class="checkbox-group"></div>
  <div id="error-worker" class="error-message"></div>
</div>


<div>
  <label  class="section-label">å”åŠ›ä¼šç¤¾å</label>
  <div id="partner" class="checkbox-group"></div>
  <div id="error-partner" class="error-message"></div>
</div>

  <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
  <div>
    <label for="uploadPhotos" class="section-label">å†™çœŸã‚’æ·»ä»˜ï¼ˆæœ€å¤§5æšï¼‰</label>
    <input type="file" id="uploadPhotos" multiple accept="image/*">
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
  <div id="previewArea" style="margin-top:1rem; display:flex; gap:1rem; flex-wrap:wrap;"></div>

  <script>
    const fileInput = document.getElementById('uploadPhotos');
    const previewArea = document.getElementById('previewArea');

    fileInput.addEventListener('change', () => {
      previewArea.innerHTML = ''; // ä¸€åº¦ã‚¯ãƒªã‚¢
      const files = Array.from(fileInput.files).slice(0, 5); // æœ€å¤§5æšã¾ã§

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.maxWidth = '150px';
          img.style.maxHeight = '150px';
          img.style.objectFit = 'cover';
          img.style.border = '1px solid #ccc';
          img.style.borderRadius = '6px';
          previewArea.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
  </script>


  <div>
    <button onclick="submitForm()">é€ä¿¡</button>
  </div>


<!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="confirmationModal" onclick="handleModalClickOutside(event)">
  <div id="confirmationBox" onclick="event.stopPropagation()">
    <div id="confirmationText">ã“ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="button-row">
      <button onclick="confirmSend()">âœ… ç¢ºå®šã—ã¦é€ä¿¡</button>
      <button onclick="closeConfirmation()">æˆ»ã‚‹</button>
    </div>
  </div>
</div>


<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆçµ±åˆç‰ˆï¼‰ -->
<div id="loadingOverlay">
  <div class="loader"></div>
  <div style="margin-top: 1rem; font-size: 1.2rem; color: #0066cc;">é€ä¿¡ä¸­...</div>
</div>






</body>




</html>
