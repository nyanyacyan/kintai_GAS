<script>
  window.onload = function () {
    google.script.run
      .withSuccessHandler(data => {
        console.log('[OK] getMasterData result =', data, 'keys:', Object.keys(data || {}));
        masterData = data;

        // 会社セレクト初期化
        const companySelect = document.getElementById('company');
        companySelect.innerHTML = '<option value="" disabled selected>選択してください</option>';

        // ← ここで本当に配列？ 長さは？ を念のため確認
        console.log('masterData.company length =', masterData?.company?.length);
        (masterData.company || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          companySelect.appendChild(opt);
        });

        // イベント配線
        document.getElementById("company").addEventListener("change", updateStaffOptions);
        document.getElementById("company").addEventListener("change", updateSiteOptions);
        document.getElementById("staff").addEventListener("change", updateSiteOptions);
        document.getElementById("staff").addEventListener("change", updateWorkerAndPartner);

        const historyDateInput = document.getElementById("historyDate");
        if (historyDateInput) historyDateInput.addEventListener("change", loadPreviousRecords);
      })
      .withFailureHandler(err => {
        console.error('[NG] getMasterData failed:', err);
        alert('マスター取得に失敗しました: ' + err?.message);
      })
      .getMasterData();
  };

  document.addEventListener('DOMContentLoaded', () => {
    console.log('[init_js] DOM ready');
    console.log('[init_js] typeof heic2any =', typeof window.heic2any);
    console.log('[init_js] typeof submitForm =', typeof window.submitForm);

    const btn = document.getElementById('sendBtn');
    console.log('[init_js] found #sendBtn:', !!btn);

    if (btn) {
      btn.addEventListener('click', () => {
        console.log('[init_js] sendBtn clicked');
        if (typeof window.submitForm === 'function') window.submitForm();
        else console.warn('submitForm not found at click time');
      });
    }
  });

</script>
