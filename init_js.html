<script>
  window.onload = function () {
    google.script.run
      .withSuccessHandler(data => {
        console.log('[OK] getMasterData result =', data, 'keys:', Object.keys(data || {}));
        masterData = data;

        // 会社セレクト初期化
        const companySelect = document.getElementById('company');
        companySelect.innerHTML = '<option value="" disabled selected>選択してください</option>';

        // ← ここで本当に配列？ 長さは？ を念のため確認
        console.log('masterData.company length =', masterData?.company?.length);
        (masterData.company || []).forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.name;
          companySelect.appendChild(opt);
        });

        // イベント配線
        document.getElementById("company").addEventListener("change", updateStaffOptions);
        document.getElementById("company").addEventListener("change", updateSiteOptions);
        document.getElementById("staff").addEventListener("change", updateSiteOptions);
        document.getElementById("staff").addEventListener("change", updateWorkerAndPartner);

        const historyDateInput = document.getElementById("historyDate");
        if (historyDateInput) historyDateInput.addEventListener("change", loadPreviousRecords);
      })
      .withFailureHandler(err => {
        console.error('[NG] getMasterData failed:', err);
        alert('マスター取得に失敗しました: ' + err?.message);
      })
      .getMasterData();
  };

  document.addEventListener('DOMContentLoaded', () => {
    console.log('[init_js] bind handlers');
    const btn = document.getElementById('sendBtn');
    if (btn && typeof window.submitForm === 'function') {
      btn.addEventListener('click', window.submitForm);
      console.log('[init_js] submitForm bound');
    } else {
      console.warn('[init_js] submitForm not ready:', typeof window.submitForm);
    }
  });

</script>
