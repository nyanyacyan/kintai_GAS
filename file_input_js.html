<script>
// 1回だけ初期化
window.uploadQueue = window.uploadQueue || { modal: [], main: [], edit: [] };

function setupUploader(rootId, opts = {}) {
  const { max = 5, mode = 'grid' } = opts;
  const root = document.getElementById(rootId);
  if (!root) return;

  const input   = root.querySelector('input[type="file"]');
  const button  = root.querySelector('.file-button');
  const counter = root.querySelector('.file-count');
  const preview = root.querySelector('.preview-grid');
  if (!input || !button || !counter || !preview) return;

  // ★ rootId から queueKey を決定
  const queueKey = (rootId === 'uploaderModal') ? 'modal'
                  : (rootId === 'uploaderMain')  ? 'main'
                  : 'edit';

  // クリックでファイル選択
  button.addEventListener('click', () => input.click());

  input.addEventListener('change', () => {
    const files   = Array.from(input.files);
    const sorted  = files.sort((a,b) => a.name.localeCompare(b.name, 'ja'));
    const limited = sorted.slice(0, max);

    if (files.length > max) {
      alert(`写真は最大${max}枚までです。先頭${max}枚のみ表示します。`);
    }
    counter.textContent = `${limited.length} 枚`;

    // プレビュー初期化 & ★キューを今回選択分でリセット
    preview.innerHTML = '';
    window.uploadQueue[queueKey] = [];

    if (mode === 'grid') {
      // ===== グリッド（複数並べ）=====
      preview.style.display = 'flex';
      preview.style.flexWrap = 'wrap';
      preview.style.gap = '8px';

      const imgEls = [];
      limited.forEach((_, idx) => {
        const card  = document.createElement('div');
        const img   = document.createElement('img');
        const badge = document.createElement('div');
        card.className = 'preview-card';
        img.alt = `${idx + 1}枚目`;
        badge.className = 'preview-badge';
        badge.textContent = `${idx + 1} 枚目`;
        card.append(img, badge);
        preview.appendChild(card);
        imgEls.push(img);
      });

      // ★ グリッドでも DataURL を uploadQueue に積む
      limited.forEach((file, idx) => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          imgEls[idx].src = e.target.result;
          window.uploadQueue[queueKey].push({  // ここでキューに積む
            name: file.name,
            type: file.type,
            dataUrl: e.target.result
          });
        };
        reader.readAsDataURL(file);
      });

    } else {
      // ===== カルーセル（1枚全幅）=====
      const carousel = document.createElement('div');
      carousel.className = 'carousel';
      const viewport = document.createElement('div');
      viewport.className = 'carousel-viewport';
      const track = document.createElement('div');
      track.className = 'carousel-track';
      viewport.appendChild(track);
      carousel.appendChild(viewport);

      const nav = document.createElement('div');
      nav.className = 'carousel-nav';
      const prevBtn = document.createElement('button');
      const nextBtn = document.createElement('button');
      prevBtn.textContent = '◀';
      nextBtn.textContent = '▶';
      nav.append(prevBtn, nextBtn);

      const dots = document.createElement('div');
      dots.className = 'carousel-dots';

      preview.appendChild(carousel);
      preview.appendChild(nav);
      preview.appendChild(dots);

      const slideEls = [];
      const dotEls = [];

      limited.forEach((_, idx) => {
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';
        const img = document.createElement('img');
        img.alt = `${idx + 1}枚目`;
        slide.appendChild(img);
        track.appendChild(slide);
        slideEls.push(img);

        const dot = document.createElement('div');
        dot.className = 'carousel-dot';
        dots.appendChild(dot);
        dotEls.push(dot);
      });

      // ★ カルーセルでも DataURL を uploadQueue に積む
      limited.forEach((file, idx) => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = e => {
          slideEls[idx].src = e.target.result;
          window.uploadQueue[queueKey].push({
            name: file.name,
            type: file.type,
            dataUrl: e.target.result
          });
        };
        reader.readAsDataURL(file);
      });

      // ステート & 動き
      let index = 0;
      const total = limited.length;
      const width = () => viewport.clientWidth;
      function render() {
        track.style.transform = `translateX(${-index * width()}px)`;
        prevBtn.disabled = (index === 0);
        nextBtn.disabled = (index === total - 1);
        dotEls.forEach((d, i) => d.classList.toggle('active', i === index));
      }
      function goTo(n) {
        index = Math.max(0, Math.min(total - 1, n));
        render();
      }
      prevBtn.addEventListener('click', () => goTo(index - 1));
      nextBtn.addEventListener('click', () => goTo(index + 1));
      window.addEventListener('resize', render);

      // スワイプ
      let startX = 0, currentX = 0, dragging = false;
      viewport.addEventListener('touchstart', e => {
        if (!total) return;
        dragging = true;
        startX = e.touches[0].clientX;
        currentX = startX;
      }, { passive: true });
      viewport.addEventListener('touchmove', e => {
        if (!dragging) return;
        currentX = e.touches[0].clientX;
        const dx = currentX - startX;
        const base = -index * width();
        track.style.transform = `translateX(${base + dx}px)`;
      }, { passive: true });
      viewport.addEventListener('touchend', () => {
        if (!dragging) return;
        dragging = false;
        const dx = currentX - startX;
        const threshold = width() * 0.25;
        if (dx > threshold) goTo(index - 1);
        else if (dx < -threshold) goTo(index + 1);
        else render();
      });
      render();
    }
  });
}

// 初期化
document.addEventListener('DOMContentLoaded', () => {
  setupUploader('uploaderModal', { max: 5, mode: 'carousel' });
  setupUploader('uploaderMain',  { max: 5, mode: 'carousel' });
  // 編集用アップローダを使うなら必要に応じて：
  // setupUploader('uploaderEdit',  { max: 5, mode: 'grid' });
});
</script>
