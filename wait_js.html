
<script>
  //-----------------ローディング　　４~15行目・21行目・47.53行目-------------------
function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (!overlay) return;
  overlay.style.display = 'flex';      // 表示
}



function hideLoading() {　
    const overlay = document.getElementById('loadingOverlay');
    if (!overlay) return;
  overlay.style.display = 'none';       // 非表示
}



  // 確定送信（画像アップロード → スプレッドシート保存）
function confirmSend() {
    console.log('[confirmSend] start');
    console.log('[confirmSend] current formData =', JSON.parse(JSON.stringify(formData)));
    showLoading();

    // 表示用の名称を逆引き
    const companyName = masterData.company.find(c => c.id === formData.companyId)?.name || '';
    const siteObj = masterData.site.find(s => s.id === formData.site) || {};
    const siteName = siteObj.name || '';
    const workType = formData.workType || siteObj.workType || 'その他';
    const reportDate = formData.date || new Date().toISOString().slice(0, 10);

    // アップロード用 meta（サーバ側は Script Properties で親フォルダを参照）
    const meta = { workType, reportDate, siteName, companyName };
    console.log('[confirmSend] meta =', meta);

    // 画像キュー
    const files = [
        ...(window.uploadQueue?.modal || []),
        ...(window.uploadQueue?.main || [])
    ];
    console.log('[confirmSend] files.length =', files.length);

    // 保存処理
    const runSave = () => {
        console.log('[confirmSend] runSave() start');
        google.script.run
        .withSuccessHandler(res => {
        console.log('[confirmSend] saveFormResponse success', res);
        hideLoading();
        showSendSuccessScreen(formData); // ✅ 完了画面に切り替え
        console.log('[confirmSend] runSave() end(success)');
        })
        .withFailureHandler(err => {
        console.error('[confirmSend] saveFormResponse failed', err);
        hideLoading();
        showSendErrorScreen(err);
        console.log('[confirmSend] runSave() end(failed)');
        })
        .saveFormResponse(formData);
    };

    if (files.length > 0) {
        showLoading();
        console.log('[confirmSend] uploadImagesToDrive start');
        google.script.run
        .withSuccessHandler(result => {
        console.log('[confirmSend] uploadImagesToDrive success', result);
          formData.photos = result; // [{id,url,name}, ...]
        hideLoading();
        runSave();
        })
        .withFailureHandler(err => {
        console.error('[confirmSend] uploadImagesToDrive failed', err);
        hideLoading();
        showSendErrorScreen(err);
        })
        .uploadImagesToDrive(meta, files);
    } else {
        runSave();
    }

    console.log('[confirmSend] end');
}





//---------------------資格者情報チェック後に、人工・残業追加-------------------------------
function createPartnerRoleMatrix(nameKey) {
  const wrap = document.createElement('div');
  wrap.className = 'partner-role-matrix';
  wrap.id = `matrix-${nameKey}`;
  wrap.style.display = 'none'; // デフォルト非表示

  wrap.innerHTML = `
  <div class="role-row">
    <label><input type="checkbox" name="${nameKey}-general-checked"> 一般作業員</label>
    <div class="work-inputs">
        <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-general-man" disabled>
        <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-general-overtime" disabled>
    </div>
  </div>
  <div class="role-row">
    <label><input type="checkbox" name="${nameKey}-leader-checked"> 職長</label>
    <div class="work-inputs">
        <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-leader-man" disabled>
        <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-leader-overtime" disabled>
    </div>
  </div>
  <div class="role-row">
    <label><input type="checkbox" name="${nameKey}-qualified-checked"> 有資格者</label>
    <div class="work-inputs">
        <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-qualified-man" disabled>
        <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-qualified-overtime" disabled>
    </div>
  </div>
`;

// すべてのチェックボックスを探す
const checkboxes = wrap.querySelectorAll('.role-row input[type="checkbox"]');

// 1つずつ取り出して処理をつける
checkboxes.forEach(function(cb) {
  cb.addEventListener('change', function() {
    // チェックボックスと同じ行を探す
    const row = cb.closest('.role-row');

    // その行の「人工」「残業」の入力欄を全部とる
    const inputs = row.querySelectorAll('input[type="number"]');

    // チェックが入っているかどうか調べる
    if (cb.checked) {
      // チェックされていたら → 入力できるようにする
      inputs.forEach(function(input) {
        input.disabled = false;
      });
    } else {
      // チェックが外れたら → 入力できなくする
      inputs.forEach(function(input) {
        input.disabled = true;
        input.value = "";
      });
    }
  });
});

  return wrap;
}


// 役割を「会社名＋役割」に整形
const roleSuffixMap = { only: '', leader: ' 職長', other: ' 有資格者' };
function partnerDisplayName(name, role) {
  return `${name}${roleSuffixMap[role] || ''}`;
}







//---------------------履歴の協力会社・人工／残業幅設定-----------------------------
//history_viwe.js  514,567行目　History追加
function createPartnerRoleMatrixHistory(nameKey, usedRoles = new Set()) {
  const wrap = document.createElement('div');
  wrap.className = 'partner-role-matrix history';
  wrap.id = `matrix-${nameKey}`;
  wrap.style.display = 'none';

  wrap.innerHTML = `
  <div class="role-row" data-role="general">
    <label><input type="checkbox" name="${nameKey}-general-checked"> 一般作業員</label>
    <div class="work-inputs">
      <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-general-man" disabled>
      <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-general-overtime" disabled>
    </div>
  </div>
  <div class="role-row" data-role="leader">
    <label><input type="checkbox" name="${nameKey}-leader-checked"> 職長</label>
    <div class="work-inputs">
      <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-leader-man" disabled>
      <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-leader-overtime" disabled>
    </div>
  </div>
  <div class="role-row" data-role="qualified">
    <label><input type="checkbox" name="${nameKey}-qualified-checked"> 有資格者</label>
    <div class="work-inputs">
      <input type="number" step="0.25" min="0" placeholder="人工" name="${nameKey}-qualified-man" disabled>
      <input type="number" step="0.25" min="0" placeholder="残業" name="${nameKey}-qualified-overtime" disabled>
    </div>
  </div>
`;

  // 使用済みの役割は行ごと除去（= 入力UIを生成しない）
  ['general', 'leader', 'qualified'].forEach(role => {
    if (usedRoles.has(role)) {
      const row = wrap.querySelector(`.role-row[data-role="${role}"]`);
      if (row) row.remove();
    }
  });

  const checkboxes = wrap.querySelectorAll('.role-row input[type="checkbox"]');

// 1つずつ取り出して処理をつける
checkboxes.forEach(function(cb) {
  cb.addEventListener('change', function() {
    // チェックボックスと同じ行を探す
    const row = cb.closest('.role-row');

    // その行の「人工」「残業」の入力欄を全部とる
    const inputs = row.querySelectorAll('input[type="number"]');

    // チェックが入っているかどうか調べる
    if (cb.checked) {
      // チェックされていたら → 入力できるようにする
      inputs.forEach(function(input) {
        input.disabled = false;
      });
    } else {
      // チェックが外れたら → 入力できなくする
      inputs.forEach(function(input) {
        input.disabled = true;
        input.value = "";
      });
    }
  });
});

  return wrap;
}



//初期状態日付表示なしに変更--------------------------------------------------------------
function toggleDateInput(el) {
  console.log('[toggleDateInput] 開始', { checked: !!el?.checked }); // 処理開始ログ
  const container = document.getElementById('dateContainer');
    if (el.checked) {
      container.style.display = 'block'; // 表示する
    } else {
      container.style.display = 'none';  // 非表示にする
    }
  }

// ページを開いたときの初期設定
  window.addEventListener("DOMContentLoaded", () => {
    const cb = document.getElementById("customDateToggle");
    const container = document.getElementById("dateContainer");
    cb.checked = false;              // チェックを外す
    container.style.display = "none"; // 最初は非表示
  });






//画像スライド---------------------------------------------------------------------------
function enableCarouselPC(viewport, track, width, getIndex, goTo, render, total) {
  let dragging = false, startX = 0, currentX = 0;

  // マウス押下
  viewport.addEventListener('mousedown', (e) => {
    if (!total) return;
    dragging = true;
    startX = currentX = e.clientX;
  });

  // マウス移動
  viewport.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    currentX = e.clientX;
    const dx = currentX - startX;
    const base = -getIndex() * width();
    track.style.transform = `translateX(${base + dx}px)`;
  });

  // マウス離す（windowの方が安全）
  window.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    const dx = currentX - startX;
    const threshold = width() * 0.25;
    if (dx > threshold) goTo(getIndex() - 1);
    else if (dx < -threshold) goTo(getIndex() + 1);
    else render();
  });

  // 外に出たとき
  viewport.addEventListener('mouseleave', () => {
    dragging = false;
  });
}

function createCarousel(previewEl, slideCount) {
    console.log('[createCarousel] start:', { slideCount });

    // ラッパー
    const carousel = document.createElement('div');
    carousel.className = 'carousel';

    // ビューポート & トラック
    const viewport = document.createElement('div');
    viewport.className = 'carousel-viewport';

    const track = document.createElement('div');
    track.className = 'carousel-track';

    viewport.appendChild(track);
    carousel.appendChild(viewport);
    previewEl.appendChild(carousel);

    // ナビ
    const nav = document.createElement('div');
    nav.className = 'carousel-nav';
    const prevBtn = document.createElement('button'); prevBtn.textContent = '◀';
    const nextBtn = document.createElement('button'); nextBtn.textContent = '▶';
    nav.append(prevBtn, nextBtn);
    previewEl.appendChild(nav);

    // ドット
    const dots = document.createElement('div');
    dots.className = 'carousel-dots';
    previewEl.appendChild(dots);

    // スライド枠を先に作る
    const slideImgs = [];
    const dotEls = [];
    for (let i = 0; i < slideCount; i++) {
      const slide = document.createElement('div');
      slide.className = 'carousel-slide';
      const img = document.createElement('img');
      img.alt = `${i + 1}枚目`;
      slide.appendChild(img);
      track.appendChild(slide);
      slideImgs.push(img);

      const dot = document.createElement('div');
      dot.className = 'carousel-dot';
      dots.appendChild(dot);
      dotEls.push(dot);
    }

    // ステート/描画
    let index = 0;
    const total = slideCount;
    const width = () => viewport.clientWidth;

    function render() {
      track.style.transform = `translateX(${-index * width()}px)`;
      prevBtn.disabled = (index === 0);
      nextBtn.disabled = (index === total - 1);
      dotEls.forEach((d, i) => d.classList.toggle('active', i === index));
    }
    function goTo(n) {
      index = Math.max(0, Math.min(total - 1, n));
      render();
    }

    // 操作イベント
    prevBtn.addEventListener('click', () => goTo(index - 1));
    nextBtn.addEventListener('click', () => goTo(index + 1));
    window.addEventListener('resize', render);

    // スワイプ
    let startX = 0, currentX = 0, dragging = false;
    viewport.addEventListener('touchstart', (e) => {
      if (!total) return;
      dragging = true;
      startX = e.touches[0].clientX;
      currentX = startX;
    }, { passive: true });

    viewport.addEventListener('touchmove', (e) => {
      if (!dragging) return;
      currentX = e.touches[0].clientX;
      const dx = currentX - startX;
      const base = -index * width();
      track.style.transform = `translateX(${base + dx}px)`;
    }, { passive: true });

    viewport.addEventListener('touchend', () => {
      if (!dragging) return;
      dragging = false;
      const dx = currentX - startX;
      const threshold = width() * 0.25;
      if (dx > threshold) goTo(index - 1);
      else if (dx < -threshold) goTo(index + 1);
      else render();
    });

    render();

    //PC用スライドの追加
    enableCarouselPC(viewport, track, width, () => index, goTo, render, total);

    const result = { slideImgs, render, goTo };
    console.log('[createCarousel] end ->', result);
    return result;
  }
</script>








<style>
/* ========= ローディング ========= */
#loadingOverlay {
  display: none;
  position: fixed;
  z-index: 10000;
  inset: 0;
  background: rgba(255, 255, 255, .7);
  justify-content: center;
  align-items: center;
}

.loader {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #0066cc;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
}

  @keyframes spin {
  0% {
    transform: rotate(0)
  }

  100% {
    transform: rotate(360deg)
  }
}





/* ========= .role-row ========= */

input[type="text"],
/* input[type="date"], */
select,
#partner,
.partner-role-matrix {
  width: 100%;          /* 画面いっぱい広がる */
  max-width: 800px;     /* でも最大800pxまで */
  margin: 0 auto;       /* 真ん中に寄せる */
  box-sizing: border-box; /* 枠や余白も含めてサイズ計算 */
}

.role-row {
  display: flex;
  align-items: center;
  gap: 14px;
  width: 100%;
  max-width: 800px;                 /* ← 変更: 可変＋最大800px */
  margin: 1rem auto 0.6rem;
  box-sizing: border-box;
}

/* 左ラベル（☑ + 役割名）：全行で同じ幅・大きく太く */
.role-row label {
  flex: 0 0 clamp(160px, 25vw, 220px);
  font-size: 2rem;
  font-weight: 700;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 10px;
  /* チェックボックスとの間 */
}

/* 右側（人工・残業）の器：残り幅を全部使って横並び均等 */
.role-row .work-inputs {
  flex: 1;
  display: flex;
  gap: 16px;
  width: 100%;
  box-sizing: border-box;
}

.partner-role-matrix .work-inputs {
  display: flex;
  gap: 12px;
  width: 100%;              /* フル幅を使う */
  box-sizing: border-box;
}

/* 協力会社の人工・残業だけ幅をそろえる */
.partner-role-matrix .work-inputs input[type="number"] {
  flex:  1 1 0 ;                        /* 残り幅を均等に分ける */
  width: 100%  !important;         /* 固定幅を打ち消す */
  max-width: none !important;     /* 120px制限をリセット */
  font-size: 2rem;
  padding: 1.2rem 1.4rem;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
}


/* プレースホルダも控えめに */
.role-row .work-inputs input::placeholder {
  font-size: 1.8rem;
  color: #9a9a9a;
}


/* 入力不可のときの見た目 */
input:disabled {
  background-color: #eee;   /* 灰色っぽく */
  color: #999;              /* 文字も薄く */
  cursor: not-allowed;      /* マウスカーソルを禁止マークに */
}

/* 有効化されたとき（disabledが外れたら） */
input:enabled {
  background-color: #fff;   /* 白背景 */
  color: #000;              /* 黒文字 */
  cursor: text;             /* 普通の入力カーソル */
}






/* 作業者・協力会社名の横幅を合わせる*/
.checkbox-group {
  width: 100%;            /* bodyのコンテンツ幅にフィット */
  margin: 0;              /* 左右の余白を消す */
  padding: 0;             /* グループ内の余計な内側余白を消す */
  box-sizing: border-box; /* 枠線やpaddingを幅に含める */
}


.checkbox-wrapper {
  display: flex;
  align-items: center;
  gap: .75rem;
  padding: .75rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  background: #fff;
  cursor: pointer;
  font-size: 3.25rem;
  width: 100%;          /* 親要素に合わせる */          /* 親(checkbox-group)の幅いっぱい */
  margin-left: 0;         /* 左右にはみ出さない */
  margin-right: 0;
  box-sizing: border-box;
}

.checkbox-wrapper span {
  font-size: 3.25rem;
  font-weight: 400 !important;
  white-space: nowrap;
}

.checkbox-wrapper input[type="checkbox"]:checked+span {
  color: #0066cc;
  font-size: 3.25rem;
  font-weight: 400 !important;
  font-family: 'Noto Sans JP', sans-serif;
  white-space: nowrap;
}

/* ====== 人工/残業の表示制御 ====== */
/* デフォルトは非表示 */
.time-inputs {
  display: none;
  margin-top: 16px;
}

.role-row.wide {
  max-width: none !important;  /* 800px制限を解除 */
  width: 100% !important;      /* フル幅 */
}


/* 追加入力 (#additionalPartnerInputs) */
#additionalPartnerInputs .partner-role-matrix {
  width: 100% !important;
  max-width: none !important;
  box-sizing: border-box;
}

#historyModal .partner-role-matrix .role-row {
  max-width: none !important;  /* 800px制限を解除 */
  width: 100% !important;      /* モーダル幅いっぱい */
  margin: 1rem 0.5rem;         /* 左右の余白を均等に少しだけ */
  box-sizing: border-box;
}

#historyModal .partner-role-matrix .work-inputs input[type="number"] {
  flex: 1 1 0;
  width: 100% !important;
  max-width: none !important;
}



/* すべての date 入力を幅いっぱいにする */

@media (max-width: 768px) {
  /* 親コンテナも広げる */
  #dateContainer,
  #historyModal {
    width: 100% !important;
    max-width: none !important;
    margin: 0 auto !important;
    padding: 0 !important;
    box-sizing: border-box !important;
  }

  /* 両方の日付入力をまとめて指定 */
  input[type="date"],
  #customDate,
  #modalHistoryDate {
    display: block !important;
    width: 100% !important;       /* 横幅いっぱい */
    max-width: none !important;   /* 800px制限を解除 */
    min-width: 0 !important;
    margin: 0 auto !important;

    box-sizing: border-box !important;
    -webkit-appearance: none !important; /* iOS Safari リセット */
    appearance: none !important;

    font-size: 1.6rem !important;  /* スマホで見やすい文字サイズ */
    padding: 1rem !important;      /* 指でタップしやすく */
  }
}





</style>
