<script>
  let masterData = {};
  let formData = {};
  let isSubmitted = false;

  // ------------------------------------------
  // å…¥åŠ›å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼š0.25å˜ä½ï¼ˆ15åˆ†åˆ»ã¿ï¼‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
  // ------------------------------------------
  function isValidQuarterHour(value) {
    return Number.isFinite(value) && Math.round(value * 100) % 25 === 0;
  }


  // ------------------------------------------
  // éå»æ—¥å…¥åŠ›ã®ON/OFFï¼ˆãƒˆã‚°ãƒ«ï¼‰ã«å¿œã˜ã¦æ—¥ä»˜å…¥åŠ›æ¬„ã®è¡¨ç¤ºåˆ‡æ›¿
  // ------------------------------------------
  function toggleDateInput(el) {
    const button = document.getElementById('dateToggleButton');
    const checked = el.checked;
    document.getElementById('dateContainer').style.display = checked ? 'block' : 'none';
    button.classList.toggle('checked', checked);
  }


  // ------------------------------------------
  // é€ä¿¡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã¨ãã®å‡¦ç†
  // ï¼ˆé€ä¿¡å®Œäº†å¾Œã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ç·¨é›†ä¸­ã¯å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸æˆ»ã™ç­‰ï¼‰
  // ------------------------------------------
  function closeConfirmation() {
    const confirmationText = document.getElementById('confirmationText').textContent;
    const isSent = confirmationText.includes('âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    document.getElementById('confirmationModal').style.display = 'none';

    if (isSent) {
      // é€ä¿¡å®Œäº†å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å ´åˆ
      if (!isEditMode) {
        // æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã ã£ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        resetForm();
      }
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€å®Œäº†å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‹ã ã‘ãªã®ã§ä½•ã‚‚ã—ãªã„
    } else {
      // ã€Œä¿®æ­£ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æˆ»ã‚‹å ´åˆ
      if (isEditMode) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã™ã‚‹ã ã‘ï¼ˆå…¥åŠ›å€¤ãŒä¿æŒã•ã‚Œã¾ã™ï¼‰
        document.getElementById('historyModal').style.display = 'flex';
      }
      // æ–°è¦å…¥åŠ›ã®å ´åˆã¯å…ƒã€…å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ãˆã¦ã„ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„
    }
  }


  // ------------------------------------------
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆUXæ”¹å–„ï¼‰
  // ç·¨é›†ä¸­ã¯å…ƒã®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸æˆ»ã™
  // ------------------------------------------
  function handleModalClickOutside(event) {
    const confirmationBox = document.getElementById('confirmationBox');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†
    if (!confirmationBox.contains(event.target)) {
      const confirmationText = document.getElementById('confirmationText').textContent;
      const isSent = confirmationText.includes('âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
      document.getElementById('confirmationModal').style.display = 'none';

      if (isSent) {
        if (!isEditMode) {
          resetForm();
        }
      } else if (isEditMode) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã€Œä¿®æ­£ã™ã‚‹ã€ãŸã‚ã«æˆ»ã‚‹å ´åˆ
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤ºã™ã‚‹ã ã‘ã«ã™ã‚‹
        document.getElementById('historyModal').style.display = 'flex';
      }
    }
  }

  // ------------------------------------------
  // ç”»é¢å…¨ä½“ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼ˆé€ä¿¡å®Œäº†å¾Œãªã©ã«ä½¿ç”¨ï¼‰
  // ãƒã‚¹ã‚¿ãƒ¼ã‚’ä½¿ã£ã¦ä¼šç¤¾ã‚»ãƒ¬ã‚¯ãƒˆã ã‘ã¯å†æ§‹ç¯‰
  // ------------------------------------------
  function resetForm() {
    document.getElementById('company').selectedIndex = 0;
    document.getElementById('staff').innerHTML = '';
    document.getElementById('site').innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
    document.getElementById('worker').innerHTML = '';
    document.getElementById('partner').innerHTML = '';
    document.getElementById('customDateToggle').checked = false;
    document.getElementById('customDate').value = '';
    toggleDateInput(document.getElementById('customDateToggle'));
    formData = {};
    isSubmitted = false;
    const companySelect = document.getElementById('company');
    companySelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
    masterData.company.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      companySelect.appendChild(opt);
    });
    // âœ… å±¥æ­´ãƒœã‚¿ãƒ³ã®å†æ¥ç¶šï¼ˆHTMLå†æç”»ã§ onclick ãŒæ¶ˆãˆã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦ï¼‰
    const historyBtn = document.getElementById('showHistoryButton');
    if (historyBtn) {
      historyBtn.onclick = () => showHistoryModal();
    }
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’ä»Šæ—¥ã«ã€å†…å®¹ã¯ç©ºã«ï¼‰
  // ------------------------------------------
  function openHistoryModal() {
    document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
    document.getElementById('modalHistoryContent').innerHTML = '';
    document.getElementById('historyModal').style.display = 'flex';
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  // ------------------------------------------
  function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
  }



  // ------------------------------------------
  // ä¼šç¤¾é¸æŠã«å¿œã˜ã¦æ‹…å½“è€…ã‚»ãƒ¬ã‚¯ãƒˆã‚’çµã‚Šè¾¼ã¿ï¼†ç¾å ´ã‚»ãƒ¬ã‚¯ãƒˆã‚‚æ›´æ–°
  // ------------------------------------------
  function updateStaffOptions() {
    const staffSelect = document.getElementById('staff');
    const companyId = document.getElementById('company').value;
    staffSelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';


    if (!companyId) return;


    masterData.staff
      .filter(staff => staff.companies.includes(companyId))
      .forEach(staff => {
        const opt = document.createElement('option');
        opt.value = staff.id;
        opt.textContent = staff.name;
        staffSelect.appendChild(opt);
      });


    updateSiteOptions(); // ã‚¹ã‚¿ãƒƒãƒ•ãŒå¤‰ã‚ã£ãŸã‚‰ç¾å ´ã‚‚å†çµã‚Šè¾¼ã¿
  }


  // ------------------------------------------
  // ä¼šç¤¾ï¼‹æ‹…å½“è€…ã®é¸æŠã«å¿œã˜ã¦ç¾å ´ã‚»ãƒ¬ã‚¯ãƒˆã‚’çµã‚Šè¾¼ã¿
  // ------------------------------------------
  function updateSiteOptions() {
    const staffId = document.getElementById('staff').value;
    const companyId = document.getElementById('company').value;
    const siteSelect = document.getElementById('site');
    siteSelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';


    if (!staffId || !companyId) return;


    masterData.site
      .filter(site => site.staffId === staffId && site.companyIds.includes(companyId))
      .forEach(site => {
        const opt = document.createElement('option');
        opt.value = site.id;
        opt.textContent = site.name;
        siteSelect.appendChild(opt);
      });
  }



  // ------------------------------------------
  // é€ä¿¡ç¢ºå®šå‡¦ç†ï¼šApps Script ã‚µãƒ¼ãƒãƒ¼é–¢æ•° saveFormResponse(formData) ã‚’å‘¼ã¶
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®è¡¨ç¤º/éè¡¨ç¤ºã€å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æãæ›ãˆãªã©
  // ------------------------------------------
  function confirmSend() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    google.script.run.withSuccessHandler(() => {
      isSubmitted = true;
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('confirmationText').textContent = 'âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nåˆ¥ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã£ã¦ãã ã•ã„ã€‚';
      document.querySelector('#confirmationBox .button-row button:nth-child(1)').style.display = 'none';
    }).saveFormResponse(formData);
  }


  // ------------------------------------------
  // åå‰ãªã©ã‚’å®‰å…¨ã«IDåŒ–ã™ã‚‹ãŸã‚ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
  // ------------------------------------------
  function sanitize(str) {
    return str.replace(/[^a-zA-Z0-9\u3040-\u30ff\u4e00-\u9faf]/g, '_');
  }


  // ------------------------------------------
  // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸäººï¼ˆä½œæ¥­è€…/å”åŠ›ä¼šç¤¾ï¼‰ã«ç´ã¥ãã€Œäººå·¥/æ®‹æ¥­ã€å…¥åŠ›æ¬„ã‚’ç”Ÿæˆã—ã¦è¿”ã™
  // ------------------------------------------
  function createTimeInputs(name) {
    const container = document.createElement('div');
    container.className = 'time-inputs';
    container.id = `inputs-${name}`;

    const labelMap = { man: 'äººå·¥', overtime: 'æ®‹æ¥­' };

    ['man', 'overtime'].forEach(type => {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '0.25';
      input.inputMode = 'decimal';
      input.placeholder = labelMap[type];  // å…¥åŠ›æ¬„å†…ã«ã€Œäººå·¥ã€ã€Œæ®‹æ¥­ã€
      input.name = `${name}-${type}`;
      input.dataset.type = type;
      input.dataset.name = name;

      // âœ… ã‚¯ãƒ©ã‚¹åã‚’ worker-input / partner-input ã«å‹•çš„ä»˜ä¸
      const prefix = name.startsWith('modal-worker') ? 'worker' :
        name.startsWith('modal-partner') ? 'partner' : '';
      input.className = `work-input ${prefix}-input`;
      container.appendChild(input);
    });

    return container;
  }



  // ------------------------------------------
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ON/OFFã«å¿œã˜ã¦ã€ãã®è¡Œã®ã€Œäººå·¥/æ®‹æ¥­ã€å…¥åŠ›æ¬„ã®è¡¨ç¤ºåˆ‡æ›¿
  // ------------------------------------------
  function toggleTimeInputs(checkbox, name) {
    const inputs = document.getElementById(`inputs-${name}`);
    if (inputs) inputs.style.display = checkbox.checked ? 'flex' : 'none';
  }


  // ------------------------------------------
  // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼šå…¥åŠ›å€¤ã®æ¤œè¨¼ã¨ formData ã®çµ„ã¿ç«‹ã¦ã€ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  // ------------------------------------------
  function submitForm() {
    // æ—¢å­˜ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    document.querySelectorAll('.error-message').forEach(div => div.textContent = '');
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));


    let hasError = false;
    let firstErrorElement = null;

    // å…¥åŠ›è¦ç´ ã®å‚ç…§
    const companySelect = document.getElementById('company');
    const staffSelect = document.getElementById('staff');
    const siteSelect = document.getElementById('site');
    const customDateToggle = document.getElementById('customDateToggle');
    const customDate = document.getElementById('customDate');

    // å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆä¼šç¤¾/æ‹…å½“/ç¾å ´/æ—¥ä»˜ï¼‰
    if (!companySelect.value) {
      document.getElementById('error-company').textContent = 'â€»å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      companySelect.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = companySelect;
    }
    if (!staffSelect.value) {
      document.getElementById('error-staff').textContent = 'â€»TTCæ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      staffSelect.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = staffSelect;
    }
    if (!siteSelect.value) {
      document.getElementById('error-site').textContent = 'â€»ç¾å ´åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
      siteSelect.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = siteSelect;
    }
    if (customDateToggle.checked && !customDate.value) {
      document.getElementById('error-date').textContent = 'â€»å‡ºé¢æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      customDate.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = customDate;
    }


    const workerGroup = document.getElementById('worker');
    const partnerGroup = document.getElementById('partner');
    let workerChecked = false;
    let partnerChecked = false;

    // formData ã®ä¸‹åœ°ã‚’ä½œæˆ
    formData = {
      companyId: companySelect.value,
      staffId: staffSelect.value,
      site: siteSelect.value,
      date: customDateToggle.checked ? customDate.value : '',
      workers: [],
      partners: []
    };

    // ä½œæ¥­è€…ã®ãƒã‚§ãƒƒã‚¯è¡Œã‚’åé›†
    document.querySelectorAll("input[name='worker']:checked").forEach(cb => {
      workerChecked = true;
      const name = cb.value;
      const safeName = sanitize(name);
      const prefix = `worker-${safeName}`;
      // const inputs = ['day', 'evening', 'night', 'overtime'].map(type => {
      const inputs = ['man', 'overtime'].map(type => {
        const el = document.querySelector(`input[name='${prefix}-${type}']`);
        return { el, value: parseFloat(el?.value || 0) };
      });
      let total = 0;
      let invalid = false;
      inputs.forEach(({ el, value }) => {
        total += value;
        if (value && !isValidQuarterHour(value)) {
          el.classList.add('input-error');
          invalid = true;
        }
      });
      if (total === 0 || invalid) {
        document.getElementById('error-worker').textContent = invalid
          ? 'â€»å‹¤å‹™æ™‚é–“ã¯0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
          : 'â€»ä½œæ¥­è€…ã®å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        workerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = workerGroup;
      }
      // formData.workers.push({ name, day: inputs[0].value, evening: inputs[1].value, night: inputs[2].value, overtime: inputs[3].value });
      formData.workers.push({ name, man: inputs[0].value, overtime: inputs[1].value });
    });

    // ä½œæ¥­è€…ã®ãƒã‚§ãƒƒã‚¯è¡Œã‚’åé›†
    document.querySelectorAll("input[name='partner']:checked").forEach(cb => {
      partnerChecked = true;
      const name = cb.value;
      const safeName = sanitize(name);
      const prefix = `partner-${safeName}`;
      // const inputs = ['day', 'evening', 'night', 'overtime'].map(type => {
      const inputs = ['man', 'overtime'].map(type => {
        const el = document.querySelector(`input[name='${prefix}-${type}']`);
        return { el, value: parseFloat(el?.value || 0) };
      });

      // åˆè¨ˆ/åˆ»ã¿ã®æ¤œè¨¼
      let total = 0;
      let invalid = false;
      inputs.forEach(({ el, value }) => {
        total += value;
        if (value && !isValidQuarterHour(value)) {
          el.classList.add('input-error');
          invalid = true;
        }
      });
      if (total === 0 || invalid) {
        document.getElementById('error-partner').textContent = invalid
          ? 'â€»å‹¤å‹™æ™‚é–“ã¯0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
          : 'â€»å”åŠ›ä¼šç¤¾åã®å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        partnerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = partnerGroup;
      }
      // formData.partners.push({ name, day: inputs[0].value, evening: inputs[1].value, night: inputs[2].value, overtime: inputs[3].value });
      formData.partners.push({ name, man: inputs[0].value, overtime: inputs[1].value });
    });

    // ä½œæ¥­è€…ãƒ»å”åŠ›ä¼šç¤¾ã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã§ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (!workerChecked && !partnerChecked) {
      document.getElementById('error-worker').textContent = 'â€»ä½œæ¥­è€…ã¾ãŸã¯å”åŠ›ä¼šç¤¾ã‚’1ä»¶ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚';
      document.getElementById('error-partner').textContent = 'â€»ä½œæ¥­è€…ã¾ãŸã¯å”åŠ›ä¼šç¤¾ã‚’1ä»¶ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚';
      workerGroup.classList.add('input-error');
      partnerGroup.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = workerGroup;
    }


    if (hasError) {
      if (firstErrorElement) {
        firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }


    showConfirmation(false);
  }

  let isEditMode = false;


  // ------------------------------------------
  // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºï¼†å†…å®¹çµ„ã¿ç«‹ã¦
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’å¤‰æ›´
  // ------------------------------------------
// â˜… submitForm ã®å¤–ã«ç½®ãï¼ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
function showConfirmation(isEdit = false) {
  console.log('[showConfirmation] start isEdit=', isEdit, 'formData=', JSON.parse(JSON.stringify(formData)));

  const box = document.getElementById('confirmationBox');
  box.classList.remove('compact');
  isEditMode = isEdit;

  const company = masterData.company.find(c => c.id === formData.companyId)?.name || 'ï¼ˆæœªé¸æŠï¼‰';
  const staff   = masterData.staff.find(s => s.id === formData.staffId)?.name || 'ï¼ˆæœªé¸æŠï¼‰';
  const site    = masterData.site.find(s => s.id === formData.site)?.name || 'ï¼ˆæœªé¸æŠï¼‰';

  // å½¹å‰² â†’ è¡¨ç¤ºã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹
  const roleSuffix = { only: '', leader: 'ï¼‹è·é•·', other: 'ï¼‹æœ‰è³‡æ ¼è€…' };

  const styleValueWithLabel = (label, value, isOvertime = false) => {
    const unit = isOvertime ? 'h' : 'äººå·¥';
    const display = value && value > 0
      ? `<span style="color: red; font-weight: bold;">${value}${unit}</span>`
      : `<span style="color: #999;">0${unit}</span>`;
    return `${label}ï¼š${display}`;
  };

  let message = `å‡ºé¢æ—¥ä»˜ï¼š${formData.date || new Date().toLocaleDateString('ja-JP')}<br>
å…ƒè«‹ä¼šç¤¾ï¼š${company}<br>
TTCæ‹…å½“è€…ï¼š${staff}<br>
ç¾å ´åï¼š${site}`;

  if (formData.workers?.length) {
    message += `<br><br><strong>ä½œæ¥­è€…ï¼š</strong>`;
    formData.workers.forEach(w => {
      message += `<br>ã€€${w.name}ï¼ˆ${styleValueWithLabel('äººå·¥', w.man)} ${styleValueWithLabel('æ®‹æ¥­', w.overtime, true)}ï¼‰`;
    });
  }

  if (formData.partners?.length) {
    message += `<br><br><strong>å”åŠ›ä¼šç¤¾ï¼š</strong>`;
    formData.partners.forEach(p => {
      const dispName = `${p.name}${roleSuffix[p.role] ?? ''}`; // â˜… ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹
      message += `<br>ã€€${dispName}ï¼ˆ${styleValueWithLabel('äººå·¥', p.man)} ${styleValueWithLabel('æ®‹æ¥­', p.overtime, true)}ï¼‰`;
    });
  }

  document.getElementById('confirmationText').innerHTML = message;
  document.getElementById('confirmationModal').style.display = 'flex';

  const buttonRow = document.querySelector('#confirmationBox .button-row');
  buttonRow.innerHTML = isEdit
    ? `
      <button type="button" onclick="submitEditFromModal()">âœ… ç¢ºå®šã—ã¦ç·¨é›†å†…å®¹ã‚’é€ä¿¡</button>
      <button onclick="closeConfirmation()">â† ä¿®æ­£ã™ã‚‹</button>
    `
    : `
      <button onclick="confirmSend()">âœ… ç¢ºå®šã—ã¦é€ä¿¡</button>
      <button onclick="closeConfirmation()">æˆ»ã‚‹</button>
    `;

  console.log('[showConfirmation] end');
}
  }

  // function loadPreviousRecords() {
  //   const date = document.getElementById('customDate').value;
  //   const companyId = document.getElementById('company').value;
  //   const staffId = document.getElementById('staff').value;
  //   const siteId = document.getElementById('site').value;
  //
  //   if (!date || !companyId || !staffId || !siteId) {
  //     document.getElementById('historyRecords').innerHTML = '<em>å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</em>';
  //     return;
  //   }
  //
  //   google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
  // }
  // ------------------------------------------
  // ç”»é¢å†…ã®ã€Œå±¥æ­´ã€æ¬„ã«ã€æŒ‡å®šæ¡ä»¶ã§éå»ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  // ------------------------------------------
  function loadPreviousRecords() {
    const date = document.getElementById('historyDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;

    const container = document.getElementById('historyRecords');

    if (date && companyId && staffId && siteId) {
      // âœ… å³ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºï¼ˆèª­ã¿è¾¼ã¿ä¸­ï¼‰
      container.innerHTML = '<em style="color: gray;">ğŸ“‚ é€ä¿¡å±¥æ­´ã‚’å–å¾—ä¸­ã§ã™...</em>';

      // éåŒæœŸå‘¼ã³å‡ºã—
      google.script.run.withSuccessHandler(displayHistory).getPreviousRecords(date, companyId, staffId, siteId);
    } else {
      container.innerHTML = '<em style="color: gray;">â€»é€ä¿¡å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯å±¥æ­´å¯¾è±¡æ—¥ä»˜ãƒ»å…ƒè«‹ãƒ»æ‹…å½“è€…ãƒ»ç¾å ´ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚</em>';
    }
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«å´ã§éå»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨è¡¨ç¤º
  // ------------------------------------------
  function loadModalHistory() {
    const date = document.getElementById('modalHistoryDate').value;
    const companyId = document.getElementById('company').value;
    const staffId = document.getElementById('staff').value;
    const siteId = document.getElementById('site').value;
    const container = document.getElementById('modalHistoryContent');

    if (!date || !companyId || !staffId || !siteId) {
      container.innerHTML = '<em style="color:red;">ã™ã¹ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ãƒ»æ‹…å½“ãƒ»ç¾å ´ãƒ»æ—¥ä»˜ï¼‰</em>';
      return;
    }

    document.getElementById('loadingOverlay').style.display = 'flex'; // âœ… è¡¨ç¤ºON
    container.innerHTML = ''; // å†…å®¹åˆæœŸåŒ–

    google.script.run.withSuccessHandler(records => {
      document.getElementById('loadingOverlay').style.display = 'none'; // âœ… è¡¨ç¤ºOFF
      lastFetchedRecords = records;
      if (records.length === 0) {
        container.innerHTML = '<em>å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
        return;
      }

      let html = '<table style="width:100%; border-collapse: collapse;">';
      html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
      records.forEach(r => {
        html += `<tr>
        <td>${r.type}</td>
        <td>${r.name}</td>
        <td>${r.man}</td>
        <td>${r.overtime}</td>
      </tr>`;
      });
      html += '</table>';
      html += `<button onclick="showEditFormInModal()">ç·¨é›†ã™ã‚‹</button>`;
      container.innerHTML = html;
    }).getPreviousRecords(date, companyId, staffId, siteId);
  }

  let lastFetchedRecords = [];



  // ------------------------------------------
  // ç”»é¢ã®ã€Œå±¥æ­´ã€æ¬„ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ï¼‰ã«è¡¨ã‚’æç”»
  // ------------------------------------------
  function displayHistory(records) {
    const container = document.getElementById('historyRecords');
    const editButton = document.getElementById('editButton');
    lastFetchedRecords = records;

    if (!records || records.length === 0) {
      container.innerHTML = '<em>å±¥æ­´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</em>';
      editButton.style.display = 'none';
      return;
    }

    let html = '<table style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    records.forEach(r => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td>${r.man}</td>
      <td>${r.overtime}</td>
    </tr>`;
    });
    html += '</table>';
    container.innerHTML = html;

    editButton.style.display = 'inline-block'; // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  }


  // ------------------------------------------
  // ç”»é¢å†…ã®å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã€Œç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã€ã«åˆ‡æ›¿è¡¨ç¤º
  // ------------------------------------------
  function showEditForm() {
    const container = document.getElementById('editFormContainer');
    if (!lastFetchedRecords || lastFetchedRecords.length === 0) return;

    let html = '<h3>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h3>';
    html += '<table style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    lastFetchedRecords.forEach((r, i) => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td><input type="number" step="0.25" value="${r.day}" id="edit-day-${i}" /></td>
      <td><input type="number" step="0.25" value="${r.evening}" id="edit-evening-${i}" /></td>
      <td><input type="number" step="0.25" value="${r.night}" id="edit-night-${i}" /></td>
      <td><input type="number" step="0.25" value="${r.overtime}" id="edit-overtime-${i}" /></td>
    </tr>`;
    });
    html += '</table>';
    html += `<button onclick="submitEdit()">å†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰</button>`;

    container.innerHTML = html;
  }


  // ------------------------------------------
  // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’æç”»ï¼ˆã“ã¡ã‚‰ãŒå®Ÿé‹ç”¨ã®ãƒ¡ã‚¤ãƒ³ï¼‰
  // + è¿½åŠ ã®ä½œæ¥­è€…/å”åŠ›ä¼šç¤¾å…¥åŠ›æ¬„ã‚‚æç”»
  // ------------------------------------------
  function showEditFormInModal() {
    const container = document.getElementById('modalHistoryContent');

    let html = '<h3>ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ </h3>';
    html += '<table style="width:100%; border-collapse: collapse;">';
    // html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>æ—¥å‹¤</th><th>å¤•å‹¤</th><th>å¤œå‹¤</th><th>æ®‹æ¥­</th></tr>';
    html += '<tr><th>ç¨®åˆ¥</th><th>åå‰</th><th>äººå·¥</th><th>æ®‹æ¥­</th></tr>';
    lastFetchedRecords.forEach((r, i) => {
      html += `<tr>
      <td>${r.type}</td>
      <td>${r.name}</td>
      <td><input type="number" step="0.25" class="work-input" placeholder="äººå·¥" value="${r.man}" id="edit-man-${i}" /></td>
      <td><input type="number" step="0.25" class="work-input" placeholder="æ®‹æ¥­" value="${r.overtime}" id="edit-overtime-${i}" /></td>

    </tr>`;
    });
    html += '</table>';
    html += `<button onclick="showEditConfirmationModal()">å†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰</button>`;
    container.innerHTML = html;
    renderAdditionalInputs(); // âœ… å±¥æ­´å¤–ã®è¿½åŠ å€™è£œã‚’è¡¨ç¤º
  }


  // ------------------------------------------
  // ç”»é¢å†…ã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å†é€ä¿¡ï¼ˆæ—§UIå‘ã‘ï¼‰
  // ------------------------------------------
  function submitEdit() {
    const edited = lastFetchedRecords.map((r, i) => ({
      ...r,
      man: parseFloat(document.getElementById(`edit-man-${i}`).value || 0),
      overtime: parseFloat(document.getElementById(`edit-overtime-${i}`).value || 0),
    }));

    const meta = {
      date: document.getElementById('customDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      siteId: document.getElementById('site').value,
    };

    google.script.run.withSuccessHandler(() => {
      document.getElementById('loadingOverlay').style.display = 'none'; // ğŸ”„ è¿½åŠ 
      alert("å†é€ä¿¡ã—ã¾ã—ãŸï¼");
      loadPreviousRecords();
      document.getElementById('editFormContainer').innerHTML = '';
    }).updateEditedRecords(meta, edited);
  }

  // ------------------------------------------
  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®ã€Œå†é€ä¿¡ï¼ˆæ›´æ–°ï¼‰ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ï¼š
  // å…¥åŠ›æ¤œè¨¼â†’formDataçµ„ã¿ç«‹ã¦â†’ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã¸
  // ------------------------------------------
  function showEditConfirmationModal() {
    isEditMode = true;
    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    document.querySelectorAll('.edit-error-message').forEach(el => el.remove());

    let hasError = false;
    const editedRecords = []; // æ›´æ–°å¾Œã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—

    // --- 1. æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† ---
    lastFetchedRecords.forEach((r, i) => {
      const manInput = document.getElementById(`edit-man-${i}`);
      const overtimeInput = document.getElementById(`edit-overtime-${i}`);

      if (!manInput || !overtimeInput) return; // å¿µã®ãŸã‚è¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯

      const man = parseFloat(manInput.value || 0);
      const overtime = parseFloat(overtimeInput.value || 0);
      let isRowInvalid = false;

      // 0.25å˜ä½ãƒã‚§ãƒƒã‚¯
      [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
          input.classList.add('input-error');
          const errMsg = document.createElement('div');
          errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          errMsg.className = 'edit-error-message';
          errMsg.style.color = 'red';
          input.parentElement.appendChild(errMsg);
          hasError = true;
          isRowInvalid = true;
        }
      });

      if (!isRowInvalid) {
        editedRecords.push({ ...r, man, overtime });
      }
    });

    // --- 2. è¿½åŠ ä½œæ¥­è€…ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† ---
    document.querySelectorAll('.additional-worker:checked').forEach(cb => {
      const name = cb.value;
      const safeName = sanitize(name);
      // dataset ã‚’ä½¿ã£ã¦æ­£ã—ãè¦ç´ ã‚’å–å¾—
      const manInput = document.querySelector(`input[data-name="modal-worker-${safeName}"][data-type="man"]`);
      const overtimeInput = document.querySelector(`input[data-name="modal-worker-${safeName}"][data-type="overtime"]`);

      if (!manInput || !overtimeInput) return;

      const man = parseFloat(manInput.value || 0);
      const overtime = parseFloat(overtimeInput.value || 0);
      let isRowInvalid = false;

      // åˆè¨ˆ0ãƒã‚§ãƒƒã‚¯
      if ((man + overtime) <= 0) {
        [manInput, overtimeInput].forEach(input => input.classList.add('input-error'));
        const errMsg = document.createElement('div');
        errMsg.className = 'edit-error-message';
        errMsg.textContent = 'â€»å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        errMsg.style.color = 'red';
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ 
        manInput.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
        hasError = true;
        isRowInvalid = true;
      }

      // 0.25å˜ä½ãƒã‚§ãƒƒã‚¯
      [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
          input.classList.add('input-error');
          // æ—¢ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã‘ã‚Œã°è¿½åŠ 
          if (!manInput.closest('.checkbox-wrapper').querySelector('.edit-error-message')) {
            const errMsg = document.createElement('div');
            errMsg.className = 'edit-error-message';
            errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            errMsg.style.color = 'red';
            input.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
          }
          hasError = true;
          isRowInvalid = true;
        }
      });

      if (!isRowInvalid) {
        editedRecords.push({ type: 'ä½œæ¥­è€…', name, man, overtime });
      }
    });

    // --- 3. è¿½åŠ å”åŠ›ä¼šç¤¾ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿åé›† (ä½œæ¥­è€…ã¨ã»ã¼åŒã˜) ---
    document.querySelectorAll('.additional-partner:checked').forEach(cb => {
      const name = cb.value;
      const safeName = sanitize(name);
      const manInput = document.querySelector(`input[data-name="modal-partner-${safeName}"][data-type="man"]`);
      const overtimeInput = document.querySelector(`input[data-name="modal-partner-${safeName}"][data-type="overtime"]`);

      if (!manInput || !overtimeInput) return;

      const man = parseFloat(manInput.value || 0);
      const overtime = parseFloat(overtimeInput.value || 0);
      let isRowInvalid = false;

      if ((man + overtime) <= 0) {
        [manInput, overtimeInput].forEach(input => input.classList.add('input-error'));
        const errMsg = document.createElement('div');
        errMsg.className = 'edit-error-message';
        errMsg.textContent = 'â€»å‹¤å‹™æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        errMsg.style.color = 'red';
        manInput.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
        hasError = true;
        isRowInvalid = true;
      }

      [manInput, overtimeInput].forEach(input => {
        const val = parseFloat(input.value || 0);
        if (input.value && !isValidQuarterHour(val)) {
          input.classList.add('input-error');
          if (!manInput.closest('.checkbox-wrapper').querySelector('.edit-error-message')) {
            const errMsg = document.createElement('div');
            errMsg.className = 'edit-error-message';
            errMsg.textContent = 'â€»0.25å˜ä½ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            errMsg.style.color = 'red';
            input.closest('.time-inputs').insertAdjacentElement('afterend', errMsg);
          }
          hasError = true;
          isRowInvalid = true;
        }
      });

      if (!isRowInvalid) {
        editedRecords.push({ type: 'å”åŠ›ä¼šç¤¾', name, man, overtime });
      }
    });

    // --- 4. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã«å¿œã˜ã¦å‡¦ç† ---
    if (hasError) {
      // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¾ã¾å‡¦ç†ã‚’ä¸­æ–­
      return;
    }

    // --- 5. ã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã®ã¿ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ç¢ºèªç”»é¢ã¸ ---
    document.getElementById('historyModal').style.display = 'none';

    // é€ä¿¡ç”¨ã®formDataã‚’æ§‹ç¯‰
    formData = {
      date: document.getElementById('modalHistoryDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      site: document.getElementById('site').value,
      workers: editedRecords.filter(r => r.type === 'ä½œæ¥­è€…').map(({ name, man, overtime }) => ({ name, man, overtime })),
      partners: editedRecords.filter(r => r.type === 'å”åŠ›ä¼šç¤¾').map(({ name, man, overtime }) => ({ name, man, overtime }))
    };

    // ç¢ºèªç”»é¢ã‚’è¡¨ç¤º
    showConfirmation(true);
  }



  // ------------------------------------------
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«â†’ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«â†’é€ä¿¡ã®æœ€çµ‚æ®µéš
  // å®Ÿéš›ã« updateEditedRecords(meta, edited) ã‚’å‘¼ã³å‡ºã™
  // ------------------------------------------
  function submitEditFromModal() {
    document.getElementById('loadingOverlay').style.display = 'flex';

    const edited = [];
    lastFetchedRecords.forEach((r, i) => {
      const manInput = document.getElementById(`edit-man-${i}`);
      const overtimeInput = document.getElementById(`edit-overtime-${i}`);
      if (manInput && overtimeInput) {
        edited.push({
          ...r,
          man: parseFloat(manInput.value || 0),
          overtime: parseFloat(overtimeInput.value || 0),
        });
      }
    });

    document.querySelectorAll('.additional-worker:checked').forEach(cb => {
      const name = cb.value;
      const safeName = sanitize(name);
      const inputs = document.querySelectorAll(`.worker-input[data-name="modal-worker-${safeName}"]`);
      const entry = { type: 'ä½œæ¥­è€…', name };
      inputs.forEach(input => {
        const raw = input.value;
        entry[input.dataset.type] = raw === '' ? 0 : parseFloat(raw);
      });
      edited.push(entry);
    });

    document.querySelectorAll('.additional-partner:checked').forEach(cb => {
      const name = cb.value;
      const safeName = sanitize(name);
      const inputs = document.querySelectorAll(`.partner-input[data-name="modal-partner-${safeName}"]`);
      const entry = { type: 'å”åŠ›ä¼šç¤¾', name };
      inputs.forEach(input => {
        const raw = input.value;
        entry[input.dataset.type] = raw === '' ? 0 : parseFloat(raw);
      });
      edited.push(entry);
    });

    const meta = {
      date: document.getElementById('modalHistoryDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      siteId: document.getElementById('site').value,
    };

    google.script.run.withSuccessHandler(() => {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('confirmationText').textContent = 'âœ… é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nåˆ¥ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã£ã¦ãã ã•ã„ã€‚';

      // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’ã€Œé–‰ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã§ä¸Šæ›¸ã
      const buttonRow = document.querySelector('#confirmationBox .button-row');
      buttonRow.innerHTML = '<button onclick="closeConfirmation()">é–‰ã˜ã‚‹</button>';

      setTimeout(() => {
        if (isEditMode) {
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã®é€ä¿¡ãŒå®Œäº†ã—ãŸã‚‰ã€å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
          document.getElementById('historyModal').style.display = 'none';
        }
      }, 300);

    }).updateEditedRecords(meta, edited);
  }

  /*
  function deleteRecord(index) {
    const confirmDelete = confirm(`ã€Œ${lastFetchedRecords[index].name}ã€ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
    if (!confirmDelete) return;

    const meta = {
      date: document.getElementById('modalHistoryDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      siteId: document.getElementById('site').value,
    };

    const record = lastFetchedRecords[index];

    google.script.run.withSuccessHandler(() => {
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      closeHistoryModal(); // ä¸€åº¦é–‰ã˜ã¦
      openHistoryModal();  // å†èª­ã¿è¾¼ã¿
    }).deleteRecordFromSheet(meta, record);
  }
  */


  // ------------------------------------------
  // ï¼ˆæ—§UIï¼‰ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®ç¢ºå®šé€ä¿¡
  // ------------------------------------------
  function confirmEditSend() {
    const edited = lastFetchedRecords.map((r, i) => ({
      ...r,
      day: parseFloat(document.getElementById(`edit-day-${i}`).value || 0),
      evening: parseFloat(document.getElementById(`edit-evening-${i}`).value || 0),
      night: parseFloat(document.getElementById(`edit-night-${i}`).value || 0),
      overtime: parseFloat(document.getElementById(`edit-overtime-${i}`).value || 0),
    }));

    // è¿½åŠ ãƒã‚§ãƒƒã‚¯åˆ†ã‚‚å«ã‚€å ´åˆã“ã“ã«è¿½åŠ OK

    const meta = {
      date: document.getElementById('modalHistoryDate').value,
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      siteId: document.getElementById('site').value,
    };

    document.getElementById('loadingOverlay').style.display = 'flex';

    google.script.run.withSuccessHandler(() => {
      document.getElementById('loadingOverlay').style.display = 'none';
      alert("é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
      closeConfirmation();
      closeHistoryModal();
    }).updateEditedRecords(meta, edited);
  }


  // ------------------------------------------
  // æ‹…å½“è€…é¸æŠã«å¿œã˜ã¦ã€ä½œæ¥­è€…/å”åŠ›ä¼šç¤¾ã®å€™è£œãƒªã‚¹ãƒˆã‚’æç”»
  // ï¼ˆå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹é–‰ã™ã‚‹ã¨å€™è£œãŒå¤‰ã‚ã‚‹ãŸã‚ã€ãã®éƒ½åº¦æ›´æ–°ï¼‰
  // ------------------------------------------
  function updateWorkerAndPartner() {
    const staffId = document.getElementById('staff').value;


    const workerContainer = document.getElementById('worker');
    const partnerContainer = document.getElementById('partner');
    workerContainer.innerHTML = '';
    partnerContainer.innerHTML = '';
    const registeredNames = new Set(lastFetchedRecords.map(r => `${r.type}:${r.name}`));  // ä½œæ¥­è€…:å±±ç”° ãªã©


    // ä½œæ¥­è€…ã®è¡¨ç¤º
    masterData.worker
      .filter(w => w.staffIds.includes(staffId))
      .filter(w => !registeredNames.has(`ä½œæ¥­è€…:${w.name}`))  // âœ… ç™»éŒ²æ¸ˆã¯é™¤å¤–
      .forEach(w => {
        const safeName = sanitize(w.name);
        const wrapper = document.createElement('label');
        wrapper.className = 'checkbox-wrapper';


        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'worker';
        checkbox.value = w.name;
        checkbox.onchange = () => toggleTimeInputs(checkbox, `worker-${safeName}`);


        const span = document.createElement('span');
        span.textContent = w.name;


        wrapper.appendChild(checkbox);
        wrapper.appendChild(span);
        workerContainer.appendChild(wrapper);
        workerContainer.appendChild(createTimeInputs(`worker-${safeName}`));
      });


    // âœ… å”åŠ›ä¼šç¤¾ã®è¡¨ç¤ºï¼ˆé–¢æ•°å†…ã«å«ã‚ã‚‹ã“ã¨ï¼ï¼‰
    masterData.partner
      .filter(p => p.staffIds.includes(staffId))
      .filter(p => !registeredNames.has(`å”åŠ›ä¼šç¤¾:${p.name}`))  // âœ… ç™»éŒ²æ¸ˆã¯é™¤å¤–
      .forEach(p => {
        const safeName = sanitize(p.name);
        const wrapper = document.createElement('label');
        wrapper.className = 'checkbox-wrapper';


        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'partner';
        checkbox.value = p.name;
        checkbox.onchange = () => toggleTimeInputs(checkbox, `partner-${safeName}`);


        const span = document.createElement('span');
        span.textContent = p.name;


        wrapper.appendChild(checkbox);
        wrapper.appendChild(span);
        partnerContainer.appendChild(wrapper);
        partnerContainer.appendChild(createTimeInputs(`partner-${safeName}`));
      });
  }


  // ------------------------------------------
  // åˆæœŸåŒ–ï¼šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ãƒã‚¹ã‚¿å–å¾—ï¼†å„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»•è¾¼ã‚€
  // â€» ã“ã“ã¯ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã¿ã€å‹•ãé ˜åŸŸï¼ˆwindow, document ã‚’ä½¿ã†ãŸã‚ï¼‰
  // ------------------------------------------
  // window.onload = function () {
  //   google.script.run.withSuccessHandler(data => {
  //     masterData = data;

  //     // å…ƒè«‹ä¼šç¤¾ã®ã‚»ãƒ¬ã‚¯ãƒˆä½œæˆ
  //     const companySelect = document.getElementById('company');
  //     companySelect.innerHTML = '<option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>';
  //     masterData.company.forEach(c => {
  //       const opt = document.createElement('option');
  //       opt.value = c.id;
  //       opt.textContent = c.name;
  //       companySelect.appendChild(opt);
  //     });

  //     // æ‹…å½“è€…ãƒ»ç¾å ´åãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  //     document.getElementById("company").addEventListener("change", updateStaffOptions);
  //     document.getElementById("company").addEventListener("change", updateSiteOptions);
  //     document.getElementById("staff").addEventListener("change", updateSiteOptions);
  //     document.getElementById("staff").addEventListener("change", updateWorkerAndPartner);

  //     // âœ… ç·¨é›†æ©Ÿèƒ½ãªã©è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
  //     const historyDateInput = document.getElementById("historyDate");
  //     if (historyDateInput) {
  //       historyDateInput.addEventListener("change", loadPreviousRecords);
  //     }
  //   }).getMasterData();
  // };


  // ------------------------------------------
  // ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰é–‹ã/é–‰ã˜ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ã¨ã€å€™è£œã®å†æç”»
  // ------------------------------------------
  function openHistoryModal() {
    document.getElementById('modalHistoryDate').value = new Date().toISOString().split("T")[0];
    document.getElementById('modalHistoryContent').innerHTML = '';
    document.getElementById('historyModal').style.display = 'flex';
  }



  function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
    updateWorkerAndPartner();  // âœ… é–‰ã˜ãŸã‚‰å€™è£œæ›´æ–°
  }


  // ------------------------------------------
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸‹éƒ¨ã®ã€Œæ–°è¦è¿½åŠ ã€ç”¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼†å…¥åŠ›æ¬„ã‚’æç”»
  // æ—¢ã«è¡¨ã«è¼‰ã£ã¦ã„ã‚‹äººã¯å€™è£œã‹ã‚‰é™¤å¤–
  // ------------------------------------------
  function renderAdditionalInputs() {
    const workerContainer = document.getElementById('additionalWorkerInputs');
    const partnerContainer = document.getElementById('additionalPartnerInputs');
    workerContainer.innerHTML = '';
    partnerContainer.innerHTML = '';

    const staffId = document.getElementById('staff').value;
    if (!staffId) return;

    const registered = new Set(lastFetchedRecords.map(r => `${r.type}:${r.name}`));

    // ğŸ”½ ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è€…ï¼å”åŠ›ä¼šç¤¾ã®åå‰ã‚‚é™¤å¤–å¯¾è±¡ã«è¿½åŠ 
    document.querySelectorAll('#edit-table tbody tr').forEach(row => {
      const type = row.querySelector('td:nth-child(1)').textContent.trim();
      const name = row.querySelector('td:nth-child(2)').textContent.trim();
      registered.add(`${type}:${name}`);
    });

    const createCheckboxBlock = (type, name, container) => {
      const safeName = sanitize(name);
      const wrapper = document.createElement('label');
      wrapper.className = 'checkbox-wrapper';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = `additional-${type}`;
      checkbox.value = name;
      checkbox.onchange = () => toggleTimeInputs(checkbox, `modal-${type}-${safeName}`);

      const span = document.createElement('span');
      span.textContent = name;

      wrapper.appendChild(checkbox);
      wrapper.appendChild(span);
      container.appendChild(wrapper);

      const inputs = createTimeInputs(`modal-${type}-${safeName}`);
      container.appendChild(inputs);
    };

    // âœ… ä½œæ¥­è€…ã®è¦‹å‡ºã—
    // const workerHeader = document.createElement('h4');
    // workerHeader.textContent = 'ä½œæ¥­è€…';
    // workerContainer.appendChild(workerHeader);

    masterData.worker
      .filter(w => w.staffIds.includes(staffId))
      .filter(w => !registered.has(`ä½œæ¥­è€…:${w.name}`)) // âœ… é‡è¤‡å›é¿
      .forEach(w => createCheckboxBlock('worker', w.name, workerContainer));

    // âœ… å”åŠ›ä¼šç¤¾ã®è¦‹å‡ºã—
    // const partnerHeader = document.createElement('h4');
    // partnerHeader.textContent = 'å”åŠ›ä¼šç¤¾';
    // partnerContainer.appendChild(partnerHeader);

    masterData.partner
      .filter(p => p.staffIds.includes(staffId))
      .filter(p => !registered.has(`å”åŠ›ä¼šç¤¾:${p.name}`)) // âœ… é‡è¤‡å›é¿
      .forEach(p => createCheckboxBlock('partner', p.name, partnerContainer));
  }

  // ------------------------------------------
  // ã‚·ãƒ³ãƒ—ãƒ«ãªé–‹é–‰ãƒˆã‚°ãƒ«ï¼ˆè¦‹å‡ºã—ã‚¯ãƒªãƒƒã‚¯ã§ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹é–‰ï¼‰
  // ------------------------------------------
  function toggleSection(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const isShown = el.style.display === 'block';
    el.style.display = isShown ? 'none' : 'block';
  }
</script>
