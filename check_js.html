<script>

  // ------------------------------------------
  // 編集モーダル→確認モーダル→送信の最終段階
  // 実際に updateEditedRecords(meta, edited) を呼び出す
  // ------------------------------------------

  function submitEditFromModal() {
    console.log('[submitEditFromModal] 開始'); // 処理開始ログ
    document.getElementById('loadingOverlay').style.display = 'flex';

    // ★ここで協力会社の状態をダンプ
    __debugDumpPartners();

    // ★ここでサニタイズ衝突をチェック
    __debugCheckSanitizeCollision();

    // 1) 既存行の編集値を収集
    const edited = [];
    (window.lastFetchedRecords || []).forEach((r, i) => {
      const manInput = document.getElementById(`edit-man-${i}`);
      const overtimeInput = document.getElementById(`edit-overtime-${i}`);
      if (!manInput || !overtimeInput) return;

      // （任意）協力会社の役割も拾っておく（保存は会社名のまま）
      let role = r.role || 'only';
      if (r.type === '協力会社') {
        const safe = sanitize(r.name);
        const sel = document.querySelector(`input[name="edit-partner-${safe}-role"]:checked`);
        if (sel) role = sel.value;
      }

      const row = {
        type: r.type,
        name: r.name,                                 // ★保存は会社名そのまま
        role,                                         // （使わないならサーバで無視されてもOK）
        man: parseFloat(manInput.value || 0),
        overtime: parseFloat(overtimeInput.value || 0)
      };
      edited.push(row);
      console.log('[submitEditFromModal] 既存行の収集', row);
    });

    // 2) 追加の作業者
    document.querySelectorAll('.additional-worker:checked').forEach(cb => {
      const name = cb.value;
      const key = cb.dataset.key || `modal-worker-${sanitize(name)}`;
      const manEl = document.querySelector(`input[name="${key}-man"]`);
      const otEl = document.querySelector(`input[name="${key}-overtime"]`);
      if (!manEl || !otEl) return;
      const row = {
        type: '作業者',
        name,
        man: parseFloat(manEl.value || 0),
        overtime: parseFloat(otEl.value || 0)
      };
      edited.push(row);
      console.log('[submitEditFromModal] 追加作業者', row);
    });

    // 3) 追加の協力会社
    document.querySelectorAll('.additional-partner:checked').forEach(cb => {
      const name = cb.value;          // 会社名
      const key = cb.dataset.key || `modal-partner-${sanitize(name)}`;

      const roleRows = [
        { suffix: 'general', role: 'only' },
        { suffix: 'leader', role: 'leader' },
        { suffix: 'qualified', role: 'other' }
      ];

      roleRows.forEach(({ suffix, role }) => {
        const chk = document.querySelector(`input[name="${key}-${suffix}-checked"]`);
        if (!chk || !chk.checked) return;

        const manEl = document.querySelector(`input[name="${key}-${suffix}-man"]`);
        const otEl = document.querySelector(`input[name="${key}-${suffix}-overtime"]`);
        const man = parseFloat(manEl?.value || '') || 0;
        const overtime = parseFloat(otEl?.value || '') || 0;

        const row = {
          type: '協力会社',
          name,
          role,
          man,
          overtime
        };
        edited.push(row);
        console.log('[submitEditFromModal] 追加協力会社', row);
      });
    });

    const meta = {
      date: document.getElementById('modalHistoryDate').value, // yyyy-MM-dd
      companyId: document.getElementById('company').value,
      staffId: document.getElementById('staff').value,
      siteId: document.getElementById('site').value,
    };

    // 可視化（必ずプレーンなJSONで）
    console.log('[submitEditFromModal] meta =', JSON.parse(JSON.stringify(meta))); // 送信メタ情報
    console.log('[submitEditFromModal] edited =', JSON.parse(JSON.stringify(edited))); // 編集結果一覧

    // 何も編集対象がない時のガード
    if (edited.length === 0) {
      document.getElementById('loadingOverlay').style.display = 'none';
      alert('更新対象がありません。');
      return;
    }

    const onOK = (res) => {
      console.log('[submitEditFromModal] server result:', res);
      document.getElementById('loadingOverlay').style.display = 'none';
      // 成功UI
      document.getElementById('confirmationText').textContent =
        '✅ 送信が完了しました！\n別の場所をタップしてフォームに戻ってください。';
      const buttonRow = document.querySelector('#confirmationBox .button-row');
      if (buttonRow) buttonRow.innerHTML = '<button onclick="closeConfirmation()">閉じる</button>';
      // 履歴モーダル閉じる
      try { document.getElementById('historyModal').style.display = 'none'; } catch (e) { }
      console.log('[submitEditFromModal] 終了 (成功)');
    };

    const onErr = (err) => {
      console.error('[submitEditFromModal] server error:', err);
      document.getElementById('loadingOverlay').style.display = 'none';
      alert('更新に失敗しました：' + (err && err.message ? err.message : err));
    };

    google.script.run
      .withSuccessHandler(onOK)
      .withFailureHandler(onErr)
      .updateEditedRecords(meta, edited);
    console.log('[submitEditFromModal] Google Apps Script 呼び出し完了'); // 処理終了ログ
  }




  // ------------------------------------------
  // デバッグ用：追加された協力会社の名前のサニタイズ衝突をチェック
  // ------------------------------------------

  function __debugCheckSanitizeCollision() {
    const names = Array.from(document.querySelectorAll('.additional-partner')).map(cb => cb.value);
    const seen = new Map();
    names.forEach(n => {
      const s = sanitize(n);
      if (!seen.has(s)) seen.set(s, []);
      seen.get(s).push(n);
    });
    for (const [s, arr] of seen.entries()) {
      if (arr.length > 1) {
        console.warn('[WARN] サニタイズ衝突（同じ名前で衝突してしまって出力されない）:\n', s, 'from', arr);
      }
    }
  }



  // ------------------------------------------
  // デバッグ用：追加された協力会社の状態をコンソールにダンプ
  // ------------------------------------------




  // ------------------------------------------
  // __debugDumpPartners: 追加協力会社の入力状況を出力する
  // ------------------------------------------
  function __debugDumpPartners() {
    const cbs = Array.from(document.querySelectorAll('.additional-partner'));
    console.log('[DEBUG] 追加パートナー数 =', cbs.length);

    cbs.forEach((cb, idx) => {
      const name = cb.value; // 会社名が入ってる想定
      const key = cb.dataset.key || `modal-partner-${sanitize(name)}`;
      const row = (suffix) => ({
        chk: !!document.querySelector(`input[name="${key}-${suffix}-checked"]`)?.checked,
        man: document.querySelector(`input[name="${key}-${suffix}-man"]`)?.value,
        ot: document.querySelector(`input[name="${key}-${suffix}-overtime"]`)?.value
      });

      console.log(`[DEBUG] #${idx + 1}`, {
        name,
        key,
        checked: cb.checked,
        general: row('general'),
        leader: row('leader'),
        qualified: row('qualified')
      });
    });
  }

  // ------------------------------------------
  // 入力値バリデーション：0.25単位（15分刻み）かどうかを判定
  // ------------------------------------------



  // ------------------------------------------
  // isValidQuarterHour: 0.25刻みかどうかを判定する
  // ------------------------------------------
  function isValidQuarterHour(value) {
    return Number.isFinite(value) && Math.round(value * 100) % 25 === 0;
  }


  // ------------------------------------------
  // 名前などを安全にID化するためのサニタイズ
  // ------------------------------------------



  // ------------------------------------------
  // sanitize: 名前などをIDとして安全な文字列に変換する
  // ------------------------------------------
  function sanitize(str) {
    return str.replace(/[^a-zA-Z0-9\u3040-\u30ff\u4e00-\u9faf]/g, '_');
  }



  // ------------------------------------------
  // チェックされた人（作業者/協力会社）に紐づく「人工/残業」入力欄を生成して返す
  // ------------------------------------------



  // ------------------------------------------
  // createTimeInputs: 作業者の人工・残業入力欄を生成する
  // ------------------------------------------
  function createTimeInputs(nameKey) {
    const box = document.createElement('div');
    box.className = 'time-inputs';          // ← デフォルト非表示（CSS）
    box.id = `inputs-${nameKey}`;

    const labelMap = { man: '人工', overtime: '残業' };

    ['man', 'overtime'].forEach(type => {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '0.25';
      input.inputMode = 'decimal';
      input.placeholder = labelMap[type];
      input.name = `${nameKey}-${type}`;
      input.dataset.type = type;
      input.dataset.name = nameKey;
      input.className = 'work-input';
      box.appendChild(input);
    });

    return box;
  }


  // ------------------------------------------
  // チェックボックスON/OFFに応じて、その行の「人工/残業」入力欄の表示切替
  // ------------------------------------------

  // チェックON/OFFで 役割 と 時間 を同時に制御



  // ------------------------------------------
  // toggleTimeInputs: チェック状態に応じて時間入力欄を表示制御する
  // ------------------------------------------
  function toggleTimeInputs(checkbox, nameKey) {
    const role = document.getElementById(`role-${nameKey}`);
    const inputs = document.getElementById(`inputs-${nameKey}`);
    const show = checkbox.checked;
    if (role) role.style.display = show ? 'block' : 'none';
    if (inputs) inputs.classList.toggle('show', show); // ← grid 2分割で表示
  }



  // ------------------------------------------
  // シンプルな開閉トグル（見出しクリックでセクション開閉）
  // ------------------------------------------



  // ------------------------------------------
  // toggleSection: セクション見出しの開閉を切り替える
  // ------------------------------------------
  function toggleSection(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const isShown = el.style.display === 'block';
    el.style.display = isShown ? 'none' : 'block';
  }




</script>










<style>
  /* ========= ローディング ========= */
  #loadingOverlay {
    display: none;
    position: fixed;
    z-index: 10000;
    inset: 0;
    background: rgba(255, 255, 255, .7);
    justify-content: center;
    align-items: center;
  }

  .loader {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #0066cc;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    animation: spin 1s linear infinite;
  }

  /* ========= 確認モーダル ========= */


  #confirmationText {
    margin-bottom: 1.5rem;
    white-space: pre-wrap;
  }



  /* ===== 送信完了モーダルをコンパクト表示 ===== */

  /* モーダル枠 */
  #confirmationBox {
    width: 96vw;
    /* ← 横幅を画面の96%まで */
    max-width: none;
    /* ← 固定上限を解除 */
    height: 90vh;
    /* ← 高さを画面の90%まで */
    max-height: none;
    /* ← 高さ制限を解除 */
    overflow-y: auto;
    /* ← 長い内容はスクロール */
    padding: 20px 24px;
    /* ← 余白はやや多めでもOK */
    border-radius: 12px;
    /* ← 角丸を少し残す（完全四角でも可） */
    background: #fff;
    box-shadow: 0 6px 24px rgba(0, 0, 0, .25);
  }

  /* フッターボタン（“閉じる”）は大きめを維持しつつ上下余白だけ詰める */
  #confirmationBox .button-row {
    margin-top: 14px;
  }


  /* ====== 協力会社 役割3択（大きい枠・ラジオ左） ====== */
  .role-option {
    display: flex;
    align-items: center;
    gap: 14px;
    /* ラジオと文字の間 */
    padding: 16px;
    /* 行の高さはここで揃う */
    border: 1px solid #cfcfcf;
    border-radius: 12px;
    background: #fff;
    cursor: pointer;
    user-select: none;
  }

  .role-option input[type="radio"]:checked+.text {
    color: #1976d2;
    font-weight: 700;
  }

  /* 選択中の行をハイライト（対応ブラウザ向け） */
  .role-option:has(input[type="radio"]:checked) {
    border-color: #1976d2;
    box-shadow: 0 0 0 2px rgba(25, 118, 210, .12) inset;
  }


  /* ====== 人工/残業の表示制御 ====== */
  /* デフォルトは非表示 */
  .time-inputs {
    display: none;
    margin-top: 10px;
  }

  /* JSで .show を付けた時だけ2分割で表示 */
  .time-inputs.show {
    display: grid;
    grid-template-columns: 1fr 1fr;
    /* 半々 */
    gap: 12px;
    width: 100%;
    /* 欄と欄の間隔 */
  }

  .time-inputs input {
    padding: 14px 16px;
    font-size: 2rem !important;
    text-align: center;
    height: 90px;
    border: 1px solid #ccc;
    border-radius: 10px;
    width: 100%;
    box-sizing: border-box;
  }


  .time-inputs.show .work-input {
    width: 100% !important;
    /* ← これで上書き強制 */
    flex: 1 1 auto !important;
  }

  /* ========= 作業者入力 ========= */
  .work-input-group {
    display: flex;
    gap: .5rem;
    margin-top: .5rem;
  }

  .work-label {
    padding: 1rem 2rem;
    background: #f2f2f2;
    border: 1px solid #ccc;
    border-radius: .5rem;
    font-size: 1.5rem;
    text-align: center;
    min-width: 5rem;
    user-select: none;
  }

  .work-input {
    width: 6rem;
    font-size: 2rem;
    padding: 1rem;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: .5rem;
  }

  .toggle-header {
    display: inline-block;
    font-weight: bold;
    font-size: 2.25rem;
    padding: 1rem;
    border: 2px solid #0066cc;
    color: #0066cc;
    border-radius: 10px;
    cursor: pointer;
    background: #f0f8ff;
    text-align: center;
    width: 100%;
    box-sizing: border-box;
    margin-top: 2rem;
  }

  .toggle-header:hover {
    background: #e0f0ff;
  }

  .toggle-header.inner {
    font-size: 1.4rem;
    background: #e6f2ff;
    margin-top: 1rem;
  }

  .toggle-section {
    display: none;
    padding-left: 1rem;
    margin-top: .5rem;
  }

  /* ← 左:テキスト / 右:ラジオ丸 を縦に並べる */
  .partner-role-grid {
    display: grid;
    grid-template-columns: 1fr 28px;
    /* 右列は丸の幅 */
    row-gap: 10px;
    column-gap: 12px;
    align-items: center;
  }

  .partner-role-grid .txt {
    line-height: 1.3;
  }

  .partner-role-grid input[type="radio"] {
    justify-self: center;
    width: 20px;
    height: 20px;
  }
</style>
