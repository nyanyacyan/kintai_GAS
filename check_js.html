<script>

  // ------------------------------------------
  // 編集モーダル→確認モーダル→送信の最終段階
  // 実際に updateEditedRecords(meta, edited) を呼び出す
  // ------------------------------------------
function submitEditFromModal() {
  console.log('[submitEditFromModal] start');
  document.getElementById('loadingOverlay').style.display = 'flex';

  const roleLabelMap = {
    only: '協力会社のみ',
    leader: '協力会社＋職長',
    other: '協力会社＋その他資格'
  };

  const edited = [];
lastFetchedRecords.forEach((r, i) => {
  const manInput = document.getElementById(`edit-man-${i}`);
  const overtimeInput = document.getElementById(`edit-overtime-${i}`);
  if (!manInput || !overtimeInput) return;

  let role = r.role || 'only';
  if (r.type === '協力会社') {
    const safe = sanitize(r.name);
    const sel = document.querySelector(`input[name="edit-partner-${safe}-role"]:checked`);
    role = sel ? sel.value : role;
  }

  const man = parseFloat(manInput.value || 0);
  const overtime = parseFloat(overtimeInput.value || 0);

  // ★ 修正：シートには会社名をそのまま渡す
  edited.push({
    ...r,
    name: r.name,   // ← 元の会社名を維持
    role,           // ← role を別フィールドに格納
    man,
    overtime
  });
});

  // 追加作業者
  document.querySelectorAll('.additional-worker:checked').forEach(cb => {
    const name = cb.value;
    const safe = sanitize(name);
    const inputs = document.querySelectorAll(`.worker-input[data-name="modal-worker-${safe}"]`);
    const entry = { type: '作業者', name };
    inputs.forEach(input => entry[input.dataset.type] = parseFloat(input.value || 0));
    edited.push(entry);
  });

  // 追加協力会社（役割付き）
  document.querySelectorAll('.additional-partner:checked').forEach(cb => {
    const name = cb.value;
    const safe = sanitize(name);
    const inputs = document.querySelectorAll(`.partner-input[data-name="modal-partner-${safe}"]`);
    const roleEl = document.querySelector(`input[name="role-modal-partner-${safe}"]:checked`);
    const role = roleEl ? roleEl.value : 'only';
    const entry = { type: '協力会社', name: roleLabelMap[role], role };
    inputs.forEach(input => entry[input.dataset.type] = parseFloat(input.value || 0));
    edited.push(entry);
  });

  const meta = {
    date: document.getElementById('modalHistoryDate').value,
    companyId: document.getElementById('company').value,
    staffId: document.getElementById('staff').value,
    siteId: document.getElementById('site').value,
  };

  // ここからは既に入れてある success/failure handler でOK
  google.script.run
    .withSuccessHandler(/* …省略… */)
    .withFailureHandler(/* …省略… */)
    .updateEditedRecords(meta, edited);

  console.log('[submitEditFromModal] end (request queued)');
}


  // ------------------------------------------
  // 入力値バリデーション：0.25単位（15分刻み）かどうかを判定
  // ------------------------------------------
  function isValidQuarterHour(value) {
    return Number.isFinite(value) && Math.round(value * 100) % 25 === 0;
  }


  // ------------------------------------------
  // 名前などを安全にID化するためのサニタイズ
  // ------------------------------------------
  function sanitize(str) {
    return str.replace(/[^a-zA-Z0-9\u3040-\u30ff\u4e00-\u9faf]/g, '_');
  }



  // ------------------------------------------
  // チェックされた人（作業者/協力会社）に紐づく「人工/残業」入力欄を生成して返す
  // ------------------------------------------
  function createTimeInputs(nameKey) {
    const box = document.createElement('div');
    box.className = 'time-inputs';          // ← デフォルト非表示（CSS）
    box.id = `inputs-${nameKey}`;

    const labelMap = { man: '人工', overtime: '残業' };

    ['man', 'overtime'].forEach(type => {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '0.25';
      input.inputMode = 'decimal';
      input.placeholder = labelMap[type];
      input.name = `${nameKey}-${type}`;
      input.dataset.type = type;
      input.dataset.name = nameKey;
      input.className = 'work-input';
      box.appendChild(input);
    });

    return box;
  }


  // ------------------------------------------
  // チェックボックスON/OFFに応じて、その行の「人工/残業」入力欄の表示切替
  // ------------------------------------------

  // チェックON/OFFで 役割 と 時間 を同時に制御
  function toggleTimeInputs(checkbox, nameKey) {
    const role = document.getElementById(`role-${nameKey}`);
    const inputs = document.getElementById(`inputs-${nameKey}`);
    const show = checkbox.checked;
    if (role) role.style.display = show ? 'block' : 'none';
    if (inputs) inputs.classList.toggle('show', show); // ← grid 2分割で表示
  }



  // ------------------------------------------
  // シンプルな開閉トグル（見出しクリックでセクション開閉）
  // ------------------------------------------
  function toggleSection(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const isShown = el.style.display === 'block';
    el.style.display = isShown ? 'none' : 'block';
  }




</script>
