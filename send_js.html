<script>
  /***** ========== 共通ヘルパ（完了画面/エラー画面） ========== *****/

  // 送信内容の要約HTMLを組み立て（モーダル内に表示）
  function renderSentSummaryHTML(fd) {
    console.log('[renderSentSummaryHTML] start', JSON.parse(JSON.stringify(fd || {})));
    const company = masterData.company.find(c => c.id === fd.companyId)?.name || '（未選択）';
    const staff   = masterData.staff.find(s => s.id === fd.staffId)?.name   || '（未選択）';
    const site    = masterData.site.find(s => s.id === fd.site)?.name       || '（未選択）';
    const date    = fd.date || new Date().toLocaleDateString('ja-JP');

    let html = `
      <h3 style="margin-top:0;">✅ 送信が完了しました！</h3>
      <div style="line-height:1.7">
        出面日付：${date}<br>
        元請会社：${company}<br>
        TTC担当者：${staff}<br>
        現場名：${site}
      </div>`;

    if (fd.workers?.length) {
      html += `<div style="margin-top:10px;"><strong>作業者：</strong>`;
      fd.workers.forEach(w=>{
        html += `<br>　${w.name}（人工：<span style="color:#d00;font-weight:bold;">${w.man||0}</span> 残業：<span style="color:#d00;font-weight:bold;">${w.overtime||0}h</span>）`;
      });
      html += `</div>`;
    }
    if (fd.partners?.length) {
      html += `<div style="margin-top:10px;"><strong>協力会社：</strong>`;
      fd.partners.forEach(p=>{
        html += `<br>　${p.name}（人工：<span style="color:#d00;font-weight:bold;">${p.man||0}</span> 残業：<span style="color:#d00;font-weight:bold;">${p.overtime||0}h</span>）`;
      });
      html += `</div>`;
    }

    // 写真（Drive サムネ）  ※公開設定やリンクポリシーに依存
    if (fd.photos?.length) {
      html += `<div style="margin-top:12px;">
        <strong>添付写真：</strong>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
          ${fd.photos.map(ph => `
            <a href="${ph.url}" target="_blank" rel="noopener" title="${ph.name}">
              <img src="${ph.url}" style="width:96px;height:96px;object-fit:cover;border:1px solid #ddd;border-radius:6px;">
            </a>
          `).join('')}
        </div>
      </div>`;
    }
    console.log('[renderSentSummaryHTML] end');
    return html;
  }

  // 成功画面に切り替え
  function showSendSuccessScreen(fd) {
    console.log('[showSendSuccessScreen] start');
    const modal = document.getElementById('confirmationModal');
    const text  = document.getElementById('confirmationText');
    const row   = document.querySelector('#confirmationBox .button-row');
    text.innerHTML = renderSentSummaryHTML(fd);
    row.innerHTML  = `<button onclick="closeConfirmation()">閉じる</button>`;
    modal.style.display = 'flex';
    console.log('[showSendSuccessScreen] end');
  }

  // 失敗画面に切り替え
  function showSendErrorScreen(err) {
    console.log('[showSendErrorScreen] start', err);
    const modal = document.getElementById('confirmationModal');
    const text  = document.getElementById('confirmationText');
    const row   = document.querySelector('#confirmationBox .button-row');
    text.innerHTML = `
      <h3 style="margin-top:0;color:#d00;">送信に失敗しました</h3>
      <div style="white-space:pre-wrap;color:#444;">${(err && (err.message || err)) || '不明なエラー'}</div>
    `;
    row.innerHTML = `<button onclick="closeConfirmation()">閉じる</button>`;
    modal.style.display = 'flex';
    console.log('[showSendErrorScreen] end');
  }


  /***** ========== 入力 → 確認まで ========== *****/

  // 入力値の検証と formData の組み立て、確認モーダル表示
  function submitForm() {
    console.log('[submitForm] start');

    // 既存エラー表示をクリア
    document.querySelectorAll('.error-message').forEach(div => div.textContent = '');
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

    let hasError = false;
    let firstErrorElement = null;

    // 入力要素の参照
    const companySelect   = document.getElementById('company');
    const staffSelect     = document.getElementById('staff');
    const siteSelect      = document.getElementById('site');
    const customDateToggle= document.getElementById('customDateToggle');
    const customDate      = document.getElementById('customDate');

    // 必須チェック（会社/担当/現場/日付）
    if (!companySelect.value) {
      document.getElementById('error-company').textContent = '※元請会社を選択してください。';
      companySelect.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = companySelect;
    }
    if (!staffSelect.value) {
      document.getElementById('error-staff').textContent = '※TTC担当者を選択してください。';
      staffSelect.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = staffSelect;
    }
    if (!siteSelect.value) {
      document.getElementById('error-site').textContent = '※現場名を選択してください。';
      siteSelect.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = siteSelect;
    }
    if (customDateToggle.checked && !customDate.value) {
      document.getElementById('error-date').textContent = '※出面日付を入力してください。';
      customDate.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = customDate;
    }

    const workerGroup  = document.getElementById('worker');
    const partnerGroup = document.getElementById('partner');
    let workerChecked = false;
    let partnerChecked = false;

    // formData の下地
    formData = {
      companyId: companySelect.value,
      staffId:   staffSelect.value,
      site:      siteSelect.value,
      date:      customDateToggle.checked ? customDate.value : '',
      workers:   [],
      partners:  []
    };
    console.log('[submitForm] base formData =', JSON.parse(JSON.stringify(formData)));

    // 作業者のチェック行を収集
    document.querySelectorAll("input[name='worker']:checked").forEach(cb => {
      workerChecked = true;
      const name = cb.value;
      const safeName = sanitize(name);
      const prefix = `worker-${safeName}`;
      const inputs = ['man', 'overtime'].map(type => {
        const el = document.querySelector(`input[name='${prefix}-${type}']`);
        return { el, value: parseFloat(el?.value || 0) };
      });
      let total = 0;
      let invalid = false;
      inputs.forEach(({ el, value }) => {
        total += value;
        if (value && !isValidQuarterHour(value)) {
          el.classList.add('input-error');
          invalid = true;
        }
      });
      if (total === 0 || invalid) {
        document.getElementById('error-worker').textContent = invalid
          ? '※勤務時間は0.25単位で入力してください。'
          : '※作業者の勤務時間を入力してください。';
        workerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = workerGroup;
      }
      formData.workers.push({ name, man: inputs[0].value, overtime: inputs[1].value });
    });

    // 協力会社のチェック行を収集
    document.querySelectorAll("input[name='partner']:checked").forEach(cb => {
      partnerChecked = true;
      const name = cb.value;
      const safeName = sanitize(name);
      const prefix = `partner-${safeName}`;
      const inputs = ['man', 'overtime'].map(type => {
        const el = document.querySelector(`input[name='${prefix}-${type}']`);
        return { el, value: parseFloat(el?.value || 0) };
      });

      let total = 0;
      let invalid = false;
      inputs.forEach(({ el, value }) => {
        total += value;
        if (value && !isValidQuarterHour(value)) {
          el.classList.add('input-error');
          invalid = true;
        }
      });
      if (total === 0 || invalid) {
        document.getElementById('error-partner').textContent = invalid
          ? '※勤務時間は0.25単位で入力してください。'
          : '※協力会社名の勤務時間を入力してください。';
        partnerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = partnerGroup;
      }
      formData.partners.push({ name, man: inputs[0].value, overtime: inputs[1].value });
    });

    // どちらも選ばれていない
    if (!workerChecked && !partnerChecked) {
      document.getElementById('error-worker').textContent  = '※作業者または協力会社を1件以上選択してください。';
      document.getElementById('error-partner').textContent = '※作業者または協力会社を1件以上選択してください。';
      workerGroup.classList.add('input-error');
      partnerGroup.classList.add('input-error');
      hasError = true;
      if (!firstErrorElement) firstErrorElement = workerGroup;
    }

    if (hasError) {
      console.log('[submitForm] validation error. firstErrorElement=', firstErrorElement?.id);
      if (firstErrorElement) firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      console.log('[submitForm] end (hasError)');
      return;
    }

    console.log('[submitForm] built formData =', JSON.parse(JSON.stringify(formData)));
    showConfirmation(false);
    console.log('[submitForm] end');
  }

  let isEditMode = false;

  // 確認モーダルの表示＆内容組み立て（編集時はボタンを切替）
  function showConfirmation(isEdit = false) {
    console.log('[showConfirmation] start isEdit=', isEdit);
    isEditMode = isEdit;
    const company = masterData.company.find(c => c.id === formData.companyId)?.name || '（未選択）';
    const staff   = masterData.staff.find(s => s.id === formData.staffId)?.name || '（未選択）';
    const site    = masterData.site.find(s => s.id === formData.site)?.name || '（未選択）';

    let message = `出面日付：${formData.date || new Date().toLocaleDateString('ja-JP')}<br>
元請会社：${company}<br>
TTC担当者：${staff}<br>
現場名：${site}`;

    const styleValueWithLabel = (label, value, isOvertime = false) => {
      const unit = isOvertime ? 'h' : '人工';
      const display = value && value > 0
        ? `<span style="color: red; font-weight: bold;">${value}${unit}</span>`
        : `<span style="color: #999;">0${unit}</span>`;
      return `${label}：${display}`;
    };

    if (formData.workers.length > 0) {
      message += `<br><br><strong>作業者：</strong>`;
      formData.workers.forEach(w => {
        message += `<br>　${w.name}（${styleValueWithLabel('人工', w.man)} ${styleValueWithLabel('残業', w.overtime, true)}）`;
      });
    }
    if (formData.partners.length > 0) {
      message += `<br><br><strong>協力会社：</strong>`;
      formData.partners.forEach(p => {
        message += `<br>　${p.name}（${styleValueWithLabel('人工', p.man)} ${styleValueWithLabel('残業', p.overtime, true)}）`;
      });
    }

    document.getElementById('confirmationText').innerHTML = message;
    document.getElementById('confirmationModal').style.display = 'flex';

    const buttonRow = document.querySelector('#confirmationBox .button-row');
    buttonRow.innerHTML = isEdit
      ? `
        <button type="button" onclick="submitEditFromModal()">✅ 確定して編集内容を送信</button>
        <button onclick="closeConfirmation()">← 修正する</button>
      `
      : `
        <button onclick="confirmSend()">✅ 確定して送信</button>
        <button onclick="closeConfirmation()">戻る</button>
      `;
    console.log('[showConfirmation] end');
  }


  /***** ========== 送信 ========== *****/

  // 編集送信（必要に応じて実装）
  function submitEditFromModal() {
    console.log('[submitEditFromModal] start');
    // ここで GAS の updateEditedRecords を呼び、成功時は showSendSuccessScreen(formData) を呼ぶ想定
    console.log('[submitEditFromModal] end');
  }

  // 確定送信（画像アップロード → スプレッドシート保存）
  function confirmSend() {
    console.log('[confirmSend] start');
    console.log('[confirmSend] current formData =', JSON.parse(JSON.stringify(formData)));

    // 表示用の名称を逆引き
    const companyName = masterData.company.find(c => c.id === formData.companyId)?.name || '';
    const siteObj     = masterData.site.find(s => s.id === formData.site) || {};
    const siteName    = siteObj.name || '';
    const workType    = formData.workType || siteObj.workType || '美装';
    const reportDate  = formData.date || new Date().toISOString().slice(0, 10);

    // アップロード用 meta（サーバ側は Script Properties で親フォルダを参照）
    const meta = { workType, reportDate, siteName, companyName };
    console.log('[confirmSend] meta =', meta);

    // 画像キュー
    const files = [
      ...(window.uploadQueue?.modal || []),
      ...(window.uploadQueue?.main  || [])
    ];
    console.log('[confirmSend] files.length =', files.length);

    const showLoading = () => document.getElementById('loadingOverlay')?.style?.setProperty('display', 'flex');
    const hideLoading = () => document.getElementById('loadingOverlay')?.style?.setProperty('display', 'none');

    // 保存処理
    const runSave = () => {
      console.log('[confirmSend] runSave() start');
      google.script.run
        .withSuccessHandler(res => {
          console.log('[confirmSend] saveFormResponse success', res);
          showSendSuccessScreen(formData); // ✅ 完了画面に切り替え
          console.log('[confirmSend] runSave() end(success)');
        })
        .withFailureHandler(err => {
          console.error('[confirmSend] saveFormResponse failed', err);
          showSendErrorScreen(err);
          console.log('[confirmSend] runSave() end(failed)');
        })
        .saveFormResponse(formData);
    };

    if (files.length > 0) {
      showLoading();
      console.log('[confirmSend] uploadImagesToDrive start');
      google.script.run
        .withSuccessHandler(result => {
          console.log('[confirmSend] uploadImagesToDrive success', result);
          formData.photos = result; // [{id,url,name}, ...]
          hideLoading();
          runSave();
        })
        .withFailureHandler(err => {
          console.error('[confirmSend] uploadImagesToDrive failed', err);
          hideLoading();
          showSendErrorScreen(err);
        })
        .uploadImagesToDrive(meta, files);
    } else {
      runSave();
    }

    console.log('[confirmSend] end');
  }


  /***** ========== モーダル制御 ========== *****/

  // モーダル外クリックで閉じる（編集中は履歴モーダルへ戻す）
  function handleModalClickOutside(event) {
    console.log('[handleModalClickOutside] start');
    const confirmationBox = document.getElementById('confirmationBox');
    if (!confirmationBox.contains(event.target)) {
      const confirmationText = document.getElementById('confirmationText').textContent;
      const isSent = confirmationText.includes('✅ 送信が完了しました！');
      document.getElementById('confirmationModal').style.display = 'none';
      if (isSent) {
        if (!isEditMode) resetForm();
      } else if (isEditMode) {
        document.getElementById('historyModal').style.display = 'flex';
      }
    }
    console.log('[handleModalClickOutside] end');
  }

  // 送信確認モーダルを閉じる
  function closeConfirmation() {
    console.log('[closeConfirmation] start');
    const confirmationText = document.getElementById('confirmationText').textContent;
    const isSent = confirmationText.includes('✅ 送信が完了しました！');
    document.getElementById('confirmationModal').style.display = 'none';
    if (isSent) {
      if (!isEditMode) resetForm();
    } else {
      if (isEditMode) {
        document.getElementById('historyModal').style.display = 'flex';
      }
    }
    console.log('[closeConfirmation] end, isSent=', isSent, 'isEditMode=', isEditMode);
  }

  /***** ========== ここまで ========== *****/
</script>
