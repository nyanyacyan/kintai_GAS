<script>
  /***** ========== 共通ヘルパ（完了画面/エラー画面） ========== *****/

  // 送信内容の要約HTMLを組み立て（モーダル内に表示）
  function renderSentSummaryHTML(fd) {
    console.log('[renderSentSummaryHTML] start', JSON.parse(JSON.stringify(fd || {})));
    const company = masterData.company.find(c => c.id === fd.companyId)?.name || '（未選択）';
    const staff = masterData.staff.find(s => s.id === fd.staffId)?.name || '（未選択）';
    const site = masterData.site.find(s => s.id === fd.site)?.name || '（未選択）';
    const date = fd.date || new Date().toLocaleDateString('ja-JP');

    let html = `
      <div class="sent-summary">
        <h3 class="sent-title">✅ 送信が完了しました！</h3>
    `;

    if (fd.workers?.length) {
      const rows = fd.workers.map(w =>
        `<li>${w.name}（人工：<b class="sent-num">${w.man || 0}</b> / 残業：<b class="sent-num">${w.overtime || 0}</b>h）</li>`
      ).join('');
      html += `<div class="sent-block"><div class="sent-block-title">作業者</div><ul class="sent-list">${rows}</ul></div>`;
    }

    if (fd.partners?.length) {
      const rows = fd.partners.map(p =>
        `<li>${p.name}（人工：<b class="sent-num">${p.man || 0}</b> / 残業：<b class="sent-num">${p.overtime || 0}</b>h）</li>`
      ).join('');
      html += `<div class="sent-block"><div class="sent-block-title">協力会社</div><ul class="sent-list">${rows}</ul></div>`;
    }

    // ✅ Driveのサムネイルを使って軽量表示（クリックで原寸URLへ）
    if (fd.photos?.length) {
      const imgs = fd.photos.map(ph => {
        const thumb = "https://drive.google.com/thumbnail?id=" + ph.id + "&sz=w200";
        const href = ph.url || ("https://drive.google.com/uc?id=" + ph.id);
        return `
          <a class="sent-thumb" href="${href}" target="_blank" rel="noopener" title="${ph.name || ''}">
            <img src="${thumb}" alt="${ph.name || ''}">
          </a>`;
      }).join('');
      html += `<div class="sent-block">
        <div class="sent-block-title">添付写真</div>
        <div class="sent-thumbs">${imgs}</div>
      </div>`;
    }

    html += `</div>`;
    console.log('[renderSentSummaryHTML] end');
    return html;
  }

  // 成功画面に切り替え
  function showSendSuccessScreen(fd) {
    console.log('[showSendSuccessScreen] start');
    const modal = document.getElementById('confirmationModal');
    const box = document.getElementById('confirmationBox');
    const text = document.getElementById('confirmationText');
    const row = document.querySelector('#confirmationBox .button-row');
    // ✅ 成功時だけ専用クラスを追加
    modal.classList.add('modal--success');

    text.innerHTML = renderSentSummaryHTML(fd);
    row.innerHTML = `<button onclick="closeConfirmation()">閉じる</button>`;
    modal.style.display = 'flex';

    // コンパクト表示をON
    box.classList.add('compact');

    console.log('[showSendSuccessScreen] end');
  }




  // 失敗画面に切り替え
  function showSendErrorScreen(err) {
    console.log('[showSendErrorScreen] start', err);
    const modal = document.getElementById('confirmationModal');
    const text = document.getElementById('confirmationText');
    const row = document.querySelector('#confirmationBox .button-row');
    text.innerHTML = `
      <h3 style="margin-top:0;color:#d00;">送信に失敗しました</h3>
      <div style="white-space:pre-wrap;color:#444;">${(err && (err.message || err)) || '不明なエラー'}</div>
    `;
    row.innerHTML = `<button onclick="closeConfirmation()">閉じる</button>`;
    modal.style.display = 'flex';
    console.log('[showSendErrorScreen] end');
  }


  /***** ========== 入力 → 確認まで ========== *****/

  // 入力値の検証と formData の組み立て、確認モーダル表示
  // 入力値の検証と formData の組み立て、確認モーダル表示
  function submitForm() {
    console.log('[submitForm] start');

    // --- 既存エラー表示のリセット ---
    document.querySelectorAll('.error-message').forEach(div => div.textContent = '');
    document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

    let hasError = false;
    let firstErrorElement = null;

    // --- 入力要素参照 ---
    const companySelect = document.getElementById('company');
    const staffSelect = document.getElementById('staff');
    const siteSelect = document.getElementById('site');
    const customDateToggle = document.getElementById('customDateToggle');
    const customDate = document.getElementById('customDate');

    const workerGroup = document.getElementById('worker');
    const partnerGroup = document.getElementById('partner');

    // --- 必須チェック ---
    if (!companySelect.value) {
      document.getElementById('error-company').textContent = '※元請会社を選択してください。';
      companySelect.classList.add('input-error'); hasError = true;
      if (!firstErrorElement) firstErrorElement = companySelect;
    }
    if (!staffSelect.value) {
      document.getElementById('error-staff').textContent = '※TTC担当者を選択してください。';
      staffSelect.classList.add('input-error'); hasError = true;
      if (!firstErrorElement) firstErrorElement = staffSelect;
    }
    if (!siteSelect.value) {
      document.getElementById('error-site').textContent = '※現場名を選択してください。';
      siteSelect.classList.add('input-error'); hasError = true;
      if (!firstErrorElement) firstErrorElement = siteSelect;
    }
    if (customDateToggle.checked && !customDate.value) {
      document.getElementById('error-date').textContent = '※出面日付を入力してください。';
      customDate.classList.add('input-error'); hasError = true;
      if (!firstErrorElement) firstErrorElement = customDate;
    }

    // --- formData の下地 ---
    formData = {
      companyId: companySelect.value,
      staffId: staffSelect.value,
      site: siteSelect.value,
      date: customDateToggle.checked ? customDate.value : '',
      workers: [],
      partners: []  // ← 協力会社はマトリクスで複数行（会社名＋役割×3）になり得る
    };
    console.log('[submitForm] base formData =', JSON.parse(JSON.stringify(formData)));

    // 選択チェックの有無
    let workerChecked = false;
    let partnerChecked = false;

    // =========================================================
    // 作業者（単一の人工／残業）収集
    // =========================================================
    document.querySelectorAll("input[name='worker']:checked").forEach(cb => {
      workerChecked = true;
      const name = cb.value;
      const safe = sanitize(name);
      const prefix = `worker-${safe}`;

      // 入力値取得
      const inputs = ['man', 'overtime'].map(type => {
        const el = document.querySelector(`input[name='${prefix}-${type}']`);
        return { el, value: parseFloat(el?.value || 0) };
      });

      // 検証
      let total = 0;
      let invalid = false;
      inputs.forEach(({ el, value }) => {
        total += value;
        if (value && !isValidQuarterHour(value)) {
          el?.classList.add('input-error');
          invalid = true;
        }
      });

      if (total === 0 || invalid) {
        document.getElementById('error-worker').textContent =
          invalid ? '※勤務時間は0.25単位で入力してください。'
            : '※作業者の勤務時間を入力してください。';
        workerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = workerGroup;
        console.warn('[worker] invalid or zero total', { name, inputs });
        return;
      }

      formData.workers.push({ name, man: inputs[0].value, overtime: inputs[1].value });
    });

    // =========================================================
    // 協力会社（マトリクス収集）
    //   会社チェックON → 3役割（一般/職長/有資格者）の
    //   個別チェック＋人工/残業を複数行として formData.partners に追加
    // =========================================================
    document.querySelectorAll(`input[name="partner"]:checked`).forEach(cb => {
      partnerChecked = true;

      const companyName = cb.value;            // 保存は会社名そのまま
      const safe = sanitize(companyName);
      const key = `partner-${safe}`;
      const matrix = document.getElementById(`matrix-${key}`);

      console.log('[partner] company=', companyName, 'key=', key, 'hasMatrix=', !!matrix);
      if (!matrix) {
        console.warn('[partner] matrix not found', key);
        return;
      }

      // UIロール → サーバ内部ロール
      const roleMap = {
        general: 'only',    // 一般作業員
        leader: 'leader',  // 職長
        qualified: 'other'    // 有資格者
      };

      const roles = ['general', 'leader', 'qualified'];
      let anyRoleChecked = false;
      const debugItems = [];

      roles.forEach(uiRole => {
        const chk = matrix.querySelector(`input[name="${key}-${uiRole}-checked"]`);
        if (!chk || !chk.checked) return;

        anyRoleChecked = true;

        const manEl = matrix.querySelector(`input[name="${key}-${uiRole}-man"]`);
        const otEl = matrix.querySelector(`input[name="${key}-${uiRole}-overtime"]`);
        const man = parseFloat(manEl?.value || 0);
        const ot = parseFloat(otEl?.value || 0);

        // 0.25刻み検証
        let invalid = false;
        [manEl, otEl].forEach(el => {
          const v = parseFloat(el?.value || 0);
          if (el?.value && !isValidQuarterHour(v)) {
            el.classList.add('input-error');
            invalid = true;
          }
        });

        if (man + ot <= 0 || invalid) {
          document.getElementById('error-partner').textContent =
            invalid ? '※勤務時間は0.25単位で入力してください。'
              : '※協力会社の勤務時間を入力してください。';
          partnerGroup.classList.add('input-error');
          hasError = true;
          if (!firstErrorElement) firstErrorElement = matrix || partnerGroup;
          console.warn('[partner] invalid values', { companyName, uiRole, man, ot });
          return;
        }

        const role = roleMap[uiRole]; // 'only'|'leader'|'other'
        formData.partners.push({
          name: companyName,  // 会社名そのまま（サーバ側で必要に応じて表示名に役割サフィックスを付与）
          role,
          man,
          overtime: ot
        });
        debugItems.push({ uiRole, role, man, ot });
      });

      if (!anyRoleChecked) {
        document.getElementById('error-partner').textContent = '※協力会社の役割を1つ以上選択してください。';
        partnerGroup.classList.add('input-error');
        hasError = true;
        if (!firstErrorElement) firstErrorElement = matrix || partnerGroup;
        console.warn('[partner] no role selected', companyName);
      } else {
        console.log('[partner] appended items =', debugItems);
      }
    });

    console.log('[submitForm] collected workers =', JSON.parse(JSON.stringify(formData.workers)));
    console.log('[submitForm] collected partners =', JSON.parse(JSON.stringify(formData.partners)));

    // --- どちらも無選択の最終ガード ---
    if (!workerChecked && !partnerChecked) {
      document.getElementById('error-worker').textContent = '※作業者または協力会社を1件以上選択してください。';
      document.getElementById('error-partner').textContent = '※作業者または協力会社を1件以上選択してください。';
      workerGroup.classList.add('input-error');
      partnerGroup.classList.add('input-error');
      if (!firstErrorElement) firstErrorElement = workerGroup;
      hasError = true;
    }

    if (hasError) {
      console.warn('[submitForm] validation error. firstErrorElement=', firstErrorElement?.id);
      firstErrorElement?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }

    // --- 確認モーダルを表示 ---
    showConfirmation(false);
    console.log('[submitForm] end');
  }


function showConfirmation(isEdit = false) {
  console.log('[showConfirmation] start isEdit=', isEdit);

  // ← ここでローカルに定義（これで必ず見える）
  const styleValueWithLabel = (label, value, isOvertime = false) => {
    const unit = isOvertime ? 'h' : '人工';
    const v = Number(value) || 0;
    const display = v > 0
      ? `<span style="color:#d33;font-weight:700;">${v}${unit}</span>`
      : `<span style="color:#999;">0${unit}</span>`;
    return `${label}：${display}`;
  };

  const roleSuffix = {
    only:   '',         // 一般作業員 → サフィックスなし
    leader: ' 職長',
    other:  ' 有資格者'
  };

  const box = document.getElementById('confirmationBox');
  box.classList.remove('compact');
  isEditMode = isEdit;

  const company = masterData.company.find(c => c.id === formData.companyId)?.name || '（未選択）';
  const staff   = masterData.staff.find(s => s.id === formData.staffId)?.name   || '（未選択）';
  const site    = masterData.site.find(s => s.id === formData.site)?.name       || '（未選択）';

  let message = `出面日付：${formData.date || new Date().toLocaleDateString('ja-JP')}<br>
元請会社：${company}<br>
TTC担当者：${staff}<br>
現場名：${site}`;

  if (formData.workers?.length) {
    message += `<br><br><strong>作業者：</strong>`;
    formData.workers.forEach(w => {
      message += `<br>　${w.name}（${styleValueWithLabel('人工', w.man)} ${styleValueWithLabel('残業', w.overtime, true)}）`;
    });
  }

  if (formData.partners?.length) {
    message += `<br><br><strong>協力会社：</strong>`;
    formData.partners.forEach(p => {
      const displayName = `${p.name}${roleSuffix[p.role] ?? ''}`;
      message += `<br>　${displayName}（${styleValueWithLabel('人工', p.man)} ${styleValueWithLabel('残業', p.overtime, true)}）`;
    });
  }

  document.getElementById('confirmationText').innerHTML = message;
  document.getElementById('confirmationModal').style.display = 'flex';

  const buttonRow = document.querySelector('#confirmationBox .button-row');
  buttonRow.innerHTML = isEdit
    ? `
      <button type="button" onclick="submitEditFromModal()">✅ 確定して編集内容を送信</button>
      <button onclick="closeConfirmation()">← 修正する</button>
    `
    : `
      <button onclick="confirmSend()">✅ 確定して送信</button>
      <button onclick="closeConfirmation()">戻る</button>
    `;

  console.log('[showConfirmation] end');
}

  /***** ========== 送信 ========== *****/

  // 確定送信（画像アップロード → スプレッドシート保存）
  // function confirmSend() {
  //   console.log('[confirmSend] start');
  //   console.log('[confirmSend] current formData =', JSON.parse(JSON.stringify(formData)));

  //   // 表示用の名称を逆引き
  //   const companyName = masterData.company.find(c => c.id === formData.companyId)?.name || '';
  //   const siteObj = masterData.site.find(s => s.id === formData.site) || {};
  //   const siteName = siteObj.name || '';
  //   const workType = formData.workType || siteObj.workType || '美装';
  //   const reportDate = formData.date || new Date().toISOString().slice(0, 10);

  //   // アップロード用 meta（サーバ側は Script Properties で親フォルダを参照）
  //   const meta = { workType, reportDate, siteName, companyName };
  //   console.log('[confirmSend] meta =', meta);

  //   // 画像キュー
  //   const files = [
  //     ...(window.uploadQueue?.modal || []),
  //     ...(window.uploadQueue?.main || [])
  //   ];
  //   console.log('[confirmSend] files.length =', files.length);

  //   const showLoading = () => document.getElementById('loadingOverlay')?.style?.setProperty('display', 'flex');
  //   const hideLoading = () => document.getElementById('loadingOverlay')?.style?.setProperty('display', 'none');

  //   // 保存処理
  //   const runSave = () => {
  //     console.log('[confirmSend] runSave() start');
  //     google.script.run
  //       .withSuccessHandler(res => {
  //         console.log('[confirmSend] saveFormResponse success', res);
  //         showSendSuccessScreen(formData); // ✅ 完了画面に切り替え
  //         console.log('[confirmSend] runSave() end(success)');
  //       })
  //       .withFailureHandler(err => {
  //         console.error('[confirmSend] saveFormResponse failed', err);
  //         showSendErrorScreen(err);
  //         console.log('[confirmSend] runSave() end(failed)');
  //       })
  //       .saveFormResponse(formData);
  //   };

  //   if (files.length > 0) {
  //     showLoading();
  //     console.log('[confirmSend] uploadImagesToDrive start');
  //     google.script.run
  //       .withSuccessHandler(result => {
  //         console.log('[confirmSend] uploadImagesToDrive success', result);
  //         formData.photos = result; // [{id,url,name}, ...]
  //         hideLoading();
  //         runSave();
  //       })
  //       .withFailureHandler(err => {
  //         console.error('[confirmSend] uploadImagesToDrive failed', err);
  //         hideLoading();
  //         showSendErrorScreen(err);
  //       })
  //       .uploadImagesToDrive(meta, files);
  //   } else {
  //     runSave();
  //   }

  //   console.log('[confirmSend] end');
  // }


  /***** ========== モーダル制御 ========== *****/

  // モーダル外クリックで閉じる（編集中は履歴モーダルへ戻す）
  function handleModalClickOutside(event) {
    console.log('[handleModalClickOutside] start');
    const confirmationBox = document.getElementById('confirmationBox');
    if (!confirmationBox.contains(event.target)) {
      const confirmationText = document.getElementById('confirmationText').textContent;
      const isSent = confirmationText.includes('✅ 送信が完了しました！');
      document.getElementById('confirmationModal').style.display = 'none';
      if (isSent) {
        if (!isEditMode) resetForm();
      } else if (isEditMode) {
        document.getElementById('historyModal').style.display = 'flex';
      }
    }
    console.log('[handleModalClickOutside] end');
  }

  // 送信確認モーダルを閉じる
  function closeConfirmation() {
    console.log('[closeConfirmation] start');
    const confirmationText = document.getElementById('confirmationText').textContent;
    const isSent = confirmationText.includes('✅ 送信が完了しました！');
    document.getElementById('confirmationModal').style.display = 'none';
    if (isSent) {
      if (!isEditMode) resetForm();
    } else {
      if (isEditMode) {
        document.getElementById('historyModal').style.display = 'flex';
      }
    }
    console.log('[closeConfirmation] end, isSent=', isSent, 'isEditMode=', isEditMode);
  }
  console.log('[send_js] exporting handlers to window');
  window.submitForm = submitForm;
  window.showConfirmation = showConfirmation;
  window.confirmSend = confirmSend;
  window.submitEditFromModal = submitEditFromModal;
  window.closeConfirmation = closeConfirmation;
  window.handleModalClickOutside = handleModalClickOutside;
  console.log('[send_js] exports done');
  /***** ========== ここまで ========== *****/
</script>
